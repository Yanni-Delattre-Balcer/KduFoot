<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football KduFoot Pro</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d6efd',
                        secondary: '#2c3e50',
                        bg: '#f0f2f5',
                        accent: '#00d26a',
                        gold: '#ffc107',
                        tech: '#3b82f6',
                        phys: '#f97316',
                        tac: '#8b5cf6'
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @keyframes bounce-short {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        .animate-bounce-short {
            animation: bounce-short 0.5s ease-in-out;
        }

        @keyframes pulse-custom {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-pulse-custom {
            animation: pulse-custom 2s infinite;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
        }

        /* Tactical SVG Schema - Professional Vector Rendering */
        .tactical-svg-container {
            margin: 1.5rem auto;
            max-width: 100%;
            width: 100%;
            display: flex;
            justify-content: center;
            background: #2d5a27;
            /* Deep Pitch Green */
            padding: 1rem;
            border-radius: 12px;
            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.2), 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 4px solid #ffffff20;
            overflow: hidden;
            animation: schemaEntrance 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .tactical-svg-container svg {
            max-width: 100%;
            height: auto;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
            border-radius: 4px;
        }

        /* Tactical Schema Styling - Grid System Optimized (Black & No Bold) */
        .tactical-schema {
            font-family: 'Roboto Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            /* Robust stack */
            background: rgba(0, 0, 0, 0.04);
            color: #000000;
            /* FORCE BLACK */
            padding: 1.5rem;
            border-radius: 10px;
            border: 2px dashed rgba(0, 0, 0, 0.1);
            white-space: pre;
            /* Strict preservation of whitespace for grid alignment */
            overflow-x: auto;
            /* Allow scrolling for wide landscape schemas */
            line-height: 1.4;
            /* Standard code line height for better ascii art alignment */
            font-size: 14px;
            /* Crisp size for technical drawing */
            margin: 1.5rem auto;
            /* CENTER ALIGNMENT */
            position: relative;
            animation: schemaEntrance 0.5s ease-out;
            letter-spacing: 0px;
            font-weight: normal;
            /* NO BOLD for perfect alignment */
            width: fit-content;
            /* Only take necessary width */
            max-width: 100%;
            /* Prevent overflow */
            display: block;
            /* Ensure margin: auto works */
            tab-size: 4;
            /* Handle tabs correctly if present */
        }

        .tactical-schema b {
            color: inherit;
            font-weight: 900;
        }

        .tactical-schema .player-x {
            color: #dc2626;
            font-weight: 900;
        }

        /* Strong Red */
        .tactical-schema .player-o {
            color: #2563eb;
            font-weight: 900;
        }

        /* Strong Blue */
        .tactical-schema .ball {
            color: #ca8a04;
            font-weight: 900;
        }

        /* Darker Yellow/Gold */

        .tactical-schema::before {
            content: "SCH√âMA TACTIQUE";
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 9px;
            font-weight: 900;
            opacity: 0.5;
            letter-spacing: 2px;
        }

        @keyframes schemaEntrance {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .tactical-schema b {
            color: #fff;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .tactical-schema .player-x {
            color: #ff5555;
            font-weight: bold;
        }

        .tactical-schema .player-o {
            color: #55aaff;
            font-weight: bold;
        }

        .tactical-schema .ball {
            color: #ffff00;
            animation: pulseBall 2s infinite;
        }

        @keyframes animate-fade-in {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: animate-fade-in 0.3s ease-out forwards;
        }

        @keyframes pulseBall {
            0% {
                transform: scale(1);
                text-shadow: 0 0 0px #ffff00;
            }

            50% {
                transform: scale(1.2);
                text-shadow: 0 0 8px #ffff00;
            }

            100% {
                transform: scale(1);
                text-shadow: 0 0 0px #ffff00;
            }
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background-color: transparent;
        }

        /* Fix navbar hover */
        .nav-link:hover {
            color: #0d6efd !important;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .modal-super-wide {
            max-width: 95% !important;
        }

        .card-custom {
            border: none;
            border-radius: 16px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.2);
        }

        .card-img-wrapper {
            position: relative;
            height: 180px;
            overflow: hidden;
        }

        .card-img-top {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .card-img-wrapper:hover .card-img-top {
            transform: scale(1.05);
        }

        .card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.97) 0%, rgba(15, 23, 42, 0.99) 100%);
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            z-index: 20;
            padding: 24px;
        }

        .card-img-wrapper:hover .card-overlay {
            opacity: 1;
        }

        .overlay-content {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 16px;
            padding-right: 8px;
        }

        .overlay-content::-webkit-scrollbar {
            width: 6px;
        }

        .overlay-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .overlay-content::-webkit-scrollbar-thumb {
            background: rgba(0, 210, 106, 0.6);
            border-radius: 10px;
        }

        .overlay-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 210, 106, 0.8);
        }

        /* Am√©lioration lisibilit√© - textes plus grands */
        .info-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e2e8f0;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-icon {
            width: 32px;
            min-width: 32px;
            text-align: center;
            margin-right: 12px;
            font-size: 16px;
        }

        .info-content {
            flex: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .theme-badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 800;
            padding: 6px 10px;
            border-radius: 6px;
            text-transform: uppercase;
            border: 1.5px solid;
            margin: 2px;
        }
    </style>
</head>

<body class="bg-bg text-gray-800 font-sans pb-32">

    <!-- Donnees Feature Flags pour JS (Fix linting) -->
    <div id="featureFlags" class="hidden"
        data-show-ai="{{ 'true' if features.show_ai_analysis or dev_mode else 'false' }}"
        data-show-library="{{ 'true' if features.show_library or dev_mode else 'false' }}"
        data-show-favorites="{{ 'true' if features.show_favorites or dev_mode else 'false' }}"
        data-show-training="{{ 'true' if features.show_training or dev_mode else 'false' }}">
    </div>



    <nav class="navbar navbar-expand bg-white sticky-top shadow-sm py-3"
        style="z-index: 1100; position: sticky; top: 0;">
        <div class="container-fluid px-4 position-relative d-flex align-items-center justify-content-between">
            <!-- LEFT: Logo -->
            <div class="d-flex align-items-center" style="z-index: 10;">
                <a class="navbar-brand d-flex align-items-center cursor-pointer m-0" onclick="showView('library')"
                    style="font-size: 1.6rem; font-weight: 900; letter-spacing: -0.05em; font-family: 'Roboto Mono', monospace;">
                    <span class="bg-black text-white rounded px-2"
                        style="transform: rotate(-3deg); margin-right: -2px;">K</span>du<span
                        class="text-primary">Foot</span>
                </a>
            </div>

            <!-- CENTER: Menu (Absolute Centering for perfect alignment) -->
            <div class="position-absolute start-50 translate-middle-x d-none d-lg-block">
                <ul class="navbar-nav d-flex flex-row align-items-center" style="gap: 2rem;">
                    <li class="nav-item">
                        <a class="nav-link cursor-pointer fw-bold text-primary border-bottom border-2 border-primary d-flex align-items-center gap-2 text-nowrap"
                            id="navLib" onclick="showView('library')" style="padding-bottom: 0.25rem;">
                            <i class="fas fa-video"></i> Mes Analyses
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link cursor-pointer fw-semibold text-secondary d-flex align-items-center gap-2 text-nowrap"
                            id="navFav" onclick="showView('favorites')"
                            style="transition: color 0.3s; padding-bottom: 0.25rem;">
                            <i class="fas fa-star text-warning"></i> Favoris
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link cursor-pointer fw-semibold text-secondary d-flex align-items-center gap-2 text-nowrap"
                            id="navMatch" onclick="showView('match')"
                            style="transition: color 0.3s; padding-bottom: 0.25rem;">
                            <i class="fas fa-search text-success"></i> Trouver mon match
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link cursor-pointer fw-semibold text-secondary d-flex align-items-center gap-2 text-nowrap"
                            id="navTrain" onclick="showView('training')"
                            style="transition: color 0.3s; padding-bottom: 0.25rem;">
                            <i class="fas fa-dumbbell text-danger"></i> Mon Entra√Ænement
                            <span class="badge bg-danger rounded-pill ms-1" id="navCount"
                                style="font-size: 0.7rem;">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link cursor-pointer fw-semibold text-secondary d-flex align-items-center gap-2 text-nowrap"
                            id="navHist" onclick="showView('history')"
                            style="transition: color 0.3s; padding-bottom: 0.25rem;">
                            <i class="fas fa-history text-secondary"></i> Historique
                        </a>
                    </li>
                </ul>
            </div>

            <!-- RIGHT: Auth / User Area -->
            <div class="d-flex align-items-center gap-3" style="z-index: 10;">
                <!-- Guest State -->
                <div id="authGuestArea" class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-bold border-2"
                        onclick="openLoginModal()" style="font-size: 0.85rem;">
                        Connexion
                    </button>
                    <button class="btn btn-primary btn-sm rounded-pill px-3 fw-bold" onclick="openRegisterModal()"
                        style="font-size: 0.85rem;">
                        Inscription
                    </button>
                </div>

                <!-- User State -->
                <div id="authUserArea" class="hidden items-center gap-3">
                    <span class="text-sm font-bold text-secondary" id="userName">Coach</span>
                    <button
                        class="text-sm font-bold text-red-500 hover:text-red-600 transition p-1 flex items-center gap-1"
                        onclick="handleLogout()" title="D√©connexion">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>D√©connexion</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="libraryView">
        {% if not (features.show_library or dev_mode) %}
        <div class="max-w-4xl mx-auto px-4 py-20 text-center">
            <div class="bg-white rounded-[40px] shadow-2xl p-12 border border-gray-100">
                <div
                    class="w-24 h-24 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-8 animate-bounce">
                    <i class="fas fa-video"></i>
                </div>
                <h2 class="text-4xl font-black text-gray-800 mb-4 uppercase tracking-tight">Mes Analyses Vid√©os</h2>
                <p class="text-xl text-blue-600 font-bold mb-8 italic">"Analysez vos vid√©os d'entra√Ænement avec l'IA
                    pour extraire automatiquement les exercices, les sch√©mas tactiques et les consignes."</p>
                <div
                    class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-2xl text-left inline-block mx-auto mb-6">
                    <p class="text-gray-700 font-semibold mb-0">üöÄ Actuellement en cours de d√©veloppement technique.</p>
                </div>
                <p class="text-gray-400 text-sm">Pr√©vu pour la version 2.0. Cette fonctionnalit√© vous permettra de
                    transformer n'importe quelle vid√©o YouTube, TikTok ou Instagram en une fiche
                    d'exercice compl√®te et
                    √©ditable.</p>
            </div>
        </div>
        {% else %}
        <div
            class="bg-gradient-to-br from-[#1e3c72] to-[#2a5298] text-white py-12 rounded-b-[40px] shadow-xl text-center mb-10 relative overflow-hidden">
            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
            </div>
            <div class="max-w-4xl mx-auto px-4 relative z-10">
                <h1 class="text-3xl md:text-5xl font-extrabold mb-4 tracking-tight">
                    <span
                        style="font-family: 'Roboto Mono'; display: inline-flex; align-items: center; vertical-align: middle;">
                        <span class="bg-black text-white rounded px-2"
                            style="transform: rotate(-3deg); margin-right: -2px;">K</span>du<span
                            class="text-primary">Foot</span>
                    </span> : L'IA de ton coaching
                </h1>
                <p class="text-blue-100 mb-8 opacity-90 font-light">Analyse vid√©o haute performance, d√©tection
                    d'exercices
                    et cr√©ation de
                    s√©ances en un clic.</p>

                <div
                    class="bg-white/10 backdrop-blur-md p-2 rounded-full border border-white/20 flex gap-2 max-w-2xl mx-auto shadow-2xl">
                    <div class="pl-4 flex items-center text-white/60"><i id="platformIcon"
                            class="fas fa-link text-xl"></i></div>
                    <input type="text" id="videoUrl"
                        class="bg-transparent border-none text-white w-full text-base px-2 focus:outline-none placeholder-white/50"
                        placeholder="Lien YouTube, TikTok, Insta..." oninput="updatePlatformIcon(this)"
                        onkeypress="if(event.key === 'Enter') addVideo()">
                    <button onclick="addVideo()" id="addBtn"
                        class="bg-white text-primary px-6 py-3 rounded-full font-bold hover:bg-gray-100 transition whitespace-nowrap shadow-lg flex items-center">
                        <span id="btnText">ANALYSER</span>
                        <span id="loader" class="hidden ml-2 animate-spin"><i class="fas fa-circle-notch"></i></span>
                    </button>
                </div>

                <div id="progressContainer"
                    class="max-w-2xl mx-auto mt-6 bg-black/30 rounded-full h-1.5 overflow-hidden hidden">
                    <div id="progressBar"
                        class="h-full bg-accent w-0 transition-all duration-300 shadow-[0_0_10px_#00d26a]"></div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="font-bold text-gray-700 flex items-center"><i
                            class="fas fa-sliders-h mr-2 text-primary"></i>Filtres Intelligents</h5>
                    <button
                        onclick="activeKeywords=[]; activeThemes=[]; document.getElementById('filterSearch').value=''; applyFilters(); renderTags();"
                        class="text-xs text-gray-400 hover:text-red-500 underline">R√©initialiser</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="filterSearch"
                            class="w-full bg-gray-50 border border-gray-200 text-gray-700 py-2 pl-10 pr-4 rounded-lg focus:outline-none focus:border-primary transition"
                            placeholder="Mot-cl√© (ex: Frappe)..." onkeypress="if(event.key === 'Enter') addSearchTag()">
                    </div>

                    <select id="filterLevel"
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg py-2 px-3 focus:border-primary focus:outline-none text-gray-600"
                        onchange="applyFilters()">
                        <option value="Tous" selected>Niveau : Tous</option>
                        <option value="D√©butant">D√©butant / √âcole de Foot</option>
                        <option value="Ligue">Ligue / R√©gional</option>
                        <option value="National">National / Elite</option>
                    </select>

                    <div id="dynamicThemeFilters" class="flex flex-wrap gap-2 items-center">
                        <!-- Th√®mes de base -->
                        <label class="cursor-pointer theme-filter-label">
                            <input type="checkbox" value="TECHNIQUE" onchange="toggleThemeFilter(this)" class="mr-1">
                            <span class="text-xs font-bold text-blue-600">TECHNIQUE</span>
                        </label>
                        <label class="cursor-pointer theme-filter-label">
                            <input type="checkbox" value="PHYSIQUE" onchange="toggleThemeFilter(this)" class="mr-1">
                            <span class="text-xs font-bold text-orange-600">PHYSIQUE</span>
                        </label>
                        <label class="cursor-pointer theme-filter-label">
                            <input type="checkbox" value="TACTIQUE" onchange="toggleThemeFilter(this)" class="mr-1">
                            <span class="text-xs font-bold text-purple-600">TACTIQUE</span>
                        </label>
                        <label class="cursor-pointer theme-filter-label">
                            <input type="checkbox" value="FINITION" onchange="toggleThemeFilter(this)" class="mr-1">
                            <span class="text-xs font-bold text-green-600">FINITION</span>
                        </label>
                        <!-- Les nouveaux th√®mes seront ajout√©s ici dynamiquement -->
                    </div>
                </div>

                <div id="activeTagsArea" class="flex flex-wrap gap-2 items-center min-h-[38px]">
                    <span class="text-gray-300 text-xs italic">Aucun filtre actif</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-20" id="videoGrid">
            </div>
        </div>
        {% endif %}
    </div>

    <div id="favoritesView" class="max-w-7xl mx-auto px-4 py-10 hidden">
        {% if not (features.show_favorites or dev_mode) %}
        <div class="max-w-4xl mx-auto py-20 text-center">
            <div class="bg-white rounded-[40px] shadow-2xl p-12 border border-gray-100">
                <div
                    class="w-24 h-24 bg-amber-100 text-amber-600 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-8">
                    <i class="fas fa-star"></i>
                </div>
                <h2 class="text-4xl font-black text-gray-800 mb-4 uppercase tracking-tight">Mes Favoris</h2>
                <p class="text-xl text-amber-600 font-bold mb-8 italic">"Gardez vos exercices pr√©f√©r√©s √† port√©e de main
                    pour vos prochaines s√©ances."</p>
                <div
                    class="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-r-2xl text-left inline-block mx-auto mb-6">
                    <p class="text-gray-700 font-semibold mb-0">üöß Fonctionnalit√© en cours de d√©ploiement.</p>
                </div>
                <p class="text-gray-400 text-sm">Cr√©ez votre propre biblioth√®que personnalis√©e en sauvegardant les
                    meilleurs exercices trouv√©s via la communaut√© ou vos propres analyses.</p>
            </div>
        </div>
        {% else %}
        <h2 class="text-2xl font-bold mb-8 text-gold flex items-center"><i class="fas fa-star mr-3"></i>Mes Favoris</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="favoritesGrid"></div>
        <div id="noFavMsg" class="text-center py-20 text-gray-400 hidden">Aucun favori pour l'instant.</div>
        {% endif %}
    </div>

    <div id="trainingView" class="max-w-7xl mx-auto px-4 py-10 hidden">
        {% if not (features.show_training or dev_mode) %}
        <div class="max-w-4xl mx-auto py-20 text-center">
            <div class="bg-white rounded-[40px] shadow-2xl p-12 border border-gray-100">
                <div
                    class="w-24 h-24 bg-red-100 text-red-600 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-8">
                    <i class="fas fa-dumbbell"></i>
                </div>
                <h2 class="text-4xl font-black text-gray-800 mb-4 uppercase tracking-tight">Mon Entra√Ænement</h2>
                <p class="text-xl text-red-600 font-bold mb-8 italic">"G√©n√©rez et adaptez vos s√©ances d'entra√Ænement
                    compl√®tes en quelques clics."</p>
                <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-2xl text-left inline-block mx-auto mb-6">
                    <p class="text-gray-700 font-semibold mb-0">‚è≥ Arriv√©e imminente !</p>
                </div>
                <p class="text-gray-400 text-sm">Pr√©parez vos s√©ances en combinant plusieurs exercices. L'IA adapte
                    automatiquement la s√©ance en fonction de votre effectif, du mat√©riel et de l'espace disponible.</p>
            </div>
        </div>
        {% else %}
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 flex items-center"><i
                        class="fas fa-clipboard-list mr-3 text-primary"></i>Ma S√©ance</h2>
                <p class="text-gray-500 mt-1 text-sm">Dur√©e estim√©e : <span id="trainingTotalTime"
                        class="font-bold text-gray-900 bg-yellow-200 px-2 rounded">0</span> min</p>
            </div>
            <div class="flex flex-col items-center md:items-end gap-3 mt-4 md:mt-0">
                <div id="sessionTimerContainer"
                    class="hidden flex items-center gap-3 bg-red-50 border border-red-100 px-4 py-2 rounded-xl shadow-inner mb-2 w-full md:w-auto justify-center">
                    <i class="fas fa-stopwatch text-red-500 animate-pulse text-xl"></i>
                    <span id="sessionTimerText" class="font-black text-2xl text-red-700 font-mono">00:00:00</span>
                </div>
                <div class="flex gap-3">
                    <button
                        class="bg-gray-200 text-gray-700 px-5 py-2.5 rounded-xl font-bold hover:bg-gray-300 transition text-sm shadow-sm"
                        onclick="cancelSession()">
                        <i class="fas fa-trash mr-2"></i>VIDER
                    </button>
                    <button id="btnStartSession"
                        class="bg-green-600 text-white px-6 py-2.5 rounded-xl font-black hover:bg-green-700 transition shadow-lg text-sm flex items-center gap-2"
                        onclick="startSession()">
                        <i class="fas fa-play"></i>D√âMARRER LA S√âANCE
                    </button>
                    <button id="btnFinishSession"
                        class="hidden bg-red-600 text-white px-6 py-2.5 rounded-xl font-black hover:bg-red-700 transition shadow-lg text-sm flex items-center gap-2"
                        onclick="finishSession()">
                        <i class="fas fa-flag-checkered"></i>TERMINER LA S√âANCE
                    </button>
                </div>
            </div>


        </div>

        <!-- Param√®tres de la S√©ance (Adaptable Training) -->
        <div id="adaptationControls" class="bg-white border border-blue-100 rounded-2xl p-6 mb-8 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3 text-blue-600">
                    <i class="fas fa-magic text-xl"></i>
                    <h3 class="font-black text-lg uppercase tracking-tight">Entra√Ænement Adaptable</h3>
                </div>
                <button id="btnAdaptSession" onclick="adaptSession()"
                    class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-black hover:bg-blue-700 transition shadow-lg flex items-center gap-2 text-sm uppercase tracking-wide">
                    <span id="btnAdaptText"><i class="fas fa-sync-alt mr-2"></i>ADAPTER LA S√âANCE</span>
                    <span id="btnAdaptLoader" class="hidden"><i
                            class="fas fa-spinner fa-spin mr-2"></i>Adaptation...</span>
                </button>
            </div>

            <div id="adaptationRowsContainer" class="space-y-4">
                <!-- Les lignes d'exercices seront inject√©es ici -->
            </div>

            <div class="mt-4 p-4 bg-blue-50 rounded-xl border border-blue-100 flex items-start gap-3">
                <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                <p class="text-xs font-semibold text-blue-800 leading-relaxed">
                    <span class="font-black uppercase">Astuce Propagation :</span> Si vous laissez un champ vide sur
                    l'Exercice 2 ou 3, il prendra automatiquement la valeur de l'exercice pr√©c√©dent. Remplissez
                    l'Exercice 1 pour configurer toute la s√©ance d'un coup !
                </p>
            </div>
        </div>

        <div id="trainingList" class="space-y-6"></div>
        {% endif %}
    </div>

    <div id="historyView" class="max-w-7xl mx-auto px-4 py-10 hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-gray-100 pb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center"><i
                    class="fas fa-history mr-3 text-secondary"></i>Historique</h2>

            <!-- Sous-onglets Historique -->
            <div class="flex bg-gray-100 p-1 rounded-xl shadow-inner">
                <button onclick="switchHistoryTab('training')" id="tabHistTrain"
                    class="px-6 py-2 rounded-lg font-bold text-sm transition-all bg-white text-secondary shadow-sm">
                    <i class="fas fa-dumbbell mr-2"></i>Entra√Ænements
                </button>
                <button onclick="switchHistoryTab('match')" id="tabHistMatch"
                    class="px-6 py-2 rounded-lg font-bold text-sm transition-all text-gray-500 hover:text-gray-700">
                    <i class="fas fa-search mr-2"></i>Matchs Jou√©s
                </button>
            </div>
        </div>

        <div id="historyTrainingContent">
            <div id="historyList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les sessions d'entra√Ænement seront inject√©es ici -->
                <p class="col-span-full text-center py-20 text-gray-400">Aucun entra√Ænement termin√©.</p>
            </div>
        </div>

        <div id="historyMatchContent" class="hidden">
            <div id="historyMatchList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les matchs termin√©s seront inject√©s ici -->
                <p class="col-span-full text-center py-20 text-gray-400">Aucun match coch√© comme "trouv√©" pour
                    l'instant.</p>
            </div>
        </div>
    </div>

    <div id="matchView" class="max-w-7xl mx-auto px-4 py-10 hidden">
        <!-- Hero Section -->
        <div
            class="bg-gradient-to-br from-[#1e3c72] via-[#2a5298] to-emerald-500 text-white py-12 px-8 rounded-3xl shadow-2xl mb-10 relative overflow-hidden">
            <div
                class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/soccer.png')]">
            </div>
            <div
                class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl">
            </div>
            <div
                class="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2 blur-2xl">
            </div>

            <div class="relative z-10 text-center">
                <div
                    class="inline-flex items-center gap-2 bg-white/20 backdrop-blur px-4 py-2 rounded-full text-sm font-semibold mb-4">
                    <i class="fas fa-users text-emerald-300"></i>
                    <span>Communaut√© de Coachs</span>
                </div>
                <h2 class="text-4xl md:text-5xl font-extrabold mb-4 tracking-tight">
                    ‚öΩ Organise un <span class="text-emerald-300">match amical</span>
                </h2>
                <p class="text-blue-100 text-lg max-w-2xl mx-auto">
                    Cr√©e un match pour ton √©quipe ou trouve un adversaire parmi les autres coachs.
                </p>
            </div>
        </div>

        <!-- Onglets Cr√©er / Chercher -->
        <div class="flex justify-center gap-4 mb-8">
            <button onclick="switchMatchTab('create')" id="tabCreate"
                class="px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 bg-[#2a5298] text-white shadow-lg scale-105">
                <i class="fas fa-plus-circle mr-2"></i> Je cr√©e un match
            </button>
            <button onclick="switchMatchTab('search')" id="tabSearch"
                class="px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 bg-gray-200 text-gray-600 hover:bg-gray-300">
                <i class="fas fa-search mr-2"></i> Je cherche un match
            </button>
        </div>

        <!-- Formulaire "Je cr√©e un match" -->
        <div id="createMatchSection" class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8 mb-10">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <i class="fas fa-calendar-plus text-orange-500"></i>
                Publier une annonce de match amical
            </h3>

            <!-- AVERTISSEMENT ABUS -->
            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-8 rounded-r-xl flex items-start gap-4">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xl mt-1"></i>
                </div>
                <div>
                    <h4 class="text-red-800 font-bold text-sm uppercase mb-1">Politique de Tol√©rance Z√©ro (Football
                        Uniquement)</h4>
                    <p class="text-sm text-red-700 leading-relaxed">
                        Cette plateforme est <strong>exclusivement r√©serv√©e au Football</strong>. Tout abus, publication
                        pour un autre sport, fausse information ou partage de compte entra√Ænera un
                        <strong>bannissement d√©finitif et irr√©versible</strong> de la plateforme.
                        Soyez professionnels et respectueux dans vos √©changes.
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- SIRET / Club -->
                <div class="space-y-4 md:col-span-2">
                    <label class="text-lg font-black text-secondary flex items-center gap-2 uppercase tracking-tight">
                        <i class="fas fa-shield-alt text-teal-500"></i> 1. Mon club
                    </label>
                    <div class="relative group">
                        <i
                            class="fas fa-id-card absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-teal-500 transition-colors"></i>
                        <input type="text" id="createClubSiret" placeholder="Identifiant club (SIRET/NOM)..."
                            class="w-full pl-12 pr-12 py-4 border-2 border-gray-200 rounded-2xl focus:border-teal-500 transition-all font-bold text-gray-700 shadow-sm bg-gray-50"
                            readonly onclick="checkLoginBeforeAction(event)">
                        <div id="createSiretLoader" class="absolute right-4 top-1/2 -translate-y-1/2 z-10 hidden">
                            <i class="fas fa-spinner fa-spin text-teal-500 text-xl"></i>
                        </div>
                    </div>
                    <div id="createSiretInfo"
                        class="hidden mt-2 p-4 bg-blue-50 border border-blue-100 rounded-xl flex items-center gap-3">
                        <img id="createSiretLogo" src=""
                            class="w-12 h-12 object-contain bg-white rounded shadow-sm p-1">
                        <div>
                            <div id="createSiretName" class="font-bold text-gray-800"></div>
                            <div id="createSiretAddr" class="text-xs text-gray-500"></div>
                        </div>
                    </div>
                    <input type="hidden" id="createClubName">
                    <input type="hidden" id="createClubId">
                    <input type="hidden" id="createLocation">
                    <input type="hidden" id="createLocationLat">
                    <input type="hidden" id="createLocationLng">
                    <input type="hidden" id="createClubLogo">
                </div>

                <!-- Adresse du complexe (Lue du profil) -->
                <div class="space-y-4 md:col-span-2">
                    <label class="text-lg font-black text-secondary flex items-center gap-2 uppercase tracking-tight">
                        <i class="fas fa-map-pin text-orange-500"></i> 3. Adresse pr√©cise du complexe / stade
                    </label>
                    <div class="relative group">
                        <i
                            class="fas fa-road absolute left-4 top-4 text-gray-400 group-focus-within:text-orange-500 transition-colors"></i>
                        <input type="text" id="createStadiumAddress"
                            placeholder="S'affiche automatiquement via ton profil..."
                            class="w-full pl-12 pr-4 py-4 border-2 border-gray-100 rounded-2xl focus:border-orange-500 transition-all font-bold text-gray-700 shadow-sm bg-gray-50 hover:border-gray-400 cursor-pointer"
                            readonly onclick="checkLoginBeforeAction(event)">
                    </div>
                </div>

                <!-- Date souhait√©e -->
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-calendar text-green-500"></i> Date souhait√©e *
                    </label>
                    <input type="date" id="createMatchDate"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold hover:border-gray-400"
                        onfocus="checkLoginBeforeAction(event) || (function(e){const today = new Date().toISOString().split('T')[0]; e.min = today;})(this)">
                </div>

                <!-- Horaire -->
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-clock text-indigo-500"></i> Horaire du match *
                    </label>
                    <input type="time" id="createMatchTime" value="15:00"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold hover:border-gray-400"
                        onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                </div>

                <!-- Cat√©gorie -->
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-child text-purple-500"></i> Cat√©gorie d'√¢ge
                    </label>
                    <select id="createCategory"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold hover:border-gray-400"
                        onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                        <option value="U6">U6 (D√©butants)</option>
                        <option value="U7">U7</option>
                        <option value="U8">U8</option>
                        <option value="U9">U9</option>
                        <option value="U10">U10</option>
                        <option value="U11">U11</option>
                        <option value="U12">U12</option>
                        <option value="U13">U13</option>
                        <option value="U14">U14</option>
                        <option value="U15" selected>U15</option>
                        <option value="U16">U16</option>
                        <option value="U17">U17</option>
                        <option value="U18">U18</option>
                        <option value="U19">U19</option>
                        <option value="U20">U20</option>
                        <option value="Seniors">Seniors</option>
                        <option value="V√©t√©rans">V√©t√©rans (+35 ans)</option>
                    </select>
                </div>

                <!-- Niveau -->
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-layer-group text-red-500"></i> Niveau de l'√©quipe
                    </label>
                    <select id="createLevel"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold hover:border-gray-400"
                        onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                        <option value="Loisir">Loisir / Foot Entreprise</option>
                        <optgroup label="D√©partemental (District)">
                            <option value="D5">D√©partemental 5 (D5)</option>
                            <option value="D4">D√©partemental 4 (D4)</option>
                            <option value="D3">D√©partemental 3 (D3)</option>
                            <option value="D2">D√©partemental 2 (D2)</option>
                            <option value="D1">D√©partemental 1 (D1)</option>
                        </optgroup>
                        <optgroup label="R√©gional (Ligue)">
                            <option value="R3">R√©gional 3 (R3)</option>
                            <option value="R2">R√©gional 2 (R2)</option>
                            <option value="R1">R√©gional 1 (R1)</option>
                        </optgroup>
                        <optgroup label="National">
                            <option value="N3">National 3 (N3)</option>
                            <option value="N2">National 2 (N2)</option>
                            <option value="N1">National 1 (N1)</option>
                        </optgroup>
                        <optgroup label="Elite">
                            <option value="L2">Ligue 2</option>
                            <option value="L1">Ligue 1</option>
                        </optgroup>
                    </select>
                </div>



                <!-- Type de match -->
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-futbol text-orange-500"></i> Type de match
                    </label>
                    <select id="createMatchType"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold hover:border-gray-400"
                        onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                        <option value="Amical 11v11" selected>Match Amical (11 vs 11)</option>
                        <option value="Amical 8v8">Match Amical (8 vs 8 - √âcole de foot)</option>
                        <option value="Amical 5v5">Match Amical (5 vs 5)</option>
                        <option value="Opposition Interne">Opposition Interne</option>
                        <option value="Tournoi">Tournoi</option>
                    </select>
                </div>

                <!-- Type de terrain -->
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-grass text-emerald-500"></i> Type de terrain
                    </label>
                    <select id="createTerrainType"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold hover:border-gray-400"
                        onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                        <option value="Gazon naturel" selected>üåø Gazon Naturel</option>
                        <option value="Synth√©tique">üîµ Synth√©tique (Derni√®re g√©n√©ration)</option>
                        <option value="Synth√©tique ancienne g√©n√©ration">‚ö´ Synth√©tique (Ancienne g√©n√©ration)</option>
                        <option value="Stabilis√©">üü§ Stabilis√© / Terre battue</option>
                        <option value="Indoor/Futsal">üè¢ Indoor / Futsal</option>
                        <option value="Mixte">üîÄ Terrain Mixte (Hybride)</option>
                    </select>
                </div>
            </div>

            <!-- Message / Infos suppl√©mentaires -->
            <div class="mb-6">
                <label class="text-sm font-bold text-gray-700 flex items-center gap-2 mb-3">
                    <i class="fas fa-comment text-gray-500"></i> Message pour les autres coachs (optionnel)
                </label>
                <textarea id="createMessage" rows="3"
                    placeholder="Ex: Match amical pour pr√©parer le championnat. Vestiaires disponibles. Pot offert apr√®s le match !"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition resize-none hover:border-gray-400"
                    onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)"></textarea>
            </div>

            <!-- Contact -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-envelope text-blue-500"></i> Email de contact *
                    </label>
                    <input type="email" id="createEmail" placeholder="coach@exemple.fr"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold hover:border-gray-400"
                        onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-phone text-green-500"></i> T√©l√©phone (optionnel)
                    </label>
                    <div class="flex">
                        <span
                            class="inline-flex items-center px-4 py-3 bg-gray-100 border-2 border-r-0 border-gray-200 rounded-l-xl text-gray-600 font-bold text-sm">
                            <span class="mr-1">üá´üá∑</span> +33
                        </span>
                        <input type="tel" id="createPhone" placeholder="06 12 34 56 78" maxlength="14"
                            oninput="formatPhoneNumber(this)"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-r-xl focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition font-semibold hover:border-gray-400"
                            onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                    </div>
                    <p id="phoneError" class="text-red-500 text-xs hidden mt-1"><i
                            class="fas fa-exclamation-circle mr-1"></i>Num√©ro invalide (10 chiffres recommand√©s)</p>
                </div>
            </div>

            <!-- Bouton publier -->
            <div class="text-center">
                <button id="btnPublishMatch" onclick="checkLoginBeforeAction(event) || publishMatch()"
                    class="bg-gradient-to-r from-[#1e3c72] via-[#2a5298] to-emerald-500 text-white px-12 py-4 rounded-full font-black text-lg hover:shadow-2xl hover:scale-105 transition-all duration-300 shadow-lg">
                    <i class="fas fa-bullhorn mr-3"></i> PUBLIER MON ANNONCE
                </button>
            </div>

            <p class="text-center text-gray-400 text-xs mt-4">* Champs obligatoires. Ton annonce sera visible par tous
                les coachs de la plateforme.</p>

            <!-- DASHBOARD: MES MATCHS CR√â√âS -->
            <div id="myMatchesDashboard" class="mt-12 pt-8 border-t border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fas fa-clipboard-list text-blue-500"></i>
                    Mes annonces publi√©es
                </h3>
                <div id="myMatchesList" class="space-y-4">
                    <!-- Rempli par JS (renderMyMatches) -->
                    <div class="text-center py-6 bg-gray-50 rounded-xl">
                        <p class="text-gray-400 text-sm">Tu n'as pas encore publi√© d'annonce.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================= CHERCHER UN MATCH AMICAL ======================= -->
        <div id="searchMatchSection" class="hidden">
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8 mb-10">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-search text-pink-500"></i>
                    Trouver un adversaire pour un match amical
                </h3>

                <!-- Ligne 1 : Ville, Date, Rayon (3 items) -->
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Ville -->
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-teal-500"></i> Ville / R√©gion
                        </label>
                        <input type="text" id="searchLocation" placeholder="Ex: Paris, Lyon..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition font-semibold hover:border-gray-400"
                            onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                        <input type="hidden" id="searchLocationLat">
                        <input type="hidden" id="searchLocationLng">
                    </div>

                    <!-- Date -->
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-calendar text-blue-500"></i> Date du match
                        </label>
                        <input type="date" id="searchDate"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition font-semibold hover:border-gray-400"
                            onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                    </div>

                    <!-- Rayon de recherche -->
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-bullseye text-red-500"></i> Rayon (km)
                        </label>
                        <div class="flex">
                            <input type="number" id="searchRadius" placeholder="Ex: 50" min="0" max="500" value="50"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-l-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition font-semibold hover:border-gray-400"
                                onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                            <span
                                class="inline-flex items-center px-4 py-3 bg-gray-100 border-2 border-l-0 border-gray-200 rounded-r-xl text-gray-600 font-bold text-sm">
                                km
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Ligne 2 : Cat√©gorie, Type, Terrain, Niveau (4 items) -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Cat√©gorie -->
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-child text-purple-500"></i> Cat√©gorie
                        </label>
                        <select id="searchCategory"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition font-semibold hover:border-gray-400"
                            onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                            <option value="">Toutes cat√©gories</option>
                            <option value="U6">U6</option>
                            <option value="U7">U7</option>
                            <option value="U8">U8</option>
                            <option value="U9">U9</option>
                            <option value="U10">U10</option>
                            <option value="U11">U11</option>
                            <option value="U12">U12</option>
                            <option value="U13">U13</option>
                            <option value="U14">U14</option>
                            <option value="U15">U15</option>
                            <option value="U16">U16</option>
                            <option value="U17">U17</option>
                            <option value="U18">U18</option>
                            <option value="U19">U19</option>
                            <option value="U20">U20</option>
                            <option value="Seniors">Seniors</option>
                            <option value="V√©t√©rans">V√©t√©rans</option>
                        </select>
                    </div>

                    <!-- Type de match -->
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-futbol text-orange-500"></i> Type de match
                        </label>
                        <select id="searchMatchType"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition font-semibold hover:border-gray-400"
                            onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                            <option value="">Tous types</option>
                            <option value="Amical 11v11">Match Amical (11 vs 11)</option>
                            <option value="Amical 8v8">Match Amical (8 vs 8)</option>
                            <option value="Amical 5v5">Match Amical (5 vs 5)</option>
                            <option value="Opposition Interne">Opposition Interne</option>
                            <option value="Tournoi">Tournoi</option>
                        </select>
                    </div>

                    <!-- Type de terrain -->
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-grass text-emerald-500"></i> Type de terrain
                        </label>
                        <select id="searchTerrainType"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition font-semibold hover:border-gray-400"
                            onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                            <option value="">Tous terrains</option>
                            <option value="Gazon naturel">üåø Gazon Naturel</option>
                            <option value="Synth√©tique">üîµ Synth√©tique</option>
                            <option value="Stabilis√©">üü§ Stabilis√©</option>
                            <option value="Indoor/Futsal">üè¢ Indoor / Futsal</option>
                        </select>
                    </div>

                    <!-- Niveau -->
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                            <i class="fas fa-layer-group text-red-500"></i> Niveau
                        </label>
                        <select id="searchLevel"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition font-semibold hover:border-gray-400"
                            onfocus="checkLoginBeforeAction(event)" onclick="checkLoginBeforeAction(event)">
                            <option value="">Tous niveaux</option>
                            <optgroup label="Loisir">
                                <option value="Loisir">Loisir / D√©tente</option>
                            </optgroup>
                            <optgroup label="District">
                                <option value="D5">District 5 (D5)</option>
                                <option value="D4">District 4 (D4)</option>
                                <option value="D3">District 3 (D3)</option>
                                <option value="D2">District 2 (D2)</option>
                                <option value="D1">District 1 (D1)</option>
                            </optgroup>
                            <optgroup label="R√©gional">
                                <option value="R3">R√©gional 3 (R3)</option>
                                <option value="R2">R√©gional 2 (R2)</option>
                                <option value="R1">R√©gional 1 (R1)</option>
                            </optgroup>
                            <optgroup label="National">
                                <option value="N3">National 3 (N3)</option>
                                <option value="N2">National 2 (N2)</option>
                                <option value="N1">National 1 (N1)</option>
                            </optgroup>
                            <optgroup label="Elite">
                                <option value="L2">Ligue 2</option>
                                <option value="L1">Ligue 1</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="text-center">
                    <button onclick="checkLoginBeforeAction(event) || searchMatches()"
                        class="bg-gradient-to-r from-[#1e3c72] via-[#2a5298] to-emerald-500 text-white px-10 py-3 rounded-full font-bold hover:shadow-xl hover:scale-105 transition-all">
                        <i class="fas fa-search mr-2"></i> RECHERCHER DES MATCHS
                    </button>
                </div>
            </div>

            <!-- Liste des matchs disponibles -->
            <div id="matchListContainer">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                        <i class="fas fa-list text-orange-500"></i>
                        Matchs disponibles
                    </h3>
                    <div class="flex gap-2">
                        <button id="btnCalendarView" onclick="openCalendarModal()"
                            class="px-4 py-2 rounded-xl font-bold text-sm bg-white border-2 border-gray-200 text-gray-400 hover:border-blue-400 hover:text-blue-500 transition-all flex items-center gap-2">
                            <i class="fas fa-calendar-alt"></i> Vue Calendrier
                        </button>
                        <button id="btnFavoritesFilter" onclick="toggleFavoritesFilter()"
                            class="px-4 py-2 rounded-xl font-bold text-sm bg-white border-2 border-gray-200 text-gray-400 hover:border-red-400 hover:text-red-500 transition-all flex items-center gap-2">
                            <i class="fas fa-heart"></i> Mes Favoris
                        </button>
                    </div>
                </div>

                <div id="matchList" class="space-y-4">
                    <div class="text-center py-16 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200">
                        <div class="text-6xl mb-4">‚öΩ</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">Aucun match publi√© pour l'instant</h3>
                        <p class="text-gray-400">Sois le premier √† publier un match en cliquant sur "Je cr√©e un match" !
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-full bg-secondary text-white py-3 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.3)] transform translate-y-full transition-transform duration-300 ease-out"
        id="sessionBar">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="hidden md:block font-bold text-gray-400 text-sm uppercase tracking-wider">S√©ance en cours
                </div>
                <div class="flex items-center gap-4">
                    <div class="bg-white/10 px-4 py-2 rounded-lg">
                        <i class="fas fa-stopwatch text-gold mr-2"></i><span id="totalTime"
                            class="font-bold text-xl">0</span> <span class="text-xs">min</span>
                    </div>
                    <div class="bg-white/10 px-4 py-2 rounded-lg">
                        <i class="fas fa-dumbbell text-primary mr-2"></i><span id="exoCount"
                            class="font-bold text-xl">0</span> <span class="text-xs">exos</span>
                    </div>
                </div>
            </div>
            <button
                class="bg-accent text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-green-600 transition flex items-center animate-pulse"
                onclick="showView('training')">
                VOIR MA S√âANCE <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <div id="alertContainer" class="fixed top-24 right-5 z-[99999]" style="z-index: 99999;"></div>

    <div class="modal fade" id="deroulementModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-super-wide">
            <div class="modal-content border-0 shadow-2xl" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header border-0 text-white p-4"
                    style="background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);">
                    <h5 class="modal-title fw-bold fs-4 m-0">
                        <i class="fas fa-list-ul me-2"></i>D√©roulement de l'exercice
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-5" style="max-height: 70vh; overflow-y: auto;">
                    <div id="deroulementContent" style="font-size: 16px; line-height: 1.8; color: #334155;">
                        <!-- Le contenu sera inject√© ici -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal G√©n√©rer S√©ance (Recherche Rapide) -->
    <div class="modal fade" id="quickCreateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow-2xl rounded-3xl">
                <div
                    class="modal-header border-0 bg-gradient-to-r from-emerald-500 to-teal-500 text-white p-6 rounded-t-3xl">
                    <h5 class="modal-title font-bold text-2xl">
                        <i class="fas fa-magic mr-3"></i>G√©n√©rer une s√©ance
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-8 bg-gray-50">
                    <!-- Formulaire de recherche (D√©plac√© ici) -->
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
                        <h4 class="font-bold text-gray-700 mb-4">Crit√®res de la s√©ance</h4>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Nombre de joueurs -->
                            <div class="space-y-2">
                                <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-users text-emerald-500"></i> Joueurs
                                </label>
                                <input type="number" id="matchPlayers" placeholder="Ex: 16" min="4" max="30"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition font-semibold">
                            </div>

                            <!-- Dur√©e -->
                            <div class="space-y-2">
                                <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-clock text-blue-500"></i> Dur√©e
                                </label>
                                <select id="matchDuration"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition font-semibold">
                                    <option value="15">15 min</option>
                                    <option value="30">30 min</option>
                                    <option value="45">45 min</option>
                                    <option value="60" selected>60 min</option>
                                    <option value="90">90 min</option>
                                </select>
                            </div>

                            <!-- Niveau -->
                            <div class="space-y-2">
                                <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-layer-group text-purple-500"></i> Niveau
                                </label>
                                <select id="matchLevel"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition font-semibold">
                                    <option value="debutant">D√©butant</option>
                                    <option value="departemental">D√©partemental</option>
                                    <option value="regional" selected>R√©gional</option>
                                    <option value="national">National</option>
                                </select>
                            </div>

                            <!-- Cat√©gorie -->
                            <div class="space-y-2">
                                <label class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-child text-orange-500"></i> Cat√©gorie
                                </label>
                                <select id="matchCategory"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition font-semibold">
                                    <option value="U11">U11</option>
                                    <option value="U13">U13</option>
                                    <option value="U15" selected>U15</option>
                                    <option value="U17">U17</option>
                                    <option value="U19">U19</option>
                                    <option value="Seniors">Seniors</option>
                                </select>
                            </div>
                        </div>

                        <!-- Th√®mes -->
                        <div class="mb-6">
                            <label class="text-sm font-bold text-gray-700 flex items-center gap-2 mb-3">
                                <i class="fas fa-bullseye text-red-500"></i> Th√®mes prioritaires
                            </label>
                            <div class="flex flex-wrap gap-3">
                                <label class="cursor-pointer">
                                    <input type="checkbox" id="matchTech" class="hidden peer">
                                    <span
                                        class="px-4 py-2 rounded-full border-2 border-gray-200 font-bold text-sm text-gray-600 transition peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500">
                                        ‚öΩ Technique
                                    </span>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" id="matchTac" class="hidden peer">
                                    <span
                                        class="px-4 py-2 rounded-full border-2 border-gray-200 font-bold text-sm text-gray-600 transition peer-checked:bg-purple-500 peer-checked:text-white peer-checked:border-purple-500">
                                        üß† Tactique
                                    </span>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" id="matchPhys" class="hidden peer">
                                    <span
                                        class="px-4 py-2 rounded-full border-2 border-gray-200 font-bold text-sm text-gray-600 transition peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500">
                                        üí™ Physique
                                    </span>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" id="matchMatch" class="hidden peer">
                                    <span
                                        class="px-4 py-2 rounded-full border-2 border-gray-200 font-bold text-sm text-gray-600 transition peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                        üèÜ Jeu
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-6">
                            <textarea id="matchDescription" rows="2"
                                placeholder="Instructions sp√©cifiques pour l'IA (Ex: Accent sur la transition d√©fensive...)"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition resize-none"></textarea>
                        </div>

                        <div class="text-center">
                            <button onclick="searchMatch()" id="btnSearchMatch"
                                class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition-all w-full md:w-auto">
                                <span id="searchMatchText"><i class="fas fa-magic mr-2"></i>G√©n√©rer ma s√©ance</span>
                                <span id="searchMatchLoader" class="hidden"><i
                                        class="fas fa-spinner fa-spin mr-2"></i>G√©n√©ration...</span>
                            </button>
                        </div>
                    </div>

                    <!-- R√©sultats -->
                    <div id="matchResults" class="hidden">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-500"></i> Exercices trouv√©s
                        </h4>
                        <div id="matchResultsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- R√©sultats ici -->
                        </div>
                    </div>

                    <div id="matchEmpty" class="hidden text-center py-8">
                        <p class="text-gray-500">Aucun exercice ne correspond exactement. Essaie d'√©largir tes crit√®res.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="quickCreateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-2xl rounded-2xl overflow-hidden">
                <div class="modal-header border-0 bg-gray-50 p-5">
                    <h5 class="text-xl font-bold text-secondary"><i class="fas fa-robot text-primary mr-2"></i>Assistant
                        Coach IA</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Cat√©gorie</label>
                            <select
                                class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary"
                                id="quickCategory">
                                <option>U10 / U11</option>
                                <option>U12 / U13</option>
                                <option>U14 / U15</option>
                                <option selected>U16 / U17</option>
                                <option>Seniors</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Dur√©e (min)</label>
                            <input type="number" id="quickDuration"
                                class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 outline-none focus:border-primary"
                                value="90">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-3">Th√®me principal</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="mainTheme" value="TECHNIQUE" checked class="peer sr-only">
                                <div
                                    class="px-4 py-3 rounded-xl border-2 border-gray-100 text-center peer-checked:border-primary peer-checked:bg-blue-50 transition hover:bg-gray-50">
                                    <i class="fas fa-futbol text-2xl mb-2 text-primary block"></i>
                                    <span class="text-sm font-bold text-gray-600">Technique</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="mainTheme" value="PHYSIQUE" class="peer sr-only">
                                <div
                                    class="px-4 py-3 rounded-xl border-2 border-gray-100 text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition hover:bg-gray-50">
                                    <i class="fas fa-running text-2xl mb-2 text-orange-500 block"></i>
                                    <span class="text-sm font-bold text-gray-600">Physique</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="mainTheme" value="TACTIQUE" class="peer sr-only">
                                <div
                                    class="px-4 py-3 rounded-xl border-2 border-gray-100 text-center peer-checked:border-purple-500 peer-checked:bg-purple-50 transition hover:bg-gray-50">
                                    <i class="fas fa-chess-board text-2xl mb-2 text-purple-500 block"></i>
                                    <span class="text-sm font-bold text-gray-600">Tactique</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-5 bg-gray-50">
                    <button
                        class="w-full bg-primary text-white font-bold text-lg py-3 rounded-xl shadow-lg hover:bg-blue-700 transition"
                        onclick="generateQuickSession()">
                        G√©n√©rer ma s√©ance
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allVideosMap = {};
        let sessionPlaylist = [];
        let currentCalendarDate = new Date();
        let activeKeywords = [];
        let activeThemes = [];
        let sessionStartTime = null;

        // === ETAT GLOBAL (AUTH & DATA) ===
        let currentUser = JSON.parse(localStorage.getItem('scCurrentUser') || 'null');
        let showFavoritesOnly = false;

        // Initialisation de l'ID via getOrCreateUserId (hoisted)
        let CURRENT_USER_ID = currentUser ? currentUser.id : (typeof getOrCreateUserId === 'function' ? getOrCreateUserId() : 'user_guest');

        let userFavorites = [];
        try {
            userFavorites = JSON.parse(localStorage.getItem('scFavorites') || '[]');
            if (!Array.isArray(userFavorites)) userFavorites = [];
        } catch (e) { userFavorites = []; }

        // Alias pour compatibilit√© descendante
        let favorites = userFavorites;

        let historyData = [];
        try {
            historyData = JSON.parse(localStorage.getItem('smartCoachHistory') || '[]');
            if (!Array.isArray(historyData)) historyData = [];
        } catch (e) { historyData = []; }

        let savedMatches = [];
        try {
            const storedMatches = localStorage.getItem('scMatches');
            savedMatches = JSON.parse(storedMatches || '[]');
            if (!Array.isArray(savedMatches)) savedMatches = [];
        } catch (e) {
            console.error("Erreur parsing scMatches:", e);
            savedMatches = [];
        }

        // === UX SECURIT√â : VERROUILLAGE VISITEURS ===
        function checkLoginBeforeAction(event) {
            // On v√©rifie si un utilisateur est connect√© (currentUser pr√©sent et non null)
            if (!currentUser) {
                if (event) {
                    event.preventDefault(); // Bloque le focus/click
                    event.stopPropagation();
                }

                // Ouvre la modal d'inscription (ou login selon pref, ici on switch vers login si existant)
                openLoginModal();

                // Affiche un toast/msg
                showToast("üîí Connexion ou Inscription obligatoire pour cette action", "warning");

                // On retire le focus de l'√©l√©ment pour √™tre s√ªr
                if (event && event.target) {
                    try { event.target.blur(); } catch (e) { }
                }

                return true; // Indique qu'on a bloqu√© l'action (retourne true pour court-circuiter le ||)
            }
            return false; // Action autoris√©e
        }

        // === RECHERCHE AFFILIATION FFF (Nouveau syst√®me am√©lior√©) ===
        let globalRegTimeout = null;

        async function handleAffiliationLookup(no) {
            const val = no.trim();
            const loader = document.getElementById('regClubLoading');
            const infoBox = document.getElementById('regClubInfoBox');
            const suggestionsBox = document.getElementById('regAffiliationSuggestions');

            // STRICTEMENT 6 CHIFFRES
            if (!/^\d{6}$/.test(val)) {
                // Si pas 6 chiffres, on cache tout et on ne fait rien
                if (infoBox) infoBox.classList.add('hidden');
                if (suggestionsBox) suggestionsBox.classList.add('hidden');
                if (loader) loader.classList.add('hidden');
                return;
            }

            if (loader) loader.classList.remove('hidden');
            if (globalRegTimeout) clearTimeout(globalRegTimeout);

            globalRegTimeout = setTimeout(async () => {
                try {
                    // Appel Backend FFF Scraper
                    const searchRes = await fetch(`/api/clubs/fff-lookup?q=${val}`);
                    const suggestions = await searchRes.json();

                    if (suggestions && suggestions.length > 0) {
                        suggestionsBox.innerHTML = suggestions.map(club => `
                            <div class="px-4 py-3 hover:bg-accent/5 cursor-pointer border-b border-gray-50 flex items-center gap-3 group transition-all"
                                 onclick="selectAffiliation('${club.affiliation}', '${club.name.replace(/'/g, "\\'")}', '${club.location || ''}', '${(club.address || '').replace(/'/g, "\\'")}', '${club.logo}')">
                                <img src="${club.logo}" class="w-8 h-8 object-contain bg-white rounded shadow-sm p-0.5" onerror="this.src='/static/default_club.png'">
                                <div class="flex-grow">
                                    <div class="font-bold text-gray-800 text-xs group-hover:text-accent transition-colors">${club.name}</div>
                                    <div class="text-[9px] text-gray-400 font-black uppercase tracking-widest">${club.location || 'FRANCE'}</div>
                                </div>
                                <i class="fas fa-plus text-accent opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                    `).join('');
                        suggestionsBox.classList.remove('hidden');
                    } else {
                        suggestionsBox.classList.add('hidden');
                    }


                } catch (err) {
                    console.error("Lookup error:", err);
                } finally {
                    if (loader) loader.classList.add('hidden');
                }
            }, 300);
        }

        async function selectAffiliation(clNo, name, location, address, logo) {
            document.getElementById('regAffiliation').value = clNo;
            document.getElementById('regAffiliationSuggestions').classList.add('hidden');

            const clubData = {
                nom: name,
                ville: location,
                adresse: address,
                logo_url: logo,
                district: ''
            };

            applyClubData(clubData, clNo);
        }

        function applyClubData(club, clNo) {
            const infoBox = document.getElementById('regClubInfoBox');
            const logoImg = document.getElementById('regClubLogo');

            // Correction URL Logo si n√©cessaire et affichage
            logoImg.src = club.logo_url;
            logoImg.style.display = 'block'; // S'assurer qu'il est visible

            document.getElementById('regClubNameDisplay').innerText = club.nom;
            document.getElementById('regClubLocationDisplay').innerText = `${club.ville} (${club.district})`;
            infoBox.classList.remove('hidden');

            // Remplissage des champs cach√©s/autour
            document.getElementById('regClub').value = club.nom;
            document.getElementById('regClubId').value = clNo;
            document.getElementById('regLocation').value = club.ville;
            document.getElementById('regStadiumAddress').value = club.adresse;

            showSuccess(`‚öΩ Club s√©lectionn√© : ${club.nom}`);
        }

        // === AUTOCOMPL√âTION CLUBS FFF ===
        let clubSearchTimeout = null;

        function setupClubAutocomplete(inputId, suggestionsId, locationCityCodeId, onSelect) {
            const input = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(suggestionsId);
            if (!input || !suggestionsContainer) return;

            let clubSearchTimeout = null;

            input.addEventListener('input', function () {
                const query = this.value.trim();

                // Clear hidden ID on manual input
                const idField = document.getElementById(inputId + 'Id');
                if (idField) idField.value = '';

                if (clubSearchTimeout) clearTimeout(clubSearchTimeout);

                // STRICTEMENT 6 CHIFFRES POUR DECLENCHER LA RECHERCHE
                if (!/^\d{6}$/.test(query)) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                // Afficher un petit indicateur de chargement si voulu, ou juste attendre
                console.log(`üîç [Registration] Recherche FFF pour ${query}...`);

                clubSearchTimeout = setTimeout(async () => {
                    try {
                        // Utilisation du nouvel endpoint de scraping FFF
                        const url = `/api/clubs/fff-lookup?q=${encodeURIComponent(query)}`;
                        const response = await fetch(url);
                        const clubs = await response.json();

                        if (!clubs || clubs.length === 0) {
                            suggestionsContainer.classList.add('hidden');
                            // Optionnel: Afficher "Aucun club trouv√©"
                            return;
                        }

                        suggestionsContainer.innerHTML = clubs.map(club => `
                            <div class="club-suggestion flex items-center gap-3 p-3 hover:bg-blue-50 cursor-pointer transition border-b border-gray-100 last:border-b-0"
                                onclick="window.onSelectClub('${inputId}', '${suggestionsId}', '${JSON.stringify(club).replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">
                                <img src="${club.logo || '/static/default_club.png'}" 
                                     alt="${club.name}" 
                                     class="w-10 h-10 rounded-lg object-contain bg-gray-100 p-1"
                                     onerror="this.src='/static/default_club.png'">
                                <div class="flex-grow">
                                    <div class="font-bold text-gray-800 text-sm">${club.name}</div>
                                    <div class="text-xs text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${club.location || 'FRANCE'}</div>
                                </div>
                            </div>
                        `).join('');

                        suggestionsContainer.classList.remove('hidden');
                    } catch (err) {
                        console.error('Erreur recherche clubs:', err);
                    }
                }, 300);
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        }

        window.onSelectClub = function (inputId, suggestionsId, clubJson) {
            const club = JSON.parse(clubJson.replace(/&quot;/g, '"'));
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);

            input.value = club.name;

            // Remplissage des champs cach√©s selon le contexte (Create Match ou Register)
            if (inputId === 'createClubSiret' || inputId === 'createClubName') {
                const nameField = document.getElementById('createClubName');
                const idField = document.getElementById('createClubId');
                const locField = document.getElementById('createLocation');
                const stadiumField = document.getElementById('createStadiumAddress');

                if (nameField) nameField.value = club.name;
                if (idField) idField.value = club.cl_no || club.affiliation || '';
                if (locField) locField.value = club.location || '';
                if (stadiumField && club.location) stadiumField.value = club.location;

            } else if (inputId === 'regSiret' || inputId === 'regClub' || inputId === 'regClubHidden') {
                const nameField = document.getElementById('regClubHidden');
                const idField = document.getElementById('regClubId');
                const locField = document.getElementById('regLocation');
                const stadiumField = document.getElementById('regStadiumAddress');

                if (nameField) nameField.value = club.name;
                if (idField) idField.value = club.cl_no || club.affiliation || '';
                if (locField) locField.value = club.location || '';
                if (stadiumField && club.location) stadiumField.value = club.location;
            }

            if (club.latitude) {
                const latField = document.getElementById('createLocationLat') || document.getElementById('regLat');
                if (latField) latField.value = club.latitude;
            }
            if (club.longitude) {
                const lngField = document.getElementById('createLocationLng') || document.getElementById('regLng');
                if (lngField) lngField.value = club.longitude;
            }

            suggestions.classList.add('hidden');
            showSuccess(`üõ°Ô∏è ${club.name} s√©lectionn√© !`);
        };

        // Deprecated: selectClub is replaced by window.onSelectClub


        // === IDENTIFIANT UTILISATEUR UNIQUE (Pour gestion propri√©t√© des annonces) ===
        function getOrCreateUserId() {
            let id = localStorage.getItem('scUserId');
            if (!id) {
                id = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('scUserId', id);
            }
            return id;
        }

        function formatText(text) {
            if (!text) return "";

            let t = text.trim();
            t = t.replace(/\n{3,}/g, '\n\n');

            let lines = t.split('\n');
            let resultHtml = "";
            let currentBlock = [];
            let inBlock = "none"; // "svg", "tactical", "none"

            function flushBlock() {
                if (currentBlock.length === 0) return;
                let content = currentBlock.join('\n').trim();

                // On enl√®ve les marqueurs de d√©but/fin s'ils ont √©t√© captur√©s
                let cleaned = content.replace(/^```(svg|tactical|csv)?/i, '').replace(/```$/g, '').trim();

                if (inBlock === "svg" || inBlock === "csv") {
                    let svgStart = cleaned.indexOf('<svg');
                    if (svgStart !== -1) {
                        resultHtml += `<div class="tactical-svg-container">${cleaned.substring(svgStart)}</div>`;
                    } else {
                        // Fallback : si c'est du texte dans un bloc "image", on l'affiche quand m√™me
                        resultHtml += `<div class="tactical-schema" style="color:#000; font-weight:normal; font-family:monospace;">${cleaned}</div>`;
                    }
                } else if (inBlock === "tactical") {
                    resultHtml += `<div class="tactical-schema" style="color:#000; font-weight:normal; font-family:monospace;">${cleaned}</div>`;
                }
                currentBlock = [];
            }

            lines.forEach((line) => {
                let trimmed = line.trim();

                // D√©tection d√©but de block (M√™me si le tag svg/tactical est oubli√©)
                const startMatch = line.match(/```(svg|tactical|csv)?/i);
                if (startMatch && inBlock === "none") {
                    flushBlock();
                    inBlock = (startMatch[1] || "tactical").toLowerCase(); // Par d√©faut : tactical
                    let afterTag = line.substring(line.indexOf('```') + 3 + (startMatch[1] ? startMatch[1].length : 0)).trim();
                    if (afterTag) currentBlock.push(afterTag);
                    return;
                }

                // D√©tection fin de block (S√©curis√©)
                // Si on rencontre "```" OU si on rencontre un titre "###" alors qu'on est encore dans un bloc (oubli de l'IA)
                if (inBlock !== "none") {
                    // D√©tection fin de bloc SVG inline (</svg>)
                    if (inBlock === "svg" && line.includes('</svg>')) {
                        currentBlock.push(line);
                        flushBlock();
                        inBlock = "none";
                        return;
                    }

                    if (line.includes('```')) {
                        let beforeTag = line.substring(0, line.indexOf('```')).trim();
                        if (beforeTag) currentBlock.push(beforeTag);
                        flushBlock();
                        inBlock = "none";
                        return;
                    }
                    // SAFETY BREAK: Si on voit un titre ###, on ferme de force
                    if (trimmed.startsWith('###')) {
                        flushBlock();
                        inBlock = "none";
                        // On continue pour que le titre soit trait√© normalement plus bas
                    }
                }

                if (inBlock !== "none") {
                    currentBlock.push(line);
                    return;
                }

                // ===== D√âTECTION SVG INLINE (Sans bloc ```) =====
                // Si la ligne contient un <svg, on cherche tout le bloc SVG
                if (trimmed.includes('<svg') && inBlock === "none") {
                    // Chercher la fin du SVG dans les lignes suivantes ou dans celle-ci
                    let svgContent = line;
                    if (line.includes('</svg>')) {
                        // SVG complet sur une seule ligne
                        let svgStart = line.indexOf('<svg');
                        let svgEnd = line.indexOf('</svg>') + 6;
                        resultHtml += `<div class="tactical-svg-container">${line.substring(svgStart, svgEnd)}</div>`;
                        return;
                    }
                    // Sinon on entre en mode SVG inline
                    inBlock = "svg";
                    currentBlock.push(line);
                    return;
                }

                // Texte normal
                if (trimmed === "") {
                    resultHtml += '<div class="h-2"></div>';
                    return;
                }

                // D√©corations standard
                let processedLine = trimmed
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-secondary font-extrabold">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em class="text-gray-600">$1</em>');

                // Titres principaux (###)
                if (trimmed.startsWith('###')) {
                    let cleanTitle = trimmed.replace(/^###\s*/, '').trim();
                    resultHtml += `<div class="w-full bg-gray-50 border-l-4 border-secondary pl-5 py-3 mt-8 mb-4 rounded-r-xl shadow-sm"><h3 class="text-lg font-black text-secondary uppercase tracking-widest leading-none">${cleanTitle}</h3></div>`;
                    return;
                }

                // Titres internes
                const contentOnly = trimmed.replace(/[\*\_]/g, '').trim();
                if (contentOnly.endsWith(':') && contentOnly.length < 60) {
                    let clean = contentOnly.slice(0, -1).trim().replace(/^[\-\u2022]\s+/, '');
                    let icon = "fas fa-chevron-right";
                    let style = "bg-gray-100 text-gray-800 border-gray-200";
                    if (clean.toLowerCase().includes("simplification")) {
                        icon = "fas fa-compress-alt";
                        style = "bg-green-100/80 text-green-900 border-green-300";
                    } else if (clean.toLowerCase().includes("complexification")) {
                        icon = "fas fa-expand-alt";
                        style = "bg-orange-100/80 text-orange-900 border-orange-300";
                    }

                    resultHtml += `<div class="mt-6 mb-4 ${style} border font-black text-[15px] uppercase flex items-center px-4 py-3 rounded-xl shadow-sm tracking-tighter"><i class="${icon} mr-3"></i><span>${clean}</span></div>`;
                } else if (/^[\-\u2022]\s/.test(trimmed)) {
                    resultHtml += `<div class="mb-3 flex items-start gap-3 pl-2"><div class="w-1.5 h-1.5 bg-current rounded-full mt-2.5 shrink-0 opacity-40"></div><span class="text-[16px] leading-relaxed font-bold opacity-90">${processedLine.replace(/^[\-\u2022]\s*/, '')}</span></div>`;
                } else if (/^\d+[\.\)]\s/.test(trimmed)) {
                    let num = trimmed.match(/^\d+/)[0];
                    resultHtml += `<div class="mb-3 flex items-start gap-4"><span class="bg-primary/10 text-primary border border-primary/20 w-7 h-7 rounded-full flex items-center justify-center text-[12px] font-black mt-0.5 shrink-0 shadow-sm">${num}</span><span class="text-[16px] leading-relaxed font-bold opacity-90">${processedLine.replace(/^\d+[\.\)]\s*/, '')}</span></div>`;
                } else {
                    resultHtml += `<p class="mb-3 text-[16px] leading-relaxed font-bold opacity-90">${processedLine}</p>`;
                }
            });
            flushBlock();
            return resultHtml;
        }

        function showError(msg) {
            // Suppression du blocage agressif des erreurs qui masquait les probl√®mes de lookup

            const container = document.getElementById('alertContainer');
            if (!container) return;

            const alertDiv = document.createElement('div');
            alertDiv.className = "bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-2 shadow-lg rounded animate-fade-in";

            // HARD CLEANING: Ensure no HTML tags survive in the body
            let cleanMsg = msg || "Erreur inconnue";
            if (typeof cleanMsg === 'string') {
                // Decode HTML entities first just in case
                const txt = document.createElement("textarea");
                txt.innerHTML = cleanMsg;
                cleanMsg = txt.value;
                // Strip tags
                cleanMsg = cleanMsg.replace(/<[^>]*>?/gm, '');
            }

            // HEADER (Pure DOM)
            const headerP = document.createElement('p');
            headerP.className = "font-bold flex items-center gap-2";

            const icon = document.createElement('i');
            icon.className = "fas fa-exclamation-circle";

            const headerText = document.createTextNode(" Erreur");

            headerP.appendChild(icon);
            headerP.appendChild(headerText);

            // BODY (Pure DOM)
            const msgP = document.createElement('p');
            msgP.className = "text-sm";
            msgP.innerText = cleanMsg;

            // ASSEMBLY
            alertDiv.appendChild(headerP);
            alertDiv.appendChild(msgP);

            container.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.add('opacity-0', 'transition-opacity');
                setTimeout(() => { if (alertDiv.parentNode) alertDiv.remove(); }, 500);
            }, 4000);
        }

        function showSuccess(msg) {
            const container = document.getElementById('alertContainer');
            if (container) container.innerHTML = ""; // Emp√™cher l'empilement
            const alertDiv = document.createElement('div');
            alertDiv.className = "bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-2 shadow-lg rounded transition-opacity duration-300 animate-fade-in";

            // NETTOYAGE ANTI-CODE
            let cleanMsg = msg || "";
            if (typeof cleanMsg === 'string') {
                const txt = document.createElement("textarea");
                txt.innerHTML = cleanMsg;
                cleanMsg = txt.value.replace(/<[^>]*>?/gm, '');
            }

            alertDiv.innerHTML = `<p class="font-bold"><i class="fas fa-check mr-2"></i>Succ√®s</p><p>${cleanMsg}</p>`;
            container.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.add('opacity-0');
                setTimeout(() => { if (alertDiv.parentNode) alertDiv.remove(); }, 500);
            }, 3000);
        }

        // Helper pour unifier showToast
        function showToast(msg, type = 'info') {
            if (type === 'error') {
                showError(msg);
            } else if (type === 'success') {
                showSuccess(msg);
            } else {
                // Info / Warning simple
                showSuccess(msg); // Par d√©faut on utilise le style succ√®s pour l'info pour l'instant
            }
        }

        // === GESTION DE L'AUTHENTIFICATION (SIMUL√âE) ===
        // Note: currentUser et CURRENT_USER_ID sont d√©sormais initialis√©s en haut du script.

        // Lancement des mises √† jour UI/Formulaires au chargement
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            setTimeout(prefillMatchForm, 300);

            // Autres initialisations
            cleanExpiredMatches();
            renderMyMatches();
            setupSiretLookup();
            setupAutocomplete('searchLocation');
        });

        function prefillMatchForm() {
            // IDs for Create form
            const siretInput = document.getElementById('createClubSiret');
            const stadiumInput = document.getElementById('createStadiumAddress');
            const clubNameHidden = document.getElementById('createClubName');
            const clubIdHidden = document.getElementById('createClubId');
            const locationHidden = document.getElementById('createLocation');
            const emailInput = document.getElementById('createEmail');
            const phoneInput = document.getElementById('createPhone');
            const catInput = document.getElementById('createCategory');
            const levelInput = document.getElementById('createLevel');

            // IDs for Search form
            const searchLocationInput = document.getElementById('searchLocation');
            const searchCatInput = document.getElementById('searchCategory');
            const searchLevelInput = document.getElementById('searchLevel');

            // Define UI Card Elements
            const info = document.getElementById('createSiretInfo');
            const nameEl = document.getElementById('createSiretName');
            const addrEl = document.getElementById('createSiretAddr');
            const logoEl = document.getElementById('createSiretLogo');

            if (!currentUser) {
                // CLEAR EVERYTHING IF LOGGED OUT
                if (siretInput) {
                    siretInput.value = "";
                    siretInput.classList.remove('hidden');
                    const pg = siretInput.parentNode;
                    if (pg) pg.classList.remove('hidden');
                }
                if (stadiumInput) stadiumInput.value = "";
                if (clubNameHidden) clubNameHidden.value = "";
                if (clubIdHidden) clubIdHidden.value = "";
                if (locationHidden) locationHidden.value = "";
                if (emailInput) emailInput.value = "";
                if (phoneInput) phoneInput.value = "";
                if (info) info.classList.add('hidden');

                // CLEAR SEARCH FIELDS TOO
                if (searchLocationInput) searchLocationInput.value = "";
                if (searchCatInput) searchCatInput.value = "";
                if (searchLevelInput) searchLevelInput.value = "";

                // CRITICAL: Clear Registration fields as well if they persist
                ['regEmail', 'regPhone', 'regFirstName', 'regLastName', 'regLicenseId', 'regCityVisible', 'regSiret', 'regAffiliation'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = "";
                });

                // Hide registration info box
                const regInfo = document.getElementById('regClubInfoBox');
                if (regInfo) regInfo.classList.add('hidden');

                return;
            }

            // --- FIX & UI REDESIGN ---

            // 1. SAFEGUARD: Only switch to Card View if we actually have club data
            if (siretInput && info && currentUser.club) {
                // HIDE Input Container
                const parentGroup = siretInput.parentNode;
                if (parentGroup && parentGroup.classList.contains('group')) {
                    parentGroup.classList.add('hidden');
                } else if (parentGroup && parentGroup.parentNode && parentGroup.parentNode.classList.contains('group')) {
                    if (parentGroup.classList.contains('relative')) parentGroup.classList.add('hidden');
                } else {
                    siretInput.classList.add('hidden');
                }
                // FIX: Populate value so switchMatchTab doesn't think it's empty and re-trigger lookup
                siretInput.value = currentUser.siret || currentUser.clubId || currentUser.club;

                // SHOW Card
                info.classList.remove('hidden');
                info.classList.remove('mt-4');
                info.classList.add('mt-0');

                // STYLE & INTERACTION
                info.className = "mt-0 p-4 bg-gray-50 border-2 border-gray-200 rounded-2xl flex items-center gap-3 cursor-pointer transition-all hover:border-gray-400 group";
                info.onclick = function () {
                    // Mimic focus state
                    if (this.classList.contains('border-black')) {
                        this.classList.remove('border-black');
                        this.classList.add('border-gray-200');
                    } else {
                        this.classList.remove('border-gray-200', 'border-gray-400');
                        this.classList.add('border-black');
                    }
                };

                if (nameEl) {
                    nameEl.innerText = formatClubName(currentUser.club) || "Mon Club";
                    nameEl.className = "font-bold text-gray-700 text-lg";
                }

                if (addrEl) {
                    // RESTORE ADDRESS DISPLAY (User Request)
                    // If stadiumAddress is available, show it, otherwise show location
                    addrEl.innerText = currentUser.stadiumAddress || currentUser.location || "";
                    addrEl.style.display = 'block';
                    addrEl.className = "text-xs text-gray-500 mt-1";
                }
                if (logoEl) logoEl.src = '/static/realistic_ball.jpg';

            } else if (currentUser.siret || currentUser.clubId) {
                // RECOVERY: We have ID but no Name. Use API to fetch and show card.
                console.log("‚ôªÔ∏è Recovery: Fetching club data from ID...");
                const s = currentUser.siret || currentUser.clubId;
                // Force lookup to populate UI (requires API)
                performSiretLookup(s, 'create');

            } else {
                // FALLBACK: Ensure Input is visible if no club data
                if (siretInput) {
                    siretInput.classList.remove('hidden');
                    const parentGroup = siretInput.parentNode;
                    if (parentGroup) parentGroup.classList.remove('hidden');
                }
                if (info) info.classList.add('hidden');
            }

            // Fill validation/hidden fields
            if (stadiumInput) {
                // RESTORE ADDRESS: Direct profile address or fallback to club location
                stadiumInput.value = currentUser.stadiumAddress || currentUser.location || "";
            }
            if (clubNameHidden) clubNameHidden.value = currentUser.club || '';
            if (clubIdHidden) clubIdHidden.value = currentUser.siret || '';
            if (locationHidden) locationHidden.value = currentUser.location || '';

            // RESTORE COORDINATES
            const latHidden = document.getElementById('createLocationLat');
            const lngHidden = document.getElementById('createLocationLng');
            if (latHidden) latHidden.value = currentUser.latitude || '';
            if (lngHidden) lngHidden.value = currentUser.longitude || '';

            // FORCE populate contact/info even if they have initial values
            if (emailInput && currentUser.email) emailInput.value = currentUser.email;

            if (phoneInput && currentUser.phone) phoneInput.value = currentUser.phone;

            if (catInput && currentUser.category) catInput.value = currentUser.category;

            if (levelInput && currentUser.level) levelInput.value = currentUser.level;

            // --- SEARCH FORM POPULATION ---
            if (searchLocationInput && currentUser.location) {
                searchLocationInput.value = currentUser.location;
            }
            if (searchCatInput && currentUser.category) {
                searchCatInput.value = currentUser.category;
            }
            if (searchLevelInput && currentUser.level) {
                searchLevelInput.value = currentUser.level;
            }
        }

        function openLoginModal() {
            const el = document.getElementById('loginModal');
            if (el) {
                const modal = new bootstrap.Modal(el);
                modal.show();
            }
        }

        function openProfileModal() {
            const el = document.getElementById('profileModal');
            if (el) {
                const modal = new bootstrap.Modal(el);
                modal.show();
            }
        }

        function openCalendarModal() {
            const el = document.getElementById('calendarModal');
            if (el) {
                const modal = new bootstrap.Modal(el);
                modal.show();
                renderCalendar();
            }
        }

        function openDetailsModal() {
            const el = document.getElementById('detailsModal');
            if (el) {
                const modal = new bootstrap.Modal(el);
                modal.show();
            }
        }

        function openQuickCreateModal() {
            const el = document.getElementById('quickCreateModal');
            if (el) {
                const modal = new bootstrap.Modal(el);
                modal.show();
            }
        }

        function openRegisterModal() {
            // Fermer Login si ouvert
            closeLoginModal();
            closeAllModals(); // Par pr√©caution

            const el = document.getElementById('registerModal');
            if (el) {
                el.classList.remove('hidden');
            }
        }

        // === MODAL CONTROL FUNCTIONS ===
        function closeRegisterModal() {
            const el = document.getElementById('registerModal');
            if (el) {
                el.classList.add('hidden');
            }
        }

        function closeLoginModal() {
            const el = document.getElementById('loginModal');
            if (el) {
                const modal = bootstrap.Modal.getInstance(el);
                if (modal) modal.hide();
                // Fallback direct si instance perdue (souvent le cas avec les modales dynamiques)
                el.classList.remove('show');
                el.style.display = 'none';
                document.body.classList.remove('modal-open');
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(b => b.remove());
            }
        }

        function closeAllModals() {
            // Liste de toutes les modales possibles
            const bootstrapModals = ['quickCreateModal', 'loginModal', 'profileModal', 'calendarModal', 'detailsModal'];
            bootstrapModals.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const instance = bootstrap.Modal.getInstance(el);
                    if (instance) instance.hide();
                }
            });

            // Fermer aussi la nouvelle modal Register (Tailwind)
            closeRegisterModal();
        }

        function switchModal(fromId, toId) {
            closeAllModals();
            setTimeout(() => {
                if (toId === 'registerModal') openRegisterModal();
                else if (toId === 'loginModal') openLoginModal();
            }, 200);
        }

        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (!input) return;

            const icon = btn.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                if (icon) {
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                }
            } else {
                input.type = 'password';
                if (icon) {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            const users = JSON.parse(localStorage.getItem('scUsers') || '[]');
            const user = users.find(u => u.email === email && u.password === pass);

            if (user) {
                console.log("‚úÖ Authenticated as:", user.firstname, user.lastname);
                loginUser(user);
                showSuccess(`Bon retour, Coach ${user.firstname || 'Sportif'} !`);
                closeLoginModal();
            } else {
                showError("Email ou mot de passe incorrect.");
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const titleCase = (str) => str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            const firstname = titleCase(document.getElementById('regFirstName').value.trim());
            const lastname = titleCase(document.getElementById('regLastName').value.trim());
            const siret = document.getElementById('regSiret').value.trim();
            const location = document.getElementById('regLocation').value;
            const club = document.getElementById('regClubHidden').value; // FIX: Use new unique ID
            const clubId = document.getElementById('regClubId').value;
            const email = document.getElementById('regEmail').value.trim();
            const licenseId = document.getElementById('regLicenseId').value.trim();
            const stadiumAddress = document.getElementById('regStadiumAddress').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const category = document.getElementById('regCategory').value.trim(); // Nouveau
            const level = document.getElementById('regLevel').value.trim();       // Nouveau
            const latitude = document.getElementById('regLat').value;
            const longitude = document.getElementById('regLng').value;
            const password = document.getElementById('regPass').value;

            if (!firstname || !lastname || !email || !password) {
                return showError("Veuillez remplir votre nom, email et mot de passe.");
            }

            if (!category || !level) {
                return showError("La cat√©gorie et le niveau sont obligatoires pour compl√©ter votre profil.");
            }

            if (!siret) {
                return showError("Le SIRET de votre club est requis pour l'inscription.");
            }

            if (!club || !location) {
                return showError("Nous n'avons pas pu identifier votre club. Veuillez v√©rifier le SIRET saisi.");
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return showError("Cette adresse email ne semble pas valide.");
            }

            if (licenseId && !/^\d{10}$/.test(licenseId)) {
                return showError("Le num√©ro de licence doit comporter 10 chiffres.");
            }

            if (!phone) {
                return showError("Le num√©ro de t√©l√©phone est obligatoire.");
            }

            let strength = 0;
            if (password.length >= 6) strength += 20;
            if (password.length >= 10) strength += 20;
            if (/[A-Z]/.test(password)) strength += 20;
            if (/[0-9]/.test(password)) strength += 20;
            if (/[^A-Za-z0-9]/.test(password)) strength += 20;

            if (strength < 40) { // On r√©duit un peu la s√©v√©rit√© pour la d√©mo
                return showError("Mot de passe trop simple. Ajoutez des chiffres ou majuscules.");
            }

            const users = JSON.parse(localStorage.getItem('scUsers') || '[]');
            if (users.find(u => u.email === email)) {
                return showError("Cet email est d√©j√† enregistr√© !");
            }

            const newUser = {
                id: 'user_' + Date.now(),
                firstname,
                lastname,
                siret,
                location,
                club,
                clubId,
                email,
                phone,
                licenseId,
                category, // Nouveau
                level,    // Nouveau
                password,
                stadiumAddress,
                latitude,
                longitude,
                subscription: 'Free',
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('scUsers', JSON.stringify(users));

            closeRegisterModal();
            loginUser(newUser);
            showView('match');
            showSuccess("Compte cr√©√© avec succ√®s ! Bienvenue Coach.");
        }

        // Global state
        // Global state (init if not handled below)
        if (typeof userFavorites === 'undefined') {
            window.userFavorites = JSON.parse(localStorage.getItem('scFavorites') || '[]');
        }

        // Suppression du doublon checkLoginBeforeAction (consolid√© √† la ligne 1496)

        function loginUser(user) {
            if (!user) return;
            currentUser = user;
            CURRENT_USER_ID = user.id;
            localStorage.setItem('scCurrentUser', JSON.stringify(user));
            updateAuthUI();

            // NOUVEAU: Prefill form as soon as logged in
            prefillMatchForm();

            // Re-render les listes pour prendre en compte le nouvel ID (pour "Mes Matchs")
            renderMyMatches();
            renderMatchList();

            // Assurer la fermeture de tous les modals (Login/Register/Direct callback)
            closeAllModals();
        }

        function handleLogout() {
            currentUser = null;
            CURRENT_USER_ID = 'user_guest'; // Retour au guest par d√©faut
            localStorage.removeItem('scCurrentUser');

            // UI Updates
            updateAuthUI();
            prefillMatchForm(); // Clear the form fields

            showSuccess("Vous avez √©t√© d√©connect√©.");

            // Refresh views
            renderMyMatches();
            renderMatchList();

            showView('match');
        }

        // --- UTILITAIRE DE R√âINITIALISATION (√Ä la demande du coach) ---
        function resetLocalDatabase() {
            if (!confirm("‚ö†Ô∏è ATTENTION : Cela va supprimer TOUS les comptes, matchs cr√©√©s et favoris sur cet appareil. Voulez-vous continuer ?")) {
                return;
            }

            // Purge localStorage
            localStorage.removeItem('scUsers');
            localStorage.removeItem('scCurrentUser');
            localStorage.removeItem('scFavorites');
            localStorage.removeItem('scMatches');
            localStorage.removeItem('smartCoachHistory');

            showSuccess("Base de donn√©es r√©initialis√©e ! Red√©marrage...");

            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function updateAuthUI() {
            const guestArea = document.getElementById('authGuestArea');
            const userArea = document.getElementById('authUserArea');
            const nameEl = document.getElementById('userName');

            if (!guestArea || !userArea) return;

            if (currentUser) {
                // UI: Switch Guest -> User
                guestArea.classList.add('hidden');
                guestArea.classList.remove('d-flex');
                guestArea.style.display = 'none';

                userArea.classList.remove('hidden');
                userArea.classList.add('flex');
                userArea.style.display = 'flex';

                // Gestion dynamique du Titre de l'onglet selon l'abonnement
                const plan = currentUser.subscription || 'Free'; // Free, Pro, Ultime
                let titleSuffix = "Starter";

                if (plan === 'Pro') titleSuffix = "Pro";
                else if (plan === 'Ultime') titleSuffix = "Ultime";
                else titleSuffix = "Free"; // ou "Starter"

                document.title = `KduFoot ${titleSuffix}`;

                if (nameEl) {
                    nameEl.style.cursor = 'pointer';
                    nameEl.onclick = openProfileModal;

                    const fn = currentUser.firstname || 'Coach';
                    const ln = currentUser.lastname || '';
                    const initials = (fn.charAt(0) + (ln ? ln.charAt(0) : fn.charAt(1) || '')).toUpperCase();

                    // Affichage du Badge Abonnement
                    let badgeColor = "bg-gray-100 text-gray-500";
                    if (plan === 'Pro') badgeColor = "bg-blue-100 text-blue-600";
                    if (plan === 'Ultime') badgeColor = "bg-purple-100 text-purple-600 border border-purple-200";

                    nameEl.innerHTML = `
                        <div class="flex items-center gap-2 px-3 py-2 rounded-full hover:bg-gray-100 transition">
                            <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold">
                                ${initials}
                            </div>
                            <div class="flex flex-col items-start leading-none">
                                <span class="font-bold text-gray-700 text-sm tracking-tight">${fn} ${ln}</span>
                                <div class="flex gap-1 mt-0.5">
                                    <span class="text-[9px] font-black uppercase tracking-widest px-1.5 rounded ${badgeColor}">${plan}</span>
                                    ${currentUser.licenseId ? `<span class="text-[9px] text-gray-300 font-mono">| LIC: ${currentUser.licenseId}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Update Profile Modal Data
                const pInit = document.getElementById('profileInitials');
                const pName = document.getElementById('profileName');
                const pEmail = document.getElementById('profileEmail');
                const pLicence = document.getElementById('profileLicence');
                const pClub = document.getElementById('profileClub');
                const pCity = document.getElementById('profileCity');
                const pAddress = document.getElementById('profileAddress');
                const pPhone = document.getElementById('profilePhone');
                const pCat = document.getElementById('profileCategory');
                const pLevel = document.getElementById('profileLevel');

                if (pInit) pInit.innerText = ((currentUser.firstname || 'C').charAt(0) + (currentUser.lastname || 'H').charAt(0)).toUpperCase();
                if (pName) pName.innerText = `${currentUser.firstname || ''} ${currentUser.lastname || ''}`.trim() || 'Coach';
                if (pEmail) pEmail.innerText = currentUser.email || '--';
                if (pLicence) pLicence.innerText = currentUser.licenseId || '--';
                if (pClub) pClub.innerText = currentUser.club || '--';
                if (pCity) pCity.innerText = currentUser.location || '--';
                if (pAddress) pAddress.innerText = currentUser.stadiumAddress || '--';
                if (pPhone) pPhone.innerText = currentUser.phone || '--';
                if (pCat) pCat.innerText = currentUser.category || '--';
                if (pLevel) pLevel.innerText = currentUser.level || '--';

            } else {
                // GUEST MODE
                document.title = "KduFoot - Le Football Connect√©";

                guestArea.classList.remove('hidden');
                guestArea.classList.add('d-flex');
                guestArea.style.display = 'flex';

                userArea.classList.add('hidden');
                userArea.classList.remove('flex');
                userArea.style.display = 'none';

                if (document.getElementById('profileName')) {
                    document.getElementById('profileName').innerHTML = 'Coach';
                    document.getElementById('profileName').onclick = openLoginModal;
                }
            }
        }

        function simulateExternalLogin(platform) {
            showSuccess(`Redirection vers ${platform}...`);
            setTimeout(() => {
                window.location.href = `/ auth / login / ${platform} `;
            }, 800);
        }

        function checkAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('auth_success') === 'true') {
                const provider = urlParams.get('provider');

                const realUser = {
                    id: urlParams.get('user_id'),
                    firstname: urlParams.get('firstname'),
                    lastname: urlParams.get('lastname'),
                    club: urlParams.get('club'),
                    email: urlParams.get('email')
                };

                loginUser(realUser);

                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);

                setTimeout(() => {
                    showSuccess(`Connect√© avec succ√®s via ${provider} ! üöÄ`);
                }, 500);
            }
        }

        function checkPasswordStrength(password) {
            const bar = document.getElementById('passwordStrengthBar');
            const text = document.getElementById('passwordStrengthText');
            const container = document.getElementById('passwordStrengthBarContainer');

            if (!password) {
                container.classList.add('opacity-0');
                text.innerText = '';
                return;
            }

            container.classList.remove('opacity-0');
            let strength = 0;
            if (password.length >= 6) strength += 20;
            if (password.length >= 10) strength += 20;
            if (/[A-Z]/.test(password)) strength += 20;
            if (/[0-9]/.test(password)) strength += 20;
            if (/[^A-Za-z0-9]/.test(password)) strength += 20;

            bar.style.width = strength + '%';

            if (strength <= 40) {
                bar.className = 'h-full transition-all duration-500 bg-red-500';
                text.innerText = 'Faible';
                text.className = 'text-[9px] font-black uppercase mt-1 text-red-500';
            } else if (strength <= 70) {
                bar.className = 'h-full transition-all duration-500 bg-orange-500';
                text.innerText = 'moyen';
                text.className = 'text-[9px] font-black uppercase mt-1 text-orange-500';
            } else {
                bar.className = 'h-full transition-all duration-500 bg-green-500';
                text.innerText = 'robuste';
                text.className = 'text-[9px] font-black uppercase mt-1 text-green-500';
            }
        }

        // ==========================================
        // NOUVELLE LOGIQUE INSCRIPTION : VILLE -> CLUB
        // ==========================================

        // 1. Autocomplete VILLE
        const regCityInput = document.getElementById('regCityInput');
        const regCitySuggestions = document.getElementById('regCitySuggestions');

        if (regCityInput) {
            regCityInput.addEventListener('input', async function () {
                const query = this.value;
                if (query.length < 2) {
                    regCitySuggestions.classList.add('hidden');
                    return;
                }

                try {
                    const res = await fetch(`/ api / v2 / cities ? q = ${encodeURIComponent(query)} `);
                    const cities = await res.json();

                    regCitySuggestions.innerHTML = '';
                    if (cities.length > 0) {
                        cities.forEach(city => {
                            const div = document.createElement('div');
                            div.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm font-bold text-gray-700 border-b border-gray-50 last:border-0';
                            div.textContent = city;
                            div.onclick = () => selectCity(city);
                            regCitySuggestions.appendChild(div);
                        });
                        regCitySuggestions.classList.remove('hidden');
                    } else {
                        regCitySuggestions.classList.add('hidden');
                    }
                } catch (e) {
                    console.error("Erreur ville:", e);
                }
            });
        }

        function selectCity(city) {
            document.getElementById('regCityInput').value = city;
            document.getElementById('regCitySelected').value = city;
            regCitySuggestions.classList.add('hidden');

            // Affiche le champ Club
            document.getElementById('regClubField').classList.remove('hidden');
            document.getElementById('regClubInput').value = '';
            document.getElementById('regAddressField').classList.add('hidden');

            // Focus club
            setTimeout(() => document.getElementById('regClubInput').focus(), 100);
        }

        // 2. Autocomplete CLUB (bas√© sur la ville s√©lectionn√©e)
        const regClubInput = document.getElementById('regClubInput');
        const regClubSuggestions = document.getElementById('regClubSuggestions');

        if (regClubInput) {
            regClubInput.addEventListener('focus', loadClubsForCity); // Charger d√®s le focus si possible

            regClubInput.addEventListener('input', function () {
                filterClubs(this.value);
            });

            // Validation stricte du club √† la saisie (blur)
            regClubInput.addEventListener('blur', () => {
                // Petit timeout pour laisser le click sur la suggestion se faire
                setTimeout(() => {
                    const val = regClubInput.value.trim().toUpperCase();
                    if (!val) return;

                    // On v√©rifie si ce nom existe EXACTEMENT dans la liste de la ville
                    const match = currentCityClubs.find(c => c.nom.toUpperCase() === val);

                    if (match) {
                        // C'est bon, on (re)s√©lectionne proprement
                        selectClub(match);
                        regClubInput.classList.remove('border-red-500', 'bg-red-50');
                        regClubInput.classList.add('border-green-500', 'bg-green-50');
                    } else {
                        // Pas trouv√© -> Erreur
                        // On laisse l'input mais on vide l'ID pour bloquer l'envoi valide
                        document.getElementById('regClubId').value = "";
                        regClubInput.classList.remove('border-green-500', 'bg-green-50');
                        regClubInput.classList.add('border-red-500', 'bg-red-50');
                    }
                }, 200);
            });
        }

        let currentCityClubs = [];

        async function loadClubsForCity() {
            const city = document.getElementById('regCitySelected').value;
            if (!city) return;

            try {
                // On charge TOUS les clubs de la ville (souvent < 100)
                const res = await fetch(`/ api / v2 / clubs - by - city ? city = ${encodeURIComponent(city)} `);
                currentCityClubs = await res.json();
                filterClubs(''); // Affiche tout au d√©but
            } catch (e) {
                console.error("Erreur clubs:", e);
            }
        }

        function filterClubs(query) {
            if (!currentCityClubs.length) return;

            const q = query.toUpperCase().trim();

            // MODIFICATION: On ne montre RIEN si l'utilisateur n'a rien tap√©
            if (!q) {
                regClubSuggestions.classList.add('hidden');
                return;
            }

            const tokens = q.split(/\s+/).filter(t => t.length > 0);

            // Filtrage "Smart" : On veut que TOUS les mots tap√©s se retrouvent dans le nom ou l'adresse
            // Ex: "Etoile Bully" doit matcher "Etoile Sportive de Bully"
            const filtered = currentCityClubs.filter(c => {
                const name = c.nom.toUpperCase();
                // On v√©rifie que chaque token est pr√©sent dans le NOM
                // Pour une UX parfaite: on pourrait aussi chercher dans l'adresse, mais restons sur le nom pour l'instant
                return tokens.every(token => name.includes(token));
            });

            regClubSuggestions.innerHTML = '';
            if (filtered.length > 0) {
                regClubSuggestions.classList.remove('hidden');
                // Max 50 pour pas faire ramer
                filtered.slice(0, 50).forEach(club => {
                    const div = document.createElement('div');
                    div.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-50 last:border-0';
                    div.innerHTML = `<div class="font-bold text-gray-800">${club.nom}</div><div class="text-xs text-gray-500 truncate">${club.adresse}</div>`;
                    div.onclick = () => selectClub(club);
                    regClubSuggestions.appendChild(div);
                });
            } else {
                regClubSuggestions.innerHTML = '<div class="px-4 py-2 text-sm text-gray-400 italic">Aucun club trouv√©. V√©rifiez l\'orthographe ou essayez moins de mots.</div>';
                regClubSuggestions.classList.remove('hidden');
            }
        }

        function selectClub(club) {
            const input = document.getElementById('regClubInput');
            if (input) input.value = club.nom;

            // FIX: Target the correct hidden field expected by handleRegister ('regClubHidden')
            const clubHidden = document.getElementById('regClubHidden');
            if (clubHidden) clubHidden.value = club.nom;

            /* Legacy/Backup ID if needed, but regClubHidden is the key one */
            const clubNameId = document.getElementById('regClubName');
            if (clubNameId) clubNameId.value = club.nom;

            const clubIdHidden = document.getElementById('regClubId');
            if (clubIdHidden) clubIdHidden.value = club.id;

            regClubSuggestions.classList.add('hidden');

            // FIX: Unhide Address Field if hidden (Tailwind 'hidden')
            const addrField = document.getElementById('regAddressField'); // Assurez-vous que cet ID existe ou ajustez
            // Si pas de regAddressField ds le DOM, on s'assure juste que l'input est visible s'il √©tait cach√©
            const addrInput = document.getElementById('regStadiumAddress'); // FIX: Use 'regStadiumAddress' instead of 'regAddress'

            if (addrInput) {
                // If it was readonly/hidden, make it editable or just fill it
                addrInput.classList.remove('hidden');

                // Formatage propre : Adresse, Cp Ville
                let fullAddr = club.adresse || '';
                if (club.cp && !fullAddr.includes(club.cp)) fullAddr += ' ' + club.cp;
                if (club.ville && !fullAddr.toUpperCase().includes(club.ville.toUpperCase())) fullAddr += ' ' + club.ville;

                // Fallback location
                const cityVal = document.getElementById('regCitySelected')?.value || '';

                addrInput.value = fullAddr.trim() || (cityVal + ", France");

                // Visual feedback
                addrInput.classList.add('bg-green-50', 'text-green-700');
                setTimeout(() => addrInput.classList.remove('bg-green-50', 'text-green-700'), 1000);
            }
        }

        // Override handleRegister pour inclure les nouveaux champs si besoin
        // (Note: La fonction handleRegister existante envoyait tout le formulaire, 
        // on doit s'assurer que le backend re√ßoit bien 'club_name' et 'address' s'il les attendait)
        // ============================================
        // STRIPE PAYMENT LOGIC
        // ============================================
        // Initialisation avec la cl√© publique pass√©e par Flask
        const stripePK = '{{ stripe_pk }}';
        let stripe = null;
        if (stripePK && stripePK !== 'None') {
            stripe = Stripe(stripePK);
        }

        function handlePayment() {
            if (!stripe) {
                showSuccess("Paiement non configur√© (Cl√© manquante).");
                return;
            }

            showSuccess("Redirection vers le paiement s√©curis√©... üí≥");

            fetch('/create-checkout-session', {
                method: 'POST',
            })
                .then(function (response) {
                    return response.json();
                })
                .then(function (session) {
                    if (session.error) {
                        showSuccess("Erreur configuration: " + session.error);
                    } else {
                        return stripe.redirectToCheckout({ sessionId: session.id });
                    }
                })
                .then(function (result) {
                    if (result && result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                    showSuccess("Erreur technique lors du paiement.");
                });
        }

        // Initialisation UI
        document.addEventListener('DOMContentLoaded', () => {
            // checkAuthCallback(); // Removed as it is not defined and blocks execution
            updateAuthUI();

            // Setup Autocompletes (Global)
            setupAutocomplete('searchLocation');

            // SIRET Lookup Initialization (Global)
            setupSiretLookup();

            // Note: setupClubAutocomplete for create/reg are removed 
            // as they are now handled by SIRET lookup

            // Set initial view
            showView('match');
            switchMatchTab('create');

            // Real-time cleanup & initial renders
            cleanExpiredMatches();
            renderMyMatches();
        });



        function openQuickModal() {
            const flags = document.getElementById('featureFlags');
            if (flags && flags.getAttribute('data-show-ai') !== 'true') {
                showSuccess("üöÄ L'IA de g√©n√©ration de s√©ance arrive tr√®s bient√¥t. Restez connect√©s !");
                return;
            }
            var myModal = new bootstrap.Modal(document.getElementById('quickCreateModal'));
            myModal.show();
        }

        function parseSynopsis(text) {
            if (!text) return [];

            const categories = [
                { keyword: "MISE EN PLACE", icon: "fas fa-map-marker-alt", border: "border-l-4 border-blue-500 bg-blue-50", text: "text-blue-700" },
                { keyword: "D√âMARRAGE", icon: "fas fa-play-circle", border: "border-l-4 border-green-500 bg-green-50", text: "text-green-700" },
                { keyword: "CONSIGNES", icon: "fas fa-list-ol", border: "border-l-4 border-pink-500 bg-pink-50", text: "text-pink-700" },
                { keyword: "R√àGLES", icon: "fas fa-exclamation-triangle", border: "border-l-4 border-red-500 bg-red-50", text: "text-red-700" },
                { keyword: "VARIABLES", icon: "fas fa-sliders-h", border: "border-l-4 border-orange-500 bg-orange-50", text: "text-orange-700" },
                { keyword: "VARIANTES", icon: "fas fa-sliders-h", border: "border-l-4 border-orange-500 bg-orange-50", text: "text-orange-700" },
                { keyword: "ROTATION", icon: "fas fa-sync-alt", border: "border-l-4 border-purple-500 bg-purple-50", text: "text-purple-700" },
                { keyword: "FIN", icon: "fas fa-sync-alt", border: "border-l-4 border-purple-500 bg-purple-50", text: "text-purple-700" }
            ];

            const lines = text.split('\n');
            const sections = [];

            let currentTitle = "DESCRIPTION";
            let currentContent = [];
            let inCodeBlock = false;

            // Regex stricte pour les titres (### TITRE)
            const headerRegex = /^\s*#{1,6}\s*(.*)/;

            lines.forEach((line) => {
                const trimmed = line.trim();

                // Gestion des blocs de code
                if (trimmed.startsWith('```')) {
                    inCodeBlock = !inCodeBlock;
                }

                // D√©tection de nouveau titre (seulement HORS des blocs de code)
                let isHeader = false;
                let newTitleCandidate = "";

                if (!inCodeBlock) {
                    const match = line.match(headerRegex);
                    if (match) {
                        newTitleCandidate = match[1].toUpperCase();
                        // Est-ce un de nos mots cl√©s ?
                        const validCategory = categories.find(c => newTitleCandidate.includes(c.keyword));
                        if (validCategory) {
                            isHeader = true;
                            // On normalise le titre sur le mot cl√© trouv√©
                            newTitleCandidate = validCategory.keyword;
                        }
                    }
                }

                if (isHeader) {
                    // On sauvegarde la section pr√©c√©dente
                    if (currentContent.length > 0 || currentTitle !== "DESCRIPTION") {
                        const tUp = currentTitle.toUpperCase();
                        const catInfo = categories.find(c => tUp.includes(c.keyword)) || {
                            icon: "fas fa-info-circle",
                            border: "border-l-4 border-gray-400 bg-gray-50",
                            text: "text-gray-700"
                        };

                        sections.push({
                            title: currentTitle,
                            content: currentContent.join('\n').trim(),
                            icon: catInfo.icon,
                            borderClass: catInfo.border,
                            titleColor: catInfo.text
                        });
                    }
                    // On d√©marre la nouvelle section
                    currentTitle = newTitleCandidate;
                    currentContent = [];
                } else {
                    currentContent.push(line);
                }
            });

            // Sauvegarde de la derni√®re section
            if (currentContent.length > 0 || currentTitle !== "DESCRIPTION") { // Fix: Ensure last section is saved even if it's the default DESCRIPTION
                const tUp = currentTitle.toUpperCase();
                const catInfo = categories.find(c => tUp.includes(c.keyword)) || {
                    icon: "fas fa-info-circle",
                    border: "border-l-4 border-gray-400 bg-gray-50",
                    text: "text-gray-700"
                };
                sections.push({
                    title: currentTitle,
                    content: currentContent.join('\n').trim(),
                    icon: catInfo.icon,
                    borderClass: catInfo.border,
                    titleColor: catInfo.text
                });
            }

            // Nettoyage : filtre les sections vides sauf si c'est la seule
            if (sections.length > 1) {
                return sections.filter(s => s.content.length > 0);
            }
            return sections;
        }

        function renderInfoCards(d) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 flex items-start gap-4 shadow-sm">
                        <i class="fas fa-ruler-combined text-blue-500 shrink-0 mt-1 text-lg"></i>
                        <div class="flex-grow">
                            <span class="text-[13px] text-blue-400 font-black uppercase block leading-none mb-2 tracking-[0.15em]">ESPACE</span>
                            <div class="text-[14px] font-bold text-blue-900 leading-snug break-words whitespace-pre-wrap">${d.dimensions || '?'}</div>
                        </div>
                    </div>
                    <div class="bg-green-50 border border-green-100 rounded-xl p-4 flex items-start gap-4 shadow-sm">
                        <i class="fas fa-users text-green-500 shrink-0 mt-1 text-lg"></i>
                        <div class="flex-grow">
                            <span class="text-[13px] text-green-400 font-black uppercase block leading-none mb-2 tracking-[0.15em]">JOUEURS</span>
                            <div class="text-[14px] font-bold text-green-900 leading-snug break-words whitespace-pre-wrap">${d.nb_joueurs_exact || '?'}</div>
                        </div>
                    </div>
                    <div class="bg-orange-50 border border-orange-100 rounded-xl p-4 flex items-start gap-4 shadow-sm">
                        <i class="fas fa-toolbox text-orange-500 shrink-0 mt-1 text-lg"></i>
                        <div class="flex-grow">
                            <span class="text-[13px] text-orange-400 font-black uppercase block leading-none mb-2 tracking-[0.15em]">MAT√âRIEL</span>
                            <div class="text-[14px] font-bold text-orange-900 leading-snug break-words whitespace-pre-wrap">${d.materiel_detail || '?'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStepCards(synopsis) {
            const steps = parseSynopsis(synopsis);
            if (steps.length === 0) return `<div class="p-4 bg-blue-50 border-l-4 border-primary rounded-xl shadow-sm text-gray-700 leading-relaxed">${formatText(synopsis)}</div>`;

            let html = `<div class="space-y-3">`;
            steps.forEach(step => {
                // Map colors to match Info Cards exactly
                let labelColor = "text-gray-400";
                let contentColor = "text-gray-900";
                let iconBg = "bg-white bg-opacity-80";

                if (step.titleColor.includes("blue")) { labelColor = "text-blue-400"; contentColor = "text-blue-900"; }
                else if (step.titleColor.includes("green")) { labelColor = "text-green-400"; contentColor = "text-green-900"; }
                else if (step.titleColor.includes("purple") || step.titleColor.includes("pink")) { labelColor = "text-pink-400"; contentColor = "text-pink-900"; }
                else if (step.titleColor.includes("orange")) { labelColor = "text-orange-400"; contentColor = "text-orange-900"; }
                else if (step.titleColor.includes("red")) { labelColor = "text-red-400"; contentColor = "text-red-900"; }

                html += `
                    <div class="${step.borderClass} border border-opacity-30 rounded-lg p-3 flex items-start gap-4 shadow-sm transition-all hover:shadow-md">
                        <div class="w-9 h-9 rounded-full ${iconBg} flex items-center justify-center shrink-0 shadow-sm border border-current ${step.titleColor}">
                            <i class="${step.icon} text-[13px]"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <span class="text-[17px] ${labelColor} font-black uppercase block leading-none mb-3 tracking-[0.2em] border-b-2 border-current border-opacity-10 pb-2">${step.title}</span>
                            <div class="text-[16px] font-bold ${contentColor} leading-relaxed break-words whitespace-pre-wrap">${formatText(step.content)}</div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        function openDeroulementModal(videoId) {
            const video = allVideosMap[videoId];
            if (!video) return;

            const d = video.data;
            const content = document.getElementById('deroulementContent');

            // Header
            let html = `
                <div class="mb-6 text-center">
                    <h4 class="fw-bold text-gray-800 text-2xl mb-3">${d.summary || video.title}</h4>
                    <div class="d-flex flex-wrap justify-center gap-2 mb-3">
            `;
            const themes = d.themes || (d.theme_force ? [d.theme_force] : ["TECHNIQUE"]);
            themes.forEach(t => { html += `<span class="badge ${getThemeColor(t)}" style="font-size: 11px; padding: 6px 12px;">${t}</span>`; });
            html += `</div></div>`;

            // Info Grid (Top) - Horizontal Colored Cards
            html += `
                <div class="grid grid-cols-1 gap-3 mb-8">
                    <!-- Dur√©e -->
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 flex items-center gap-4 shadow-sm">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 shrink-0">
                            <i class="fas fa-clock text-lg"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center gap-2">
                                <span class="text-[13px] text-blue-400 font-black tracking-widest uppercase leading-none">DUR√âE</span>
                            </div>
                            <div class="font-bold text-blue-900 text-xl leading-tight uppercase font-black">${d.duree_totale || '15 min'}</div>
                            ${d.timing_detail_pro ? `<div class="text-[12px] text-blue-600 font-black opacity-80 mt-1 uppercase tracking-tighter">${d.timing_detail_pro}</div>` : ''}
                        </div>
                    </div>

                    <!-- Joueurs -->
                    <div class="bg-green-50 border border-green-100 rounded-xl p-3 flex items-center gap-4 shadow-sm">
                        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 shrink-0">
                            <i class="fas fa-users text-lg"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center gap-2">
                                <span class="text-[13px] text-green-400 font-black tracking-widest uppercase leading-none">JOUEURS</span>
                            </div>
                            <div class="font-bold text-green-900 text-lg leading-snug break-words font-black">
                                ${d.nb_joueurs_exact || '?'}
                            </div>
                        </div>
                    </div>

                    <!-- Espace -->
                    <div class="bg-purple-50 border border-purple-100 rounded-xl p-3 flex items-center gap-4 shadow-sm">
                        <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 shrink-0">
                            <i class="fas fa-ruler-combined text-lg"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center gap-2">
                                <span class="text-[13px] text-purple-400 font-black tracking-widest uppercase leading-none">ESPACE</span>
                            </div>
                            <div class="font-bold text-purple-900 text-lg leading-snug break-words font-black">
                                ${d.dimensions || '?'}
                            </div>
                        </div>
                    </div>

                    <!-- Mat√©riel -->
                    <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 flex items-center gap-4 shadow-sm">
                        <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 shrink-0">
                            <i class="fas fa-toolbox text-lg"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center gap-2">
                                <span class="text-[13px] text-orange-400 font-black tracking-widest uppercase leading-none">MAT√âRIEL</span>
                            </div>
                            <div class="font-bold text-orange-900 text-lg leading-snug break-words font-black">
                                ${d.materiel_detail || '?'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Global Description (Beginner Friendly)
            html += `
                <div class="mt-4 p-5 bg-gray-50/80 rounded-xl border border-gray-100 mb-8">
                    <h5 class="font-black text-xs text-gray-500 mb-2 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-info-circle"></i> S√âQUENCE VID√âO
                    </h5>
                    <div class="text-base text-gray-700 italic leading-relaxed">
                        ${d.video_description || "Description non disponible."}
                    </div>
                </div>

                <!-- FULL DETAIL STEP CARDS (Including SVG) -->
                <div class="border-t-2 border-dashed border-gray-200 pt-8">
                    <h4 class="font-black text-xl text-secondary mb-6 flex items-center gap-3">
                        <i class="fas fa-clipboard-check text-primary"></i> D√âROULEMENT COMPLET
                    </h4>
                    <div class="space-y-6">
                        ${(function () {
                    // Force rendering of the full synopsis which contains headers and SVG
                    return renderStepCards(d.synopsis || "");
                })()}
                    </div>
                </div>
            `;

            content.innerHTML = html;
            let link = video.link;
            if (d.start_seconds && d.start_seconds > 0) link += (link.includes('?') ? '&' : '?') + "t=" + Math.floor(d.start_seconds);
            document.getElementById('deroulementVideoLink').href = link;
            var modal = new bootstrap.Modal(document.getElementById('deroulementModal'));
            modal.show();
        }

        // --- CONFIGURATION DES TH√àMES (Source de v√©rit√©) ---
        const THEME_CONFIG = {
            'TECHNIQUE': { class: "text-blue-600 bg-blue-50 border-blue-300", filter: "text-blue-600" },
            'PHYSIQUE': { class: "text-orange-600 bg-orange-50 border-orange-300", filter: "text-orange-600" },
            'TACTIQUE': { class: "text-purple-600 bg-purple-50 border-purple-300", filter: "text-purple-600" },
            'FINITION': { class: "text-green-600 bg-green-50 border-green-300", filter: "text-green-600" },
            'GARDIEN': { class: "text-yellow-600 bg-yellow-50 border-yellow-300", filter: "text-yellow-600" },
            'JEU': { class: "text-red-600 bg-red-50 border-red-300", filter: "text-red-600" },
            'D√âFENSE': { class: "text-slate-600 bg-slate-50 border-slate-300", filter: "text-slate-600" },
            'ATTAQUE': { class: "text-pink-600 bg-pink-50 border-pink-300", filter: "text-pink-600" },
            'TRANSITION': { class: "text-cyan-600 bg-cyan-50 border-cyan-300", filter: "text-cyan-600" },
            'CONSERVATION': { class: "text-teal-600 bg-teal-50 border-teal-300", filter: "text-teal-600" },
            'PRESSING': { class: "text-rose-600 bg-rose-50 border-rose-300", filter: "text-rose-600" },
            'BLOC D√âFENSIF': { class: "text-green-600 bg-green-50 border-green-300", filter: "text-green-600" },
            'COULISSAGE': { class: "text-yellow-600 bg-yellow-50 border-yellow-300", filter: "text-yellow-600" }
        };

        function getThemeColor(theme) {
            if (!theme) return { class: "text-gray-600 bg-gray-50 border-gray-300", style: "" };
            const t = theme.toUpperCase();

            // 1. V√©rifier si on a une config statique
            if (THEME_CONFIG[t]) {
                return {
                    class: THEME_CONFIG[t].class,
                    filterClass: THEME_CONFIG[t].filter,
                    style: ""
                };
            }

            // 2. Sinon, Fallback HSL (Couleur unique dynamique)
            const hash = generateHash(t);
            const hue = Math.abs(hash % 360);
            return {
                class: "border",
                filterClass: "", // Sera appliqu√© via style pour le filter
                style: `background-color: hsl(${hue}, 85%, 96%); color: hsl(${hue}, 80%, 35%); border-color: hsl(${hue}, 70%, 80%);`,
                filterStyle: `color: hsl(${hue}, 80%, 35%);`
            };
        }

        function generateHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return hash;
        }

        function createCardHTML(vid) {
            const d = vid.data;
            const isFav = favorites.includes(vid.id);
            const inSession = sessionPlaylist.includes(vid.id);

            const duree = d.duree_totale || "15 min";
            const titre = d.summary || vid.title;

            // Support multi-th√®mes
            let themes = d.themes || [];
            if (themes.length === 0 && d.theme_force) themes = [d.theme_force];
            if (themes.length === 0) themes = ["TECHNIQUE"];

            const niveau = d.level_range || "Niveau Libre";
            const categorie = d.cat_range || "Toutes Cat√©gories";
            const materiel = d.materiel_detail || "Non sp√©cifi√©";
            const joueurs = d.nb_joueurs_exact || "Non sp√©cifi√©";
            const dimensions = d.dimensions || "Non sp√©cifi√©";

            let link = vid.link;
            let timestampDisplay = "";
            if (d.start_seconds && d.start_seconds > 0) {
                link += (link.includes('?') ? '&' : '?') + "t=" + Math.floor(d.start_seconds);
                const mins = Math.floor(d.start_seconds / 60);
                const secs = Math.floor(d.start_seconds % 60);
                timestampDisplay = `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            const btnSessionClass = inSession ? "bg-red-50 text-red-600 border-red-200" : "bg-primary text-white border-primary hover:bg-blue-700";
            const btnSessionText = inSession ? "<i class='fas fa-minus'></i>" : "<i class='fas fa-plus'></i> Ajouter";

            // Badges th√®mes
            let themeBadges = themes.map(t => {
                const colorObj = getThemeColor(t);
                return `<span class="theme-badge ${colorObj.class}" style="${colorObj.style}">${t}</span>`;
            }).join('');

            // Dynamic Platform Icon Logic
            let iconClass = "fas fa-external-link-alt";
            let iconColor = "text-gray-600";
            if (link.includes('youtube') || link.includes('youtu.be')) { iconClass = "fab fa-youtube"; iconColor = "text-danger"; }
            else if (link.includes('tiktok')) { iconClass = "fab fa-tiktok"; iconColor = "text-black"; }
            else if (link.includes('instagram')) { iconClass = "fab fa-instagram"; iconColor = "text-pink-600"; }
            else if (link.includes('twitter') || link.includes('x.com')) { iconClass = "fab fa-twitter"; iconColor = "text-blue-400"; }

            return `
            <div class="group h-full flex flex-col">
                <div class="card-custom h-full flex flex-col relative">
                    <div class="card-img-wrapper">
                        <img src="${vid.thumbnail}" class="card-img-top" alt="Thumbnail" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1579952363873-27f3bade9f55?q=80&w=1000&auto=format&fit=crop';">
                        <div class="absolute top-3 right-3 z-30 flex flex-col items-end gap-1">
                            <span class="bg-black/70 backdrop-blur text-white text-xs font-bold px-3 py-1.5 rounded border border-white/20">
                                <i class="fas fa-clock mr-1"></i>${duree}
                            </span>
                            ${d.timing_detail_pro ? `<span class="bg-primary/90 text-white text-[9px] font-black px-2 py-0.5 rounded border border-white/20 uppercase tracking-tighter shadow-sm">${d.timing_detail_pro}</span>` : ''}
                        </div>
                        
                        <div class="card-overlay d-flex align-items-center justify-content-center flex-column gap-2">
                            <a href="${link}" target="_blank" class="btn btn-light btn-lg fw-bold px-5 py-3 shadow-lg" style="text-decoration: none;">
                                <i class="${iconClass} me-2 ${iconColor} fs-5"></i> VOIR LA VID√âO <i class="fas fa-external-link-alt ms-2"></i>
                            </a>
                            ${timestampDisplay ? `<span class="bg-green-500/90 text-white text-xs font-bold px-3 py-1.5 rounded-full"><i class="fas fa-play mr-1"></i>Commence √† ${timestampDisplay}</span>` : ''}
                        </div>
                    </div>

                    <div class="p-5 flex flex-col flex-grow">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex flex-wrap gap-1">
                                ${themeBadges}
                            </div>
                            <button onclick="toggleFavorite(${vid.id})" class="text-xl transition hover:scale-110 ${isFav ? 'text-gold' : 'text-gray-300 hover:text-gold'}">
                                <i class="${isFav ? 'fas' : 'far'} fa-star"></i>
                            </button>
                        </div>

                        <h3 class="font-bold text-gray-800 text-base leading-snug mb-4 line-clamp-2" title="${titre}">
                            ${titre}
                        </h3>

                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-md border border-gray-200 font-semibold" title="Niveau">
                                <i class="fas fa-layer-group mr-1 text-gray-500"></i> ${niveau}
                            </span>
                            <span class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-md border border-gray-200 font-semibold" title="Cat√©gorie">
                                <i class="fas fa-users mr-1 text-gray-500"></i> ${categorie}
                            </span>
                        </div>

                        <div class="info-box flex-grow">
                            <div class="info-row">
                                <i class="fas fa-ruler-combined info-icon text-blue-500"></i>
                                <span class="info-content font-semibold text-gray-700">${dimensions}</span>
                            </div>
                            <div class="info-row">
                                <i class="fas fa-toolbox info-icon text-orange-500"></i>
                                <span class="info-content text-gray-600">${materiel}</span>
                            </div>
                            <div class="info-row">
                                <i class="fas fa-user-friends info-icon text-green-500"></i>
                                <span class="info-content font-bold text-green-700">${joueurs}</span>
                            </div>
                        </div>

                        <div class="mt-auto flex gap-2 pt-3 border-t border-gray-100">
                            <button onclick="openDeroulementModal(${vid.id})" class="flex-1 py-2.5 rounded-lg text-sm font-bold border transition shadow-sm bg-primary text-white border-primary hover:bg-blue-700">
                                <i class="fas fa-list-ul me-1"></i> D√âROULEMENT
                            </button>
                            <button onclick="toggleSession(${vid.id})" class="flex-1 py-2.5 rounded-lg text-sm font-bold border transition shadow-sm ${btnSessionClass}">
                                ${btnSessionText}
                            </button>
                            <button onclick="deleteVideo(${vid.id})" class="w-10 h-10 flex items-center justify-center rounded-lg bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-500 border border-gray-200 transition">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function toggleThemeFilter(checkbox) {
            const theme = checkbox.value;
            if (checkbox.checked) {
                if (!activeThemes.includes(theme)) activeThemes.push(theme);
            } else {
                activeThemes = activeThemes.filter(t => t !== theme);
            }
            renderTags();
            applyFilters();
        }


        function detectAndAddNewThemes() {
            const container = document.getElementById('dynamicThemeFilters');
            if (!container) return;

            // Th√®mes d√©j√† dans le DOM
            const existingThemes = new Set();
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                existingThemes.add(cb.value.toUpperCase());
            });

            // Collecter tous les th√®mes des exercices
            const allThemesFound = new Set();
            Object.values(allVideosMap).forEach(vid => {
                const themes = vid.data?.themes || [];
                themes.forEach(t => allThemesFound.add(t.toUpperCase()));
            });

            // Ajouter les nouveaux th√®mes au container
            allThemesFound.forEach(theme => {
                if (!existingThemes.has(theme)) {
                    const colorObj = getThemeColor(theme);
                    const label = document.createElement('label');
                    label.className = 'cursor-pointer theme-filter-label animate-pulse';
                    label.innerHTML = `
                        <input type="checkbox" value="${theme}" onchange="toggleThemeFilter(this)" class="mr-1">
                        <span class="text-xs font-bold ${colorObj.filterClass || ''}" style="${colorObj.filterStyle || ''}">${theme}</span>
                    `;
                    container.appendChild(label);
                    console.log(`üè∑Ô∏è Nouveau filtre ajout√©: ${theme}`);
                    // Enlever l'animation apr√®s 2 secondes
                    setTimeout(() => label.classList.remove('animate-pulse'), 2000);
                }
            });
        }

        function applyFilters() {
            // D√©tecter d'abord les nouveaux th√®mes
            detectAndAddNewThemes();

            const search = document.getElementById('filterSearch').value.toLowerCase();
            const level = document.getElementById('filterLevel').value;

            const grid = document.getElementById('videoGrid');
            grid.innerHTML = "";
            let count = 0;

            Object.values(allVideosMap).forEach(vid => {
                const d = vid.data;
                let match = true;

                const fullText = (vid.title + " " + (d.synopsis || "")).toLowerCase();
                if (search && !fullText.includes(search)) match = false;
                if (activeKeywords.length > 0 && !activeKeywords.every(k => fullText.includes(k.toLowerCase()))) match = false;

                // Filtre multi-th√®mes
                if (activeThemes.length > 0) {
                    const vidThemes = d.themes || (d.theme_force ? [d.theme_force] : []);
                    const hasMatchingTheme = activeThemes.some(t => vidThemes.includes(t));
                    if (!hasMatchingTheme) match = false;
                }

                // Filtre Niveau
                if (level !== "Tous") {
                    const lStr = (d.level_range || "").toLowerCase();
                    if (level === "D√©butant" && !lStr.includes("d√©butant") && !lStr.includes("u10")) match = false;
                    if (level === "Ligue" && !lStr.includes("ligue") && !lStr.includes("r√©gional")) match = false;
                    if (level === "National" && !lStr.includes("national") && !lStr.includes("n3")) match = false;
                }

                if (match) {
                    grid.innerHTML += createCardHTML(vid);
                    count++;
                }
            });

            if (count === 0) grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400 italic">Aucun exercice trouv√©... Essayez d'autres filtres.</div>`;
        }

        function addSearchTag() {
            const input = document.getElementById('filterSearch');
            const val = input.value.trim();
            if (val) {
                activeKeywords.push(val);
                input.value = "";
                renderTags();
                applyFilters();
            }
        }

        function renderTags() {
            const area = document.getElementById('activeTagsArea');
            area.innerHTML = "";

            activeKeywords.forEach((tag, idx) => {
                area.innerHTML += `<span class="bg-primary text-white px-3 py-1.5 rounded-md text-xs flex items-center gap-2 font-semibold">${tag} <button onclick="activeKeywords.splice(${idx},1); renderTags(); applyFilters();" class="hover:text-red-200 text-lg leading-none">√ó</button></span>`;
            });

            activeThemes.forEach((theme) => {
                const colorObj = getThemeColor(theme);
                area.innerHTML += `<span class="px-3 py-1.5 rounded-md text-xs flex items-center gap-2 font-semibold ${colorObj.class}" style="${colorObj.style}">${theme} <button onclick="activeThemes = activeThemes.filter(t => t !== '${theme}'); document.querySelector('input[value=\\'${theme}\\']').checked = false; renderTags(); applyFilters();" class="hover:opacity-70 text-lg leading-none">√ó</button></span>`;
            });

            if (activeKeywords.length === 0 && activeThemes.length === 0) {
                area.innerHTML = '<span class="text-gray-300 text-xs italic">Aucun filtre actif</span>';
            }
        }

        function toggleFavorite(id) {
            if (favorites.includes(id)) favorites = favorites.filter(x => x !== id);
            else favorites.push(id);
            localStorage.setItem('scFavorites', JSON.stringify(favorites));
            applyFilters();
            if (!document.getElementById('favoritesView').classList.contains('hidden')) renderFavorites();
        }

        function toggleSession(id) {
            if (sessionPlaylist.includes(id)) sessionPlaylist = sessionPlaylist.filter(x => x !== id);
            else sessionPlaylist.push(id);
            updateSessionUI();
            applyFilters();
        }

        function updateSessionUI() {
            let total = 0;
            sessionPlaylist.forEach(id => {
                const v = allVideosMap[id];
                if (v) {
                    const dStr = v.data.duree_totale || "15";
                    const nums = dStr.match(/\d+/g);
                    if (nums) total += parseInt(nums[0]);
                }
            });

            document.getElementById('totalTime').innerText = total;
            document.getElementById('trainingTotalTime').innerText = total;
            document.getElementById('exoCount').innerText = sessionPlaylist.length;
            document.getElementById('navCount').innerText = sessionPlaylist.length;

            const bar = document.getElementById('sessionBar');
            const isTrainingView = !document.getElementById('trainingView').classList.contains('hidden');

            if (sessionPlaylist.length > 0 && !isTrainingView) {
                bar.classList.remove('translate-y-full');
            } else {
                bar.classList.add('translate-y-full');
            }

            renderTrainingList();
            renderAdaptationRows();
        }

        function renderAdaptationRows() {
            const container = document.getElementById('adaptationRowsContainer');
            container.innerHTML = "";

            sessionPlaylist.forEach((id, index) => {
                const video = allVideosMap[id];
                if (!video) return;
                const d = video.data;
                const num = index + 1;

                container.innerHTML += `
                <div class="bg-gray-50/50 border border-gray-100 p-4 rounded-xl adaptation-row" data-idx="${index}">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="bg-blue-600 text-white w-6 h-6 flex items-center justify-center rounded-full text-[10px] font-black italic shadow-sm">#${num}</span>
                        <h4 class="font-black text-[12px] text-secondary uppercase tracking-wider truncate">${d.summary || video.title}</h4>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-6 gap-3">
                        ${['players', 'equipment', 'space', 'category', 'level', 'time'].map(key => {
                    const icons = { players: 'fa-users', equipment: 'fa-toolbox', space: 'fa-ruler-combined', category: 'fa-layer-group', level: 'fa-trophy', time: 'fa-clock' };
                    const placeholders = { players: 'ex: 12', equipment: 'Plots, ballons...', space: 'ex: 30x20m', category: 'ex: U15', level: 'ex: R1', time: "ex: 3x5' / 2'" };
                    const labels = { players: 'Joueurs', equipment: 'Mat√©riel', space: 'Espace', category: 'Cat√©gorie', level: 'Niveau', time: 'Temps' };
                    return `
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-gray-400 uppercase pl-1">${labels[key]}</label>
                                <div class="relative">
                                    <i class="fas ${icons[key]} absolute left-2.5 top-2.5 text-gray-300 text-[10px]"></i>
                                    <textarea data-idx="${index}" data-key="${key}" rows="1" placeholder="${placeholders[key]}" 
                                        oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; syncPlaceholders(this)"
                                        class="adapt-input w-full bg-white border border-gray-200 rounded-lg py-2 pl-7 pr-2 text-[11px] font-bold focus:border-blue-400 outline-none shadow-sm resize-none overflow-hidden transition-all duration-200"
                                        style="min-height: 34px;"></textarea>
                                </div>
                            </div>`;
                }).join('')}
                    </div>
                </div>`;
            });
            // Initial sync if there's any data
            syncPlaceholders();
        }

        function syncPlaceholders(sourceInput = null) {
            const keys = ["players", "equipment", "space", "category", "level", "time"];
            const rowsCount = sessionPlaylist.length;

            keys.forEach(key => {
                let currentValForProp = "";
                for (let i = 0; i < rowsCount; i++) {
                    const input = document.querySelector(`.adapt-input[data-idx="${i}"][data-key="${key}"]`);
                    if (!input) continue;

                    if (input.value.trim() !== "") {
                        currentValForProp = input.value.trim();
                        input.classList.remove('opacity-50');
                    } else if (currentValForProp !== "") {
                        input.placeholder = "H√©rit√© : " + currentValForProp;
                        input.classList.add('opacity-50'); // Indice visuel d'h√©ritage
                    } else {
                        // Reset placeholder to default if no prior value
                        const defaultMap = { players: "ex: 12", equipment: "Plots, ballons...", space: "ex: 30x20m", category: "ex: U15", level: "ex: R1", time: "ex: 3x5' / 2'" };
                        input.placeholder = defaultMap[key];
                        input.classList.remove('opacity-50');
                    }
                }
            });
        }

        function renderTrainingList() {
            const container = document.getElementById('trainingList');
            container.innerHTML = "";
            if (sessionPlaylist.length === 0) {
                container.innerHTML = "<p class='text-gray-400 text-center py-8 text-lg'>Votre s√©ance est vide. Ajoutez des exercices depuis la biblioth√®que.</p>";
                return;
            }

            sessionPlaylist.forEach((id, idx) => {
                const v = allVideosMap[id];
                if (!v) return;
                const d = v.data;

                const themes = d.themes || (d.theme_force ? [d.theme_force] : ["TECHNIQUE"]);
                const themeBadges = themes.map(t => {
                    const colorObj = getThemeColor(t);
                    return `<span class="px-2 py-0.5 rounded text-xs font-semibold ${colorObj.class}" style="${colorObj.style}">${t}</span>`;
                }).join('');

                let link = v.link;
                if (d.start_seconds && d.start_seconds > 0) link += (link.includes('?') ? '&' : '?') + "t=" + Math.floor(d.start_seconds);

                container.innerHTML += `
                <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100 flex flex-col md:flex-row gap-6 relative hover:shadow-lg transition">
                    <div class="absolute -left-3 top-6 bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-lg border-2 border-white text-lg">
                        ${idx + 1}
                    </div>
                    <div class="w-full md:w-56 flex-shrink-0">
                        <a href="${link}" target="_blank" class="block group/img relative overflow-hidden rounded-lg shadow-sm bg-gray-200">
                            <img src="${v.thumbnail || 'https://images.unsplash.com/photo-1579952363873-27f3bade9f55?q=80&w=1000&auto=format&fit=crop'}" 
                                class="w-full h-36 object-cover transition-transform duration-500 group-hover/img:scale-110" 
                                onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1579952363873-27f3bade9f55?q=80&w=1000&auto=format&fit=crop';">
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover/img:opacity-100 transition-opacity flex items-center justify-center">
                                <i class="fas fa-play text-white text-2xl"></i>
                            </div>
                        </a>
                        <div class="mt-3 flex flex-col items-center gap-1">
                            <span class="text-xs font-bold bg-blue-600 text-white px-3 py-1.5 rounded-md shadow-sm w-full text-center"><i class="fas fa-clock mr-1"></i>${d.duree_totale}</span>
                            ${d.timing_detail_pro ? `<span class="text-[10px] font-black text-primary uppercase text-center">${d.timing_detail_pro}</span>` : ''}
                        </div>
                        <div class="mt-2 flex flex-wrap justify-center gap-1">
                            ${themeBadges}
                        </div>
                    </div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-xl text-secondary mb-3">${d.summary}</h4>
                        
                        <!-- Top Info Cards (Horizontal Row) -->
                        ${renderInfoCards(d)}

                        <!-- Exercise Steps (Parsed Cubes) -->
                        <div class="border-t border-gray-100 pt-4 mt-2">
                            <h5 class="font-black text-[10px] text-primary mb-3 uppercase tracking-widest flex items-center gap-2">
                                <i class="fas fa-clipboard-list"></i> Structure de l'exercice
                            </h5>
                            <div class="space-y-3">
                                ${(function () {
                        let toParse = d.synopsis || "";
                        // Fallback vers le script si le synopsis est trop court ou non segment√©
                        if ((toParse.length < 50 || parseSynopsis(toParse).length <= 1) && d.script && d.script.length > 0) {
                            toParse = d.script.join('\n\n');
                        }
                        return renderStepCards(toParse || "Description non disponible.");
                    })()}
                            </div>
                        </div>
                    </div>
                    <div class="flex md:flex-col gap-2 justify-center border-t md:border-t-0 md:border-l pt-4 md:pt-0 md:pl-4 border-gray-100">
                         <button onclick="toggleSession(${v.id})" class="text-red-400 hover:text-red-600 transition p-2" title="Retirer"><i class="fas fa-times text-lg"></i></button>
                    </div>
                </div>`;
            });
        }

        function cancelSession() {
            if (confirm("Vider toute la s√©ance ?")) {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                sessionStartTime = null;
                document.getElementById('sessionTimerContainer').classList.add('hidden');
                document.getElementById('btnStartSession').classList.remove('hidden');
                document.getElementById('btnFinishSession').classList.add('hidden');

                sessionPlaylist = [];
                updateSessionUI();
                applyFilters();
            }
        }

        function startSession() {
            if (sessionPlaylist.length === 0) return showError("S√©ance vide !");
            sessionStartTime = new Date();
            document.getElementById('sessionTimerContainer').classList.remove('hidden');
            document.getElementById('btnStartSession').classList.add('hidden');
            document.getElementById('btnFinishSession').classList.remove('hidden');

            timerInterval = setInterval(updateTimerUI, 1000);
            showSuccess("S√©ance d√©marr√©e ! Bon entra√Ænement !");
        }

        function updateTimerUI() {
            if (!sessionStartTime) return;
            const now = new Date();
            const diff = Math.floor((now - sessionStartTime) / 1000);
            const hrs = Math.floor(diff / 3600);
            const mins = Math.floor((diff % 3600) / 60);
            const secs = diff % 60;
            document.getElementById('sessionTimerText').innerText =
                `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function finishSession() {
            if (sessionPlaylist.length === 0) return showError("S√©ance vide !");

            let realDuration = "0 min";
            if (sessionStartTime) {
                const now = new Date();
                const diffMins = Math.round((now - sessionStartTime) / 60000);
                realDuration = diffMins + " min";

                clearInterval(timerInterval);
                timerInterval = null;
                sessionStartTime = null;
            }

            const date = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
            const title = "S√©ance du " + date;

            historyData.unshift({
                date,
                title,
                realDuration,
                exoCount: sessionPlaylist.length,
                exercises: sessionPlaylist.map(id => {
                    const v = allVideosMap[id];
                    return { id, title: v ? v.data.summary : "Exercice" };
                })
            });

            localStorage.setItem('smartCoachHistory', JSON.stringify(historyData));
            showSuccess("F√©licitations ! S√©ance enregistr√©e.");

            // UI Reset
            sessionPlaylist = [];
            document.getElementById('sessionTimerContainer').classList.add('hidden');
            document.getElementById('btnStartSession').classList.remove('hidden');
            document.getElementById('btnFinishSession').classList.add('hidden');

            updateSessionUI();
            applyFilters();
            showView('history');
        }

        let currentHistoryTab = 'training';

        function switchHistoryTab(tab) {
            currentHistoryTab = tab;
            const trainBtn = document.getElementById('tabHistTrain');
            const matchBtn = document.getElementById('tabHistMatch');
            const trainContent = document.getElementById('historyTrainingContent');
            const matchContent = document.getElementById('historyMatchContent');

            if (tab === 'training') {
                trainBtn.classList.add('bg-white', 'text-secondary', 'shadow-sm');
                trainBtn.classList.remove('text-gray-500');
                matchBtn.classList.remove('bg-white', 'text-secondary', 'shadow-sm');
                matchBtn.classList.add('text-gray-500');
                trainContent.classList.remove('hidden');
                matchContent.classList.add('hidden');
                renderHistory();
            } else {
                matchBtn.classList.add('bg-white', 'text-secondary', 'shadow-sm');
                matchBtn.classList.remove('text-gray-500');
                trainBtn.classList.remove('bg-white', 'text-secondary', 'shadow-sm');
                trainBtn.classList.add('text-gray-500');
                matchContent.classList.remove('hidden');
                trainContent.classList.add('hidden');
                renderMatchHistory();
            }
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = "";

            if (historyData.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-100 italic text-gray-400">Aucune s√©ance termin√©e pour le moment.</div>`;
                return;
            }

            historyData.forEach((session, idx) => {
                const exoText = session.exoCount > 1 ? "exercices" : "exercice";
                container.innerHTML += `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex flex-col justify-between group hover:shadow-md transition cursor-pointer" onclick="viewSessionDetails(${idx})">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-xl shadow-inner border border-green-100">
                            <i class="fas fa-medal"></i>
                        </div>
                        <button onclick="event.stopPropagation(); historyData.splice(${idx},1); localStorage.setItem('smartCoachHistory', JSON.stringify(historyData)); renderHistory();" 
                            class="text-gray-300 hover:text-red-500 transition p-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg mb-2 group-hover:text-primary transition-colors">${session.title}</h3>
                        <div class="space-y-2 text-sm text-gray-500 font-medium">
                            <div class="flex items-center gap-2">
                                <i class="far fa-calendar-alt w-4 text-primary"></i>${session.date}
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="far fa-clock w-4 text-teal-500"></i>${session.realDuration}
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dumbbell w-4 text-purple-500"></i>${session.exoCount} ${exoText}
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-50 flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase text-gray-400 tracking-wider">Cliquer pour voir les d√©tails</span>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>`;
            });
        }

        function viewSessionDetails(idx) {
            const session = historyData[idx];
            if (!session || !session.exercises) return;

            let html = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-blue-700"><i class="far fa-calendar-alt mr-2"></i>${session.date}</span>
                            <span class="text-sm font-bold text-blue-700"><i class="far fa-clock mr-2"></i>${session.realDuration}</span>
                        </div>
                    </div>
                    <h5 class="font-black text-gray-800 uppercase tracking-tight mb-4 flex items-center gap-2">
                        <i class="fas fa-list-ol text-primary"></i> Exercices effectu√©s
                    </h5>
                    <div class="space-y-3">
            `;

            session.exercises.forEach((exo, i) => {
                html += `
                    <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="w-8 h-8 bg-white text-primary rounded-full flex items-center justify-center font-black shadow-sm border border-gray-200 text-xs">
                            ${i + 1}
                        </div>
                        <div class="flex-grow">
                            <p class="font-bold text-gray-700 text-sm">${exo.title}</p>
                        </div>
                        <button onclick="bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide(); openDeroulementModal('${exo.id}')" 
                            class="text-blue-500 hover:text-blue-700 p-2">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;
            });

            html += `</div></div>`;

            document.getElementById('detailsModalTitle').innerText = session.title;
            document.getElementById('detailsModalBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }

        function renderMatchHistory() {
            const container = document.getElementById('historyMatchList');
            container.innerHTML = "";

            const playedMatches = savedMatches.filter(m => m.isAvailable === false && m.ownerId === CURRENT_USER_ID);

            if (playedMatches.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-100 italic text-gray-400">Aucun match marqu√© comme "trouv√©" (jou√©).</div>`;
                return;
            }

            playedMatches.forEach(m => {
                const date = new Date(m.matchDate);
                const day = date.getDate();
                const month = date.toLocaleDateString('fr-FR', { month: 'short' }).toUpperCase();

                container.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex items-center gap-5">
                        <div class="bg-gray-100 text-gray-500 p-3 rounded-xl text-center min-w-[70px]">
                            <div class="text-xl font-black">${day}</div>
                            <div class="text-[10px] font-bold uppercase">${month}</div>
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-bold text-gray-800">${m.clubName}</h4>
                            <div class="flex gap-2 mt-1">
                                <span class="bg-purple-50 text-purple-600 px-2 py-0.5 rounded text-[10px] font-bold">${m.category}</span>
                                <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold">${m.level}</span>
                            </div>
                            <p class="text-[11px] text-gray-400 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${m.location}</p>
                        </div>
                        <div class="text-green-500 text-xl">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                `;
            });
        }

        async function addVideo() {
            const url = document.getElementById('videoUrl').value;
            if (!url) return showError("Veuillez entrer une URL");

            const btn = document.getElementById('addBtn');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('loader');
            const prog = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');

            btn.disabled = true;
            btnText.innerText = "Traitement Vid√©o...";
            loader.classList.remove('hidden');
            prog.classList.remove('hidden');

            let p = 0;
            const interval = setInterval(() => { if (p < 90) { p += 5; bar.style.width = p + "%"; } }, 300);

            try {
                const response = await fetch('/add_video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                const newEntries = await response.json();
                clearInterval(interval);
                bar.style.width = "100%";

                if (newEntries.error) {
                    showError(newEntries.error);
                } else {
                    newEntries.forEach(v => allVideosMap[v.id] = v);
                    showSuccess(`${newEntries.length} exercice(s) g√©n√©r√©(s) !`);
                    applyFilters();
                    document.getElementById('videoUrl').value = "";
                }
            } catch (e) {
                showError("Erreur serveur ou connexion.");
            } finally {
                clearInterval(interval);
                setTimeout(() => { prog.classList.add('hidden'); bar.style.width = "0%"; }, 1000);
                btn.disabled = false;
                btnText.innerText = "G√©n√©rer ma s√©ance";
                loader.classList.add('hidden');
            }
        }

        async function deleteVideo(id) {
            if (!confirm("Supprimer d√©finitivement cet exercice ?")) return;
            try {
                await fetch(`/delete_video/${id}`, { method: 'DELETE' });
                delete allVideosMap[id];
                favorites = favorites.filter(x => x !== id);
                sessionPlaylist = sessionPlaylist.filter(x => x !== id);
                localStorage.setItem('scFavorites', JSON.stringify(favorites));
                applyFilters();
                updateSessionUI();
                showSuccess("Exercice supprim√© !");
            } catch (e) { showError("Erreur suppression"); }
        }

        function showView(viewId) {
            const views = ['library', 'favorites', 'training', 'match', 'history'];
            views.forEach(v => {
                const el = document.getElementById(v + 'View');
                if (el) el.classList.add('hidden');
            });

            const target = document.getElementById(viewId + 'View');
            if (target) {
                target.classList.remove('hidden');
            } else {
                // Si la vue n'existe pas (feature d√©sactiv√©e), rediriger vers la vue par d√©faut
                if (viewId === 'library') showView('match');
                return;
            }

            // Mise √† jour de la navbar (style)
            const navLinks = ['Lib', 'Fav', 'Match', 'Train', 'Hist'];
            navLinks.forEach(link => {
                const el = document.getElementById('nav' + link);
                if (el) {
                    if (link.toLowerCase().startsWith(viewId.substring(0, 3))) {
                        el.classList.add('text-primary', 'border-bottom', 'border-2', 'border-primary');
                        el.classList.remove('text-secondary', 'fw-semibold');
                        el.classList.add('fw-bold');
                    } else {
                        el.classList.remove('text-primary', 'border-bottom', 'border-2', 'border-primary', 'fw-bold');
                        el.classList.add('text-secondary', 'fw-semibold');
                    }
                }
            });

            if (viewId === 'favorites') renderFavorites();
            if (viewId === 'training') updateSessionUI();
            if (viewId === 'match') {
                renderMatchList();
                renderMyMatches();
                switchMatchTab('create'); // Reset to create tab by default
                prefillMatchForm();
            }
            if (viewId === 'history') {
                if (currentHistoryTab === 'training') renderHistory();
                else renderMatchHistory();
            }
            // Gestion de la sessionBar (Masquer si on est dans training)
            const bar = document.getElementById('sessionBar');
            if (bar) {
                if (viewId === 'training' || sessionPlaylist.length === 0) {
                    bar.classList.add('translate-y-full');
                } else {
                    bar.classList.remove('translate-y-full');
                }
            }

            if (viewId === 'favorites') renderFavorites();
            if (viewId === 'history') renderHistory();
        }

        function renderFavorites() {
            const grid = document.getElementById('favoritesGrid');
            grid.innerHTML = "";
            if (favorites.length === 0) {
                document.getElementById('noFavMsg').classList.remove('hidden');
                return;
            }
            document.getElementById('noFavMsg').classList.add('hidden');
            favorites.forEach(id => {
                if (allVideosMap[id]) grid.innerHTML += createCardHTML(allVideosMap[id]);
            });
        }

        function generateQuickSession() {
            const keys = Object.keys(allVideosMap);
            if (keys.length === 0) return showError("Biblioth√®que vide ! Analysez des vid√©os d'abord.");

            sessionPlaylist = [];
            for (let i = 0; i < Math.min(3, keys.length); i++) {
                sessionPlaylist.push(parseInt(keys[i]));
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('quickCreateModal'));
            modal.hide();
            showSuccess("S√©ance g√©n√©r√©e par IA !");
            updateSessionUI();
            showView('training');
        }

        function updatePlatformIcon(input) {
            const val = input.value.toLowerCase();
            const icon = document.getElementById('platformIcon');

            // Remove specific icon classes
            icon.classList.remove('fab', 'fas', 'fa-youtube', 'fa-tiktok', 'fa-instagram', 'fa-twitter', 'fa-link');

            if (val.includes('tiktok.com')) {
                icon.classList.add('fab', 'fa-tiktok');
            } else if (val.includes('instagram.com')) {
                icon.classList.add('fab', 'fa-instagram');
            } else if (val.includes('twitter.com') || val.includes('x.com')) {
                icon.classList.add('fab', 'fa-twitter');
            } else if (val.includes('youtube.com') || val.includes('youtu.be')) {
                icon.classList.add('fab', 'fa-youtube');
            } else {
                icon.classList.add('fas', 'fa-link');
            }
        }

        async function adaptSession() {
            if (sessionPlaylist.length === 0) return showError("S√©ance vide !");

            const btn = document.getElementById('btnAdaptSession');
            const txt = document.getElementById('btnAdaptText');
            const loader = document.getElementById('btnAdaptLoader');

            const adaptationPlan = [];
            const inputs = document.querySelectorAll('.adapt-input');

            // On groupe les inputs par exercice
            const exoData = {};
            inputs.forEach(input => {
                const idx = input.getAttribute('data-idx');
                const key = input.getAttribute('data-key');
                if (!exoData[idx]) exoData[idx] = {};
                exoData[idx][key] = input.value.trim();
            });

            // Propagation intelligente
            let lastValue = { players: "", equipment: "", space: "", category: "", level: "", time: "" };

            for (let i = 0; i < sessionPlaylist.length; i++) {
                const current = exoData[i] || {};
                const videoId = sessionPlaylist[i];
                const video = allVideosMap[videoId];

                // On fusionne avec la propagation ET les donn√©es d'origine
                const finalConstraints = {
                    players: current.players || lastValue.players || video.data.nb_joueurs_exact || "Inconnu",
                    equipment: current.equipment || lastValue.equipment || video.data.materiel_detail || "Inconnu",
                    space: current.space || lastValue.space || video.data.dimensions || "Inconnu",
                    category: current.category || lastValue.category || video.data.cat_range || "Inconnu",
                    level: current.level || lastValue.level || video.data.level_range || "Inconnu",
                    time: current.time || lastValue.time || video.data.timing_detail_pro || "15 min"
                };

                // On met √† jour lastValue pour l'exo suivant
                lastValue = { ...finalConstraints };

                adaptationPlan.push({ videoId, constraints: finalConstraints });
            }

            btn.disabled = true;
            if (txt) txt.classList.add('hidden');
            if (loader) loader.classList.remove('hidden');

            try {
                const response = await fetch('/adapt_session_granular', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plan: adaptationPlan })
                });

                const results = await response.json();

                if (results.error) {
                    showError(results.error);
                } else {
                    results.forEach(v => {
                        allVideosMap[v.id] = v;
                    });
                    console.log("Adaptation results applied. Updated allVideosMap:", allVideosMap);
                    showSuccess("S√âANCE ADAPT√âE !");
                    renderTrainingList();
                    renderAdaptationRows(); // Rafra√Æchit les placeholders si besoin
                }
            } catch (e) {
                showError("Erreur lors de l'adaptation.");
            } finally {
                btn.disabled = false;
                if (txt) txt.classList.remove('hidden');
                if (loader) loader.classList.add('hidden');
            }
        }

        // ========== FONCTION TROUVER MON MATCH ==========
        function searchMatch() {
            const btn = document.getElementById('btnSearchMatch');
            const txt = document.getElementById('searchMatchText');
            const loader = document.getElementById('searchMatchLoader');

            txt.classList.add('hidden');
            loader.classList.remove('hidden');
            btn.disabled = true;

            // R√©cup√©rer les crit√®res
            const players = parseInt(document.getElementById('matchPlayers').value) || 0;
            const duration = parseInt(document.getElementById('matchDuration').value);
            const level = document.getElementById('matchLevel').value;
            const category = document.getElementById('matchCategory').value;
            const description = document.getElementById('matchDescription').value.toLowerCase();

            // Th√®mes s√©lectionn√©s
            const themes = [];
            if (document.getElementById('matchTech').checked) themes.push('TECHNIQUE');
            if (document.getElementById('matchTac').checked) themes.push('TACTIQUE');
            if (document.getElementById('matchPhys').checked) themes.push('PHYSIQUE');
            if (document.getElementById('matchGK').checked) themes.push('GARDIEN');
            if (document.getElementById('matchMatch').checked) themes.push('JEU');

            // Simuler un d√©lai de recherche
            setTimeout(() => {
                // Filtrer les exercices existants
                const allVideos = Object.values(allVideosMap);
                let results = allVideos.filter(vid => {
                    const d = vid.data;
                    let score = 0;

                    // Filtre par th√®me
                    if (themes.length > 0) {
                        const vidThemes = d.themes || [];
                        if (themes.some(t => vidThemes.includes(t))) score += 20;
                        else return false; // Th√®me obligatoire
                    }

                    // Bonus si niveau correspond
                    if (d.level_range && d.level_range.toLowerCase().includes(level)) score += 10;

                    // Bonus si cat√©gorie correspond
                    if (d.cat_range && d.cat_range.toLowerCase().includes(category.toLowerCase())) score += 10;

                    // Bonus si description contient des mots-cl√©s
                    if (description) {
                        const searchText = (d.summary + ' ' + d.synopsis).toLowerCase();
                        const words = description.split(' ').filter(w => w.length > 3);
                        words.forEach(word => {
                            if (searchText.includes(word)) score += 5;
                        });
                    }

                    vid._matchScore = score;
                    return score > 0 || themes.length === 0;
                });

                // Trier par score
                results.sort((a, b) => (b._matchScore || 0) - (a._matchScore || 0));
                results = results.slice(0, 9); // Max 9 r√©sultats

                // Afficher les r√©sultats
                const resultsContainer = document.getElementById('matchResults');
                const resultsGrid = document.getElementById('matchResultsGrid');
                const emptyState = document.getElementById('matchEmpty');

                if (results.length > 0) {
                    emptyState.classList.add('hidden');
                    resultsContainer.classList.remove('hidden');
                    resultsGrid.innerHTML = results.map(vid => createCardHTML(vid)).join('');
                } else {
                    resultsContainer.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    emptyState.innerHTML = `
                        <div class="text-6xl mb-4">üò¢</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">Aucun exercice trouv√©</h3>
                        <p class="text-gray-400 mb-4">Essaie d'√©largir tes crit√®res ou ajoute de nouvelles vid√©os √† ta biblioth√®que.</p>
                        <button onclick="showView('library')" class="bg-emerald-500 text-white px-6 py-2 rounded-full font-bold hover:bg-emerald-600 transition">
                            <i class="fas fa-plus mr-2"></i>Ajouter des vid√©os
                        </button>
                    `;
                }

                txt.classList.remove('hidden');
                loader.classList.add('hidden');
                btn.disabled = false;

                showSuccess(`${results.length} exercice(s) trouv√©(s) !`);
            }, 800);
        }

        // ========== SYST√àME DE MATCHMAKING ==========
        // Note: savedMatches est d√©sormais initialis√© en haut du script.

        // üîß Migration: Assigner l'ownerId aux anciens matchs qui n'en ont pas
        (function migrateOldMatches() {
            let needsSave = false;
            savedMatches.forEach(m => {
                if (!m.ownerId) {
                    m.ownerId = CURRENT_USER_ID;
                    needsSave = true;
                    console.log(`üîß Migration: Match "${m.clubName}" assign√© √† l'utilisateur actuel.`);
                }
            });
            if (needsSave) {
                localStorage.setItem('scMatches', JSON.stringify(savedMatches));
                console.log('‚úÖ Migration des matchs termin√©e.');
            }
        })();

        // === FORMATAGE T√âL√âPHONE FRAN√áAIS (+33) ===
        function formatPhoneNumber(input) {
            // Supprimer tout sauf les chiffres
            let value = input.value.replace(/\D/g, '');

            // Formater intelligemment :
            // Si 10 chiffres (commence par 0) : 0X XX XX XX XX
            // Si 9 chiffres (commence par 6/7...) : X XX XX XX XX
            let formatted = '';
            if (value.length === 10 && value.startsWith('0')) {
                // 07 12 34 56 78
                formatted = value.substring(0, 2) + ' ' + value.substring(2, 4) + ' ' + value.substring(4, 6) + ' ' + value.substring(6, 8) + ' ' + value.substring(8, 10);
            } else if (value.length === 9) {
                // 7 12 34 56 78
                formatted = value.substring(0, 1) + ' ' + value.substring(1, 3) + ' ' + value.substring(3, 5) + ' ' + value.substring(5, 7) + ' ' + value.substring(7, 9);
            } else {
                // Autre : simple espacement par 2
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 2 === 0) formatted += ' ';
                    formatted += value[i];
                }
            }

            input.value = formatted.trim();

            // Validation visuelle
            const errorId = input.id === 'regPhone' ? 'regPhoneError' : 'phoneError';
            const errorMsg = document.getElementById(errorId);

            // Si pas d'√©l√©ment erreur trouv√©, on arr√™te (ex: pas d'ID sur input)
            if (!errorMsg) return;

            const digitsOnly = value.replace(/\D/g, '').length; // Recalculer les chiffres seuls apr√®s les traitements

            if (digitsOnly > 0 && digitsOnly < 9) {
                errorMsg.classList.remove('hidden');
                input.classList.add('border-red-400');
                input.classList.remove('border-green-400');
            } else if (digitsOnly === 9 || digitsOnly === 10) {
                errorMsg.classList.add('hidden');
                input.classList.remove('border-red-400');
                input.classList.add('border-green-400');
            } else {
                errorMsg.classList.add('hidden');
                input.classList.remove('border-red-400', 'border-green-400');
            }
        }

        function isValidFrenchPhone(phone) {
            // Retourne true si vide (optionnel) ou si 9 ou 10 chiffres (avec ou sans 0 initial)
            if (!phone || phone.trim() === '') return true;
            const digits = phone.replace(/\D/g, '');
            return digits.length === 9 || digits.length === 10;
        }

        function deleteMatch(matchId) {
            const match = savedMatches.find(m => m.id === matchId);
            if (!match) return showError('Annonce introuvable.');
            if (match.ownerId !== CURRENT_USER_ID) return showError('Tu ne peux supprimer que tes propres annonces !');

            if (!confirm('Supprimer d√©finitivement cette annonce ?')) return;

            savedMatches = savedMatches.filter(m => m.id !== matchId);
            localStorage.setItem('scMatches', JSON.stringify(savedMatches));
            renderMatchList();
            showSuccess('Annonce supprim√©e !');
        }

        function switchMatchTab(tab) {
            const createSection = document.getElementById('createMatchSection');
            const searchSection = document.getElementById('searchMatchSection');
            const tabCreate = document.getElementById('tabCreate');
            const tabSearch = document.getElementById('tabSearch');

            if (!createSection || !searchSection) return;

            if (tab === 'create') {
                createSection.classList.remove('hidden');
                searchSection.classList.add('hidden');
                tabCreate.className = 'px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 bg-[#2a5298] text-white shadow-lg scale-105';
                tabSearch.className = 'px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 bg-gray-200 text-gray-600 hover:bg-gray-300';

                // Ensure data is up to date
                prefillMatchForm();
            } else {
                createSection.classList.add('hidden');
                searchSection.classList.remove('hidden');
                tabSearch.className = 'px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 bg-[#1e3c72] text-white shadow-lg scale-105';
                tabCreate.className = 'px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 bg-gray-200 text-gray-600 hover:bg-gray-300';
                renderMatchList();
            }
        }
        // State pour l'√©dition
        let editingMatchId = null;

        function publishMatch() {
            try {
                // R√©cup√©ration des valeurs
                const siret = document.getElementById('createClubSiret').value.trim();
                const clubName = document.getElementById('createClubName').value; // Hidden
                const location = document.getElementById('createLocation').value; // Hidden
                const matchDate = document.getElementById('createMatchDate').value;
                const matchTime = document.getElementById('createMatchTime').value;

                // Validation Date Pass√©e
                // Validation Date (Pass√©e + Futur trop lointain)
                const dMatch = new Date(matchDate);
                const dNow = new Date();
                dNow.setHours(0, 0, 0, 0);

                // Max date = Ann√©e en cours + 2 ans (ex: 2026 -> max 2028)
                const dMax = new Date();
                dMax.setFullYear(dMax.getFullYear() + 2);

                if (dMatch < dNow) {
                    showError("üö´ Impossible de cr√©er un match dans le pass√© !");
                    return;
                }

                if (dMatch > dMax) {
                    showError("üö´ Date invalide : Vous ne pouvez pas pr√©voir de match aussi loin dans le futur.");
                    return;
                }

                // Limite 3 matchs par jour
                const today = new Date().toISOString().split('T')[0];
                const matchesToday = savedMatches.filter(m => m.ownerId === CURRENT_USER_ID && m.createdAt && m.createdAt.startsWith(today)).length;
                if (!editingMatchId && matchesToday >= 3) {
                    showError("‚ö†Ô∏è Limite atteinte : Tu ne peux cr√©er que 3 matchs par jour.");
                    return;
                }

                const category = document.getElementById('createCategory').value;
                const level = document.getElementById('createLevel').value;
                const matchType = document.getElementById('createMatchType').value;
                const terrainType = document.getElementById('createTerrainType').value;
                const stadiumAddress = document.getElementById('createStadiumAddress').value.trim();
                const message = document.getElementById('createMessage').value.trim();
                const email = document.getElementById('createEmail').value.trim();
                let phone = document.getElementById('createPhone').value.trim().replace(/\s/g, '');
                let phoneFormatted = phone;
                // Si le user a mis un 0 au d√©but, on le garde mais on n'ajoute pas +33 par dessus
                // S'il n'a pas mis +33, on l'ajoute proprement sans doubler
                if (phone) {
                    if (!phone.startsWith('+')) {
                        if (phone.startsWith('0')) {
                            // Num√©ro standard 06... -> on peut le garder tel quel ou transformer en +33 6...
                            // Le user dit "07... avec le 0", on va respecter son souhait d'affichage
                            phoneFormatted = '+33 ' + phone.substring(1); // Format +33 6...
                        } else if (phone.startsWith('33')) {
                            phoneFormatted = '+' + phone; // Format +33...
                        } else {
                            phoneFormatted = '+33 ' + phone; // Format +33 6... (si 6... sans 0)
                        }
                    } else {
                        phoneFormatted = phone; // Si d√©j√† format√© avec +, on le garde
                    }
                } else {
                    phoneFormatted = ''; // Si vide, reste vide
                }


                console.log('üöÄ publishMatch | EditMode:', editingMatchId, '| Data:', { clubName, level, category });

                // Validation
                // Validation RELAXED (User Request): Trust Profile Data, Only check Date/Category/Level
                if (!matchDate || !category || !level) {
                    showError('‚ö†Ô∏è La date, la cat√©gorie et le niveau sont obligatoires.');
                    return;
                }

                // Phone validation removed/relaxed as per "retire les autres erreurs"
                // We trust the profile or the input formatting logic above

                /* Phone validation removed locally to stop errors
                if (phone && !isValidFrenchPhone(phone)) {
                    showError('‚ö†Ô∏è Num√©ro de t√©l√©phone invalide (9 ou 10 chiffres attendus).');
                    return;
                }
                */

                const locationLat = parseFloat(document.getElementById('createLocationLat')?.value) || null;
                const locationLng = parseFloat(document.getElementById('createLocationLng')?.value) || null;

                if (editingMatchId) {
                    // --- UPDATE MODE ---
                    const index = savedMatches.findIndex(m => m.id === editingMatchId);
                    if (index !== -1) {
                        const oldMatch = savedMatches[index];
                        // Mise √† jour propre sans √©craser isAvailable
                        savedMatches[index] = {
                            ...oldMatch,
                            clubName,
                            matchDate,
                            matchTime,
                            category,
                            level,
                            location,
                            locationLat,
                            locationLng,
                            matchType,
                            terrainType,
                            stadiumAddress,
                            message,
                            email,
                            phone: phoneFormatted,
                            updatedAt: new Date().toISOString()
                        };
                        showSuccess('‚úÖ Annonce modifi√©e avec succ√®s !');
                    } else {
                        showError('‚ùå Erreur : Impossible de retrouver le match √† modifier.');
                    }

                    // Reset Mode
                    editingMatchId = null;
                    const btn = document.getElementById('btnPublishMatch');
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-bullhorn mr-3"></i> PUBLIER MON ANNONCE';
                        btn.classList.remove('from-amber-500', 'via-orange-500', 'to-red-500');
                        btn.classList.add('from-[#1e3c72]', 'via-[#2a5298]', 'to-emerald-500');
                    }

                } else {
                    // --- CREATE MODE ---
                    const newMatch = {
                        id: Date.now(),
                        ownerId: CURRENT_USER_ID,
                        clubName,
                        matchDate,
                        matchTime,
                        category,
                        level,
                        location,
                        locationLat,
                        locationLng,
                        matchType,
                        terrainType,
                        clubLogo: document.getElementById('createClubLogo')?.value || '',
                        stadiumAddress,
                        message,
                        email,
                        phone: phoneFormatted,
                        createdAt: new Date().toISOString(),
                        isAvailable: true
                    };
                    savedMatches.push(newMatch);
                    showSuccess('üéâ Annonce publi√©e avec succ√®s !');
                }

                // Persist & Refresh
                localStorage.setItem('scMatches', JSON.stringify(savedMatches));

                // Clear Form
                document.getElementById('createClubName').value = '';
                document.getElementById('createMatchDate').value = '';
                document.getElementById('createMatchTime').value = '15:00';
                document.getElementById('createLocation').value = '';
                document.getElementById('createStadiumAddress').value = '';
                document.getElementById('createMessage').value = '';
                document.getElementById('createEmail').value = '';
                document.getElementById('createPhone').value = '';

                renderMyMatches();
                renderMatchList();

                // RESTORE PROFILE DATA IMMEDIATELY
                prefillMatchForm();

            } catch (e) {
                console.error('üî• Erreur dans publishMatch:', e);
                showError('Une erreur technique est survenue : ' + (e.message || 'Erreur inconnue'));
            }
        }

        function editMatch(id) {
            const m = savedMatches.find(m => m.id === id);
            if (!m) return;

            // Populate Form
            document.getElementById('createClubSiret').value = m.siret || '';
            // FIX: Manual population because lookup is disabled
            // if (m.siret) performSiretLookup(m.siret, 'create');

            // Manually show card
            const info = document.getElementById('createSiretInfo');
            const nameEl = document.getElementById('createSiretName');
            const addrEl = document.getElementById('createSiretAddr');
            const logoEl = document.getElementById('createSiretLogo');

            if (info) {
                info.classList.remove('hidden');
                info.classList.remove('mt-4');
                info.classList.add('mt-0');
                if (nameEl) nameEl.innerText = m.clubName || "Mon Club";
                if (addrEl) addrEl.style.display = 'none'; // Keep consistent with Create flow
                if (logoEl) logoEl.src = '/static/realistic_ball.jpg';

                // Hide input container
                const siretInput = document.getElementById('createClubSiret');
                if (siretInput) {
                    const pg = siretInput.parentNode;
                    if (pg) pg.classList.add('hidden');
                }
            }

            document.getElementById('createMatchDate').value = m.matchDate;
            document.getElementById('createMatchTime').value = m.matchTime || '15:00';
            document.getElementById('createCategory').value = m.category;
            document.getElementById('createLevel').value = m.level;
            document.getElementById('createMatchType').value = m.matchType || 'Match Amical';
            document.getElementById('createTerrainType').value = m.terrainType || 'Herbe';
            document.getElementById('createStadiumAddress').value = m.stadiumAddress || '';
            document.getElementById('createMessage').value = m.message || '';
            document.getElementById('createEmail').value = m.email;

            // Phone logic
            if (m.phone) {
                // Remove +33 and spaces for editing
                let phoneDigits = m.phone.replace(/\D/g, '');
                if (phoneDigits.startsWith('33')) {
                    phoneDigits = phoneDigits.substring(2);
                }
                document.getElementById('createPhone').value = phoneDigits;
            } else {
                document.getElementById('createPhone').value = '';
            }

            // Set Edit Mode
            editingMatchId = id;

            // Update UI Button
            const btn = document.getElementById('btnPublishMatch');
            btn.innerHTML = '<i class="fas fa-save mr-3"></i> ACCEPTER LES MODIFICATIONS';
            // Change color to indicate edit mode (Orange/Amber)
            btn.classList.remove('from-[#1e3c72]', 'via-[#2a5298]', 'to-emerald-500');
            btn.classList.add('from-amber-500', 'via-orange-500', 'to-red-500');

            // IMPORTANT: Switch to Create tab if not already there
            switchMatchTab('create');

            // Scroll to form
            setTimeout(() => {
                document.getElementById('createClubName').scrollIntoView({ behavior: 'smooth' });
            }, 100);
            showSuccess('üñäÔ∏è Mode modification activ√© - Modifie les champs puis clique sur le bouton orange');
        }

        // === CALENDRIER DES MATCHS ===
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarMonthTitle');
            if (!grid || !title) return;

            grid.innerHTML = '';
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            // Titre
            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            title.textContent = `${monthNames[month]} ${year}`;

            // Premier jour du mois (0=Dimanche, 1=Lundi...)
            let firstDay = new Date(year, month, 1).getDay();
            // Ajuster pour Lundi comme premier jour (JS: 0=Dim, 1=Lun... -> On veut 0=Lun, 6=Dim)
            firstDay = firstDay === 0 ? 6 : firstDay - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Cases vides avant le 1er
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="p-2 h-20 bg-gray-50/50 rounded-xl border border-transparent"></div>`;
            }

            // Jours du mois
            const todayStr = new Date().toISOString().split('T')[0];

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                // Filtrer les matchs ce jour-l√†
                const matchesToday = savedMatches.filter(m => m.matchDate === dateStr);
                const hasMatch = matchesToday.length > 0;
                const isOwner = matchesToday.some(m => currentUser && m.ownerId === CURRENT_USER_ID);
                const isToday = dateStr === todayStr;

                let dayClass = "p-2 h-20 bg-white rounded-xl border-2 transition cursor-pointer hover:border-blue-300 relative group flex flex-col justify-between";
                if (isOwner) {
                    dayClass += " border-blue-500 bg-blue-50/30 shadow-sm";
                } else {
                    dayClass += " border-gray-100";
                }

                if (isToday) {
                    dayClass += " !bg-orange-50 !border-orange-200";
                }

                let indicators = '';
                if (hasMatch) {
                    indicators = `
                        <div class="flex items-center gap-1 mt-1">
                            <i class="fas fa-futbol text-[10px] text-blue-500 animate-bounce-short"></i>
                            <span class="text-[9px] font-black text-blue-600 bg-blue-100 px-1 rounded">${matchesToday.length}</span>
                        </div>
                    `;
                }

                grid.innerHTML += `
                    <div class="${dayClass}" onclick="selectCalendarDay('${dateStr}')">
                        <div class="flex justify-between items-start">
                            <span class="text-xs font-black ${isToday ? 'text-orange-600' : 'text-gray-400'}">${d}</span>
                            ${isOwner ? '<i class="fas fa-user-circle text-[10px] text-blue-500" title="Mon annonce"></i>' : ''}
                        </div>
                        ${indicators}
                    </div>
                `;
            }
        }

        function changeCalendarMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
            // Cacher les d√©tails si on change de mois
            document.getElementById('dayDetailsArea').classList.add('hidden');
        }

        function selectCalendarDay(dateStr) {
            const area = document.getElementById('dayDetailsArea');
            const list = document.getElementById('dayMatchesList');
            const title = document.getElementById('selectedDayTitle');

            // Format date lisible
            const d = new Date(dateStr);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const dateStrFr = d.toLocaleDateString('fr-FR', options);

            title.innerHTML = `<i class="fas fa-clock text-blue-500"></i> Matchs du ${dateStrFr}`;

            const matchesToday = savedMatches.filter(m => m.matchDate === dateStr);

            if (matchesToday.length === 0) {
                list.innerHTML = `<p class="text-center py-4 text-gray-400 text-xs">Aucun match pr√©vu pour cette date.</p>`;
            } else {
                list.innerHTML = matchesToday.map(m => {
                    const isOwner = currentUser && m.ownerId === CURRENT_USER_ID;
                    const distHtml = m.distance ? `<span class="bg-gray-100 px-2 py-0.5 rounded-full text-[9px] font-bold"><i class="fas fa-road mr-1"></i>${m.distance} km</span>` : '';
                    const logo = getClubLogo(m.clubLogo);

                    return `
                        <div class="bg-white border ${isOwner ? 'border-blue-400 bg-blue-50/20' : 'border-gray-100'} p-3 rounded-xl shadow-sm flex items-center justify-between group">
                            <div class="flex items-center gap-3">
                                <img src="${logo}" class="w-8 h-8 object-contain">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h6 class="font-black text-xs text-gray-800 m-0">${m.clubName}</h6>
                                        ${isOwner ? '<span class="bg-blue-600 text-white text-[8px] px-1 rounded font-black">MOI</span>' : ''}
                                    </div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">${m.category} - ${m.level}</span>
                                        <span class="text-[10px] font-black text-gray-400"><i class="fas fa-clock text-blue-300"></i> ${m.matchTime}</span>
                                        ${distHtml}
                                    </div>
                                </div>
                            </div>
                            <button onclick="document.querySelector('[data-match-id=\\'${m.id}\\']')?.scrollIntoView({behavior:'smooth'}); bootstrap.Modal.getInstance(document.getElementById('calendarModal')).hide();" 
                                    class="bg-gray-100 text-gray-500 hover:bg-blue-500 hover:text-white w-8 h-8 rounded-lg transition flex items-center justify-center">
                                <i class="fas fa-arrow-right text-xs"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }

            area.classList.remove('hidden');
        }

        // Helper pour afficher le logo avec fallback
        function getClubLogo(logoUrl) {
            return logoUrl || '/static/realistic_ball.jpg';
        }

        function searchMatches() {
            renderMatchList();
            showSuccess('Recherche effectu√©e !');
        }

        // --- DASHBOARD GESTION MES MATCHS ---
        function renderMyMatches() {
            const container = document.getElementById('myMatchesList');
            if (!container) return;

            const myMatches = savedMatches.filter(m => m.ownerId === CURRENT_USER_ID);

            if (myMatches.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 bg-gray-50 rounded-xl border border-gray-100">
                        <i class="fas fa-clipboard-list text-gray-300 text-3xl mb-3"></i>
                        <p class="text-gray-500 font-medium">Aucune annonce active</p>
                        <p class="text-xs text-gray-400 mt-1">Tes annonces publi√©es appara√Ætront ici</p>
                    </div>
                `;
                return;
            }

            // M√äME FORMAT QUE LA LISTE PRINCIPALE MAIS AVEC LES CONTR√îLES DE GESTION
            container.innerHTML = myMatches.map(m => {
                const date = new Date(m.matchDate);
                const day = date.getDate();
                const month = date.toLocaleDateString('fr-FR', { month: 'short' }).toUpperCase();
                const year = date.getFullYear();
                const isFavorite = userFavorites.includes(m.id);
                const timeDisplay = m.matchTime || '15:00';
                const terrainDisplay = m.terrainType || 'Non pr√©cis√©';
                const distanceDisplay = m.distance !== null && m.distance !== undefined
                    ? `<span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full text-xs font-bold ml-2"><i class="fas fa-route mr-1"></i>${m.distance} km</span>`
                    : '';
                const isAvailable = m.isAvailable !== false; // Default true
                const cardBg = isAvailable ? 'bg-emerald-100' : 'bg-red-100';
                const cardBorder = 'border-black border-2 shadow-sm';

                // Calcul distance pour le dashboard aussi si une ville est cherch√©e
                const sLat = parseFloat(document.getElementById('searchLocationLat')?.value) || null;
                const sLng = parseFloat(document.getElementById('searchLocationLng')?.value) || null;
                let dashDistanceHtml = '';
                if (sLat !== null && sLng !== null && m.locationLat && m.locationLng) {
                    const d = calculateDistance(sLat, sLng, m.locationLat, m.locationLng);
                    dashDistanceHtml = `<span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full text-[10px] font-black ml-2 shadow-sm border border-orange-200"><i class="fas fa-route mr-1"></i>${d} km</span>`;
                }

                // Badge Disponibilit√© Dynamique avec bordure noire
                const badgeHtml = isAvailable
                    ? `<div class="absolute top-4 left-4 flex items-center gap-1 bg-green-200 text-green-800 px-2 py-1 rounded-full text-[10px] font-bold z-10 border border-black shadow-sm"><div class="w-2 h-2 bg-green-600 rounded-full animate-pulse"></div> Disponible</div>`
                    : `<div class="absolute top-4 left-4 flex items-center gap-1 bg-red-200 text-red-800 px-2 py-1 rounded-full text-[10px] font-bold z-10 border border-black shadow-sm"><div class="w-2 h-2 bg-red-600 rounded-full"></div> Indisponible</div>`;

                // Boutons Dashboad : Toggle Availability + Delete
                const toggleBtn = `
                    <div class="flex items-center gap-2 bg-white/80 px-3 py-1.5 rounded-xl border border-gray-200 shadow-sm">
                        <span class="text-[10px] font-black text-gray-700 uppercase tracking-tight">
                            Match trouv√© ?
                        </span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-${m.id}" class="sr-only peer" ${!isAvailable ? 'checked' : ''} onchange="toggleAvailability(${m.id})">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:bg-green-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                        </label>
                    </div>
                `;

                // Lien Itin√©raire (Google Maps)
                const mapsUrl = (m.locationLat && m.locationLng)
                    ? `https://www.google.com/maps/dir/?api=1&destination=${m.locationLat},${m.locationLng}`
                    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(m.stadiumAddress || m.location)}`;

                return `
                    <div class="${cardBg} ${cardBorder} rounded-2xl shadow-lg p-6 hover:shadow-2xl transition flex flex-col md:flex-row gap-6 items-center relative ${!isAvailable ? 'grayscale-[10%]' : ''}" data-match-id="${m.id}">
                        <!-- Badge Disponibilit√© -->
                        ${badgeHtml}

                        <!-- Boutons Actions Top Right -->
                        <div class="absolute top-3 right-3 flex gap-2 items-center">
                            ${toggleBtn}
                            <button onclick="editMatch(${m.id})" class="text-orange-500 hover:text-amber-600 transition p-2 bg-white/80 rounded-lg shadow-sm" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMatch(${m.id})" class="text-red-600 hover:text-red-700 transition p-2 bg-white/80 rounded-lg shadow-sm" title="Supprimer mon annonce"><i class="fas fa-trash-alt"></i></button>
                        </div>

                        <div class="bg-gradient-to-br from-blue-500 to-teal-400 text-white p-4 rounded-2xl text-center min-w-[100px] shadow-md relative group mt-6 md:mt-0">
                            <div class="text-3xl font-black leading-none">${day}</div>
                            <div class="text-sm font-bold uppercase mb-1">${month}</div>
                            <div class="text-[10px] font-bold opacity-80 border-t border-white/30 pt-1">${year}</div>
                            <div class="text-lg font-bold mt-2 bg-white/20 rounded-lg py-1"><i class="fas fa-clock mr-1"></i>${timeDisplay}</div>
                        </div>
                        <div class="flex flex-grow w-full md:w-auto">
                            <div class="flex-grow">
                                <h4 class="text-xl font-bold text-gray-800 mb-1">${m.clubName}</h4>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <span class="bg-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm">${m.category}</span>
                                    <span class="bg-rose-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm">${m.level}</span>
                                    <span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm">${m.matchType}</span>
                                    <span class="bg-emerald-700 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm"><i class="fas fa-grass mr-1"></i>${terrainDisplay}</span>
                                    ${dashDistanceHtml ? `<span class="bg-orange-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm"><i class="fas fa-route mr-1"></i>${m.distance !== null ? m.distance : 0} km</span>` : ''}
                                </div>
                                <p class="text-gray-500 text-sm flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-teal-500"></i> ${m.stadiumAddress || m.location}
                                    <a href="javascript:void(0)" onclick="handleItineraryClick('${mapsUrl}')" class="text-blue-500 hover:underline text-[11px] font-bold"><i class="fas fa-directions mr-1"></i>Itin√©raire</a>
                                </p>
                                ${m.message ? `<p class="text-gray-400 text-xs mt-1 italic">"${m.message}"</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // UPDATE DELETE MATCH POUR REFRESH LE DASHBOARD
        function deleteMatch(id) {
            if (confirm('Es-tu s√ªr de vouloir supprimer ce match ?')) {
                savedMatches = savedMatches.filter(m => m.id !== id);
                localStorage.setItem('scMatches', JSON.stringify(savedMatches));
                renderMatchList();
                renderMyMatches(); // Refresh Dashboard
                showSuccess('Match supprim√© avec succ√®s ! üóëÔ∏è');
            }
        }

        function renderMatchList() {
            const container = document.getElementById('matchList');
            if (!container) return;

            const searchCategory = document.getElementById('searchCategory')?.value || '';
            const searchLevel = document.getElementById('searchLevel')?.value || '';
            const searchLocation = document.getElementById('searchLocation')?.value?.toLowerCase() || '';
            const searchMatchType = document.getElementById('searchMatchType')?.value?.toLowerCase() || '';
            const searchTerrainType = document.getElementById('searchTerrainType')?.value?.toLowerCase() || '';
            const searchDate = document.getElementById('searchDate')?.value || '';
            const searchRadius = parseInt(document.getElementById('searchRadius')?.value) || 0;
            const searchLat = parseFloat(document.getElementById('searchLocationLat')?.value) || null;
            const searchLng = parseFloat(document.getElementById('searchLocationLng')?.value) || null;

            // DEBUG: Afficher les filtres
            console.log('üîç FILTRES:', { searchCategory, searchLevel, searchLocation, searchRadius, searchLat, searchLng, searchMatchType, searchTerrainType, searchDate, showFavoritesOnly });
            console.log('üìã MATCHS:', savedMatches);

            let filtered = savedMatches.map(m => {
                let distance = null;
                if (searchLat !== null && searchLng !== null && m.locationLat && m.locationLng) {
                    distance = calculateDistance(searchLat, searchLng, m.locationLat, m.locationLng);
                }
                return { ...m, distance };
            }).filter(m => {
                // Filtre Favoris
                if (showFavoritesOnly && !userFavorites.includes(m.id)) return false;

                if (searchCategory && m.category !== searchCategory) return false;
                if (searchLevel && m.level !== searchLevel) return false;

                // Filtrage par distance ou texte
                if (searchLocation && searchRadius > 0 && searchLat && searchLng) {
                    if (m.distance !== null) {
                        if (m.distance > searchRadius) return false;
                    } else {
                        // Fallback texte si pas de coordonn√©es
                        const matchLoc = m.location.toLowerCase();
                        const searchLoc = searchLocation.toLowerCase();
                        const hasCommonWord = searchLoc.split(' ').some(word => word.length > 2 && matchLoc.includes(word))
                            || matchLoc.split(' ').some(word => word.length > 2 && searchLoc.includes(word));
                        if (!matchLoc.includes(searchLoc) && !searchLoc.includes(matchLoc) && !hasCommonWord) return false;
                    }
                } else if (searchLocation) {
                    const matchLoc = m.location.toLowerCase();
                    const searchLoc = searchLocation.toLowerCase();
                    const hasCommonWord = searchLoc.split(' ').some(word => word.length > 2 && matchLoc.includes(word))
                        || matchLoc.split(' ').some(word => word.length > 2 && searchLoc.includes(word));
                    if (!matchLoc.includes(searchLoc) && !searchLoc.includes(matchLoc) && !hasCommonWord) return false;
                }

                if (searchMatchType && m.matchType?.toLowerCase() !== searchMatchType.toLowerCase()) return false;
                if (searchTerrainType && m.terrainType?.toLowerCase() !== searchTerrainType.toLowerCase()) return false;
                if (searchDate && m.matchDate !== searchDate) return false;

                return true;
            });

            // Trier par distance (les plus proches en premier)
            filtered.sort((a, b) => {
                if (a.distance === null) return 1;
                if (b.distance === null) return -1;
                return a.distance - b.distance;
            });

            if (filtered.length === 0) {
                const emptyMessage = showFavoritesOnly ? "Tu n'as aucun favori pour le moment." : "Aucun match ne correspond √† ta recherche.";
                container.innerHTML = `
                    <div class="text-center py-16 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200">
                        <div class="text-6xl mb-4">${showFavoritesOnly ? 'üíî' : 'üîç'}</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">${emptyMessage}</h3>
                        <p class="text-gray-400">Modifie tes crit√®res ou cr√©e ton propre match !</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(m => {
                const date = new Date(m.matchDate);
                const day = date.getDate();
                const month = date.toLocaleDateString('fr-FR', { month: 'short' }).toUpperCase();
                const year = date.getFullYear();
                const isOwner = (m.ownerId === CURRENT_USER_ID);
                const isFavorite = userFavorites.includes(m.id);
                const timeDisplay = m.matchTime || '15:00';
                const terrainDisplay = m.terrainType || 'Non pr√©cis√©';

                // Calcul distance HTML unifi√© avec le Dashboard (High Contrast Orange)
                let distanceBadgeHtml = '';
                if (m.distance !== null) {
                    distanceBadgeHtml = `<span class="distance-badge bg-orange-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm" title="Distance √† vol d'oiseau (calcul itin√©raire en cours...)"><i class="fas fa-route mr-1"></i>${m.distance} km</span>`;
                }


                // Lien Itin√©raire (Google Maps)
                const mapsUrl = (m.locationLat && m.locationLng)
                    ? `https://www.google.com/maps/dir/?api=1&destination=${m.locationLat},${m.locationLng}`
                    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(m.stadiumAddress || m.location)}`;

                // Bouton Copie T√©l√©phone
                let displayPhone = m.phone || '';
                if (displayPhone.startsWith('+33')) {
                    // Format: +33 7 69 49 43 32
                    const prefix = '+33';
                    const rest = displayPhone.substring(3).trim();
                    if (rest.length === 9) {
                        displayPhone = `${prefix} ${rest[0]} ${rest.substring(1, 3)} ${rest.substring(3, 5)} ${rest.substring(5, 7)} ${rest.substring(7, 9)}`;
                    }
                }

                const phoneAction = m.phone ? `
                    <button onclick="copyPhoneNumber('${m.phone}', this)" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-xl font-bold text-sm transition flex items-center gap-2" title="Copier le num√©ro">
                        <i class="fas fa-phone-alt"></i> ${displayPhone}
                    </button>
                ` : '';

                const ownerBadge = isOwner
                    ? `<span class="bg-gradient-to-br from-blue-500 to-teal-400 text-white px-3 py-1.5 rounded-full text-[10px] font-black shadow-md border border-white/30 flex items-center gap-1 whitespace-nowrap"><i class="fas fa-user-circle"></i> MON ANNONCE</span>`
                    : '';

                const isAvailable = m.isAvailable !== false; // Default true
                const cardBg = isAvailable ? 'bg-emerald-100' : 'bg-red-100';
                const cardBorder = 'border-black border-2 shadow-sm';

                // Badge Disponibilit√© Dynamique avec bordure noire
                const badgeHtml = isAvailable
                    ? `<div class="absolute top-4 left-4 flex items-center gap-1 bg-green-100 text-green-700 px-2 py-1 rounded-full text-[10px] font-bold z-10 border border-black shadow-sm"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Disponible</div>`
                    : `<div class="absolute top-4 left-4 flex items-center gap-1 bg-red-100 text-red-700 px-2 py-1 rounded-full text-[10px] font-bold z-10 border border-black shadow-sm"><div class="w-2 h-2 bg-red-500 rounded-full"></div> Indisponible</div>`;

                return `
                    <div class="${cardBg} ${cardBorder} rounded-2xl p-6 hover:shadow-2xl transition flex flex-col md:flex-row gap-6 items-center relative ${!isAvailable ? 'grayscale-[30%]' : ''}" data-match-id="${m.id}">

                        <!-- Badges -->
                        ${badgeHtml}

                        <!-- Boutons Actions Top Right -->
                        <div class="absolute top-3 right-3 flex gap-2 items-center">
                            ${ownerBadge}
                            <button onclick="toggleFavorite(${m.id})" class="text-red-500 hover:scale-110 transition p-2 text-xl" title="${isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                                <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                            </button>
                        </div>

                        <div class="bg-gradient-to-br from-blue-500 to-teal-400 text-white p-4 rounded-2xl text-center min-w-[100px] shadow-md relative group mt-6 md:mt-0">
                            <div class="text-3xl font-black leading-none">${day}</div>
                            <div class="text-sm font-bold uppercase mb-1">${month}</div>
                            <div class="text-[10px] font-bold opacity-80 border-t border-white/30 pt-1">${year}</div>
                            <div class="text-lg font-bold mt-2 bg-white/20 rounded-lg py-1"><i class="fas fa-clock mr-1"></i>${timeDisplay}</div>
                        </div>
                        <div class="flex-grow w-full md:w-auto">
                            <h4 class="text-xl font-bold text-gray-800 mb-1">${m.clubName}</h4>
                            <div class="flex flex-wrap gap-2 mb-2">
                                <span class="bg-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm">${m.category}</span>
                                <span class="bg-rose-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm">${m.level}</span>
                                <span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm">${m.matchType}</span>
                                <span class="bg-emerald-700 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm"><i class="fas fa-grass mr-1"></i>${terrainDisplay}</span>
                                ${distanceBadgeHtml}
                            </div>
                            <p class="text-gray-500 text-sm flex items-center flex-wrap gap-2">
                                <i class="fas fa-map-marker-alt text-teal-500"></i> ${m.stadiumAddress || m.location}
                            </p>
                            ${m.message ? `<p class="text-gray-400 text-xs mt-1 italic">"${m.message}"</p>` : ''}

                            <!-- Actions Row -->
                            <div class="flex flex-wrap items-center gap-3 mt-4">
                                ${phoneAction}
                                <a href="javascript:void(0)" onclick="handleContactClick('${m.email}')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-xl font-bold transition text-sm flex items-center gap-2">
                                    <i class="fas fa-envelope"></i> Contacter
                                    </a>
                                <a href="javascript:void(0)" onclick="handleItineraryClick('${mapsUrl}')" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-6 py-2 rounded-xl font-bold transition text-sm flex items-center gap-2">
                                    <i class="fas fa-directions"></i> Itin√©raire
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Mise √† jour asynchrone pour la distance r√©elle par la route (OSRM)
            async function updateRealDistances() {
                const sLat = parseFloat(document.getElementById('searchLocationLat')?.value);
                const sLng = parseFloat(document.getElementById('searchLocationLng')?.value);
                if (!sLat || !sLng) return;

                // On r√©cup√®re les coord de destination pour tous les matchs visibles
                const matchesWithCoords = filtered.filter(m => m.locationLat && m.locationLng);

                for (let m of matchesWithCoords) {
                    try {
                        const url = `https://router.project-osrm.org/route/v1/driving/${sLng},${sLat};${m.locationLng},${m.locationLat}?overview=false`;
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.code === 'Ok' && data.routes[0]) {
                            const rdDist = Math.round(data.routes[0].distance / 100) / 10; // 1 d√©cimale pr√©cision route
                            const badge = document.querySelector(`[data-match-id="${m.id}"] .distance-badge`);
                            if (badge) {
                                badge.innerHTML = `<i class="fas fa-route mr-1"></i>${rdDist} km`;
                                badge.className = "distance-badge bg-orange-700 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm";
                                badge.title = "Distance r√©elle par la route";
                            }
                            m.realDistance = rdDist;
                        }
                    } catch (e) {
                        console.error('OSRM Error:', e);
                        // Ne pas masquer le badge, laisser la distance vol d'oiseau si √©chec itin√©raire
                        const badge = document.querySelector(`[data-match-id="${m.id}"] .distance-badge`);
                        if (badge) {
                            badge.innerHTML = `<i class="fas fa-route mr-1"></i>${m.distance} km`;
                            badge.className = "distance-badge bg-orange-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm";
                        }
                    }
                }

                // Optionnel: Re-trier la liste une fois que tout est charg√© pour √™tre parfait
                // filtered.sort((a,b) => (a.realDistance || 9999) - (b.realDistance || 9999));
                // renderMatchList(); // Trop agressif, on reste sur le tri vol d'oiseau initial qui est une bonne approximation
            }
            updateRealDistances();
        }

        // === SIRET LOOKUP (API GOUV) ===
        // Helper to format names nicely
        function formatClubName(name) {
            if (!name) return "";
            // Remove uppercase screaming, put in Title Case
            return name.toLowerCase().replace(/(?:^|\s|-)\S/g, function (l) {
                return l.toUpperCase();
            }).replace(/\bAs\b/g, "A.S.").replace(/\bFc\b/g, "F.C.");
        }

        // Helper Capitalisation Nom/Pr√©nom
        function formatInputName(input) {
            // Capitalize first letter of each word, handle hyphens
            input.value = input.value.toLowerCase().replace(/(?:^|\s|-)\S/g, function (a) {
                return a.toUpperCase();
            });
        }

        let siretLookupTimeout;

        function setupSiretLookup() {
            const SIRET_CONFIG = [
                // { inputId: 'createClubSiret', prefix: 'create' }, // REMOVED TO KILL ERROR
                { inputId: 'regSiret', prefix: 'reg' }
            ];

            SIRET_CONFIG.forEach(cfg => {
                const input = document.getElementById(cfg.inputId);
                // DISABLE SIRET LOOKUP FOR CREATE MATCH TO PREVENT ERRORS
                if (!input || cfg.prefix === 'create') return;

                input.addEventListener('input', function () {
                    const val = this.value.replace(/\D/g, ''); // Uniquement chiffres

                    if (val.length < 9) {
                        const info = document.getElementById(cfg.prefix + 'SiretInfo');
                        if (info) info.classList.add('hidden');
                        return;
                    }

                    // On attend un peu plus pour laisser l'utilisateur finir de taper
                    clearTimeout(siretLookupTimeout);
                    siretLookupTimeout = setTimeout(() => {
                        performSiretLookup(val, cfg.prefix);
                    }, 500);
                });
            });
        }

        async function performSiretLookup(siret, prefix) {
            // ULTIMATE SAFETY: If create mode, NEVER show error, NEVER call API if logic is weird
            if (prefix === 'create') {
                if (!siret || siret.length < 9) return;
            }

            const loader = document.getElementById(prefix + 'SiretLoader');
            const info = document.getElementById(prefix + 'SiretInfo');

            if (loader) loader.classList.remove('hidden');

            try {
                const res = await fetch(`/api/v2/siret-lookup?q=${siret}`);
                const data = await res.json();

                if (data.success) {
                    const c = data.club;
                    const formattedName = formatClubName(c.name);

                    const mainInput = document.getElementById(prefix === 'create' ? 'createClubSiret' : 'regSiret');
                    // ON NE REMPLACE PLUS la valeur par le nom pour √©viter de trigger l'event input
                    // qui viderait la carte instantan√©ment.

                    // Fill UI Info Card
                    const nameEl = document.getElementById(prefix + 'SiretName');
                    const addrEl = document.getElementById(prefix + (prefix === 'reg' ? 'SiretLocation' : 'SiretAddr'));
                    const logoEl = document.getElementById(prefix + 'SiretLogo');

                    if (nameEl) nameEl.innerText = formattedName;
                    if (addrEl) addrEl.innerHTML = `<span class="block font-medium">${c.address}</span>`;

                    if (logoEl) {
                        logoEl.src = c.logo;
                        logoEl.onerror = () => {
                            if (logoEl.src !== '/static/realistic_ball.jpg') {
                                logoEl.src = '/static/realistic_ball.jpg';
                            }
                        };
                    }

                    if (info) {
                        info.classList.remove('hidden');
                        info.classList.add('animate-bounce-short');
                        setTimeout(() => info.classList.remove('animate-bounce-short'), 500);
                    }

                    // Fill Hidden Fields
                    const clubField = document.getElementById(prefix === 'reg' ? 'regClubHidden' : prefix + 'Club');
                    const locField = document.getElementById(prefix + 'Location');
                    const clubIdField = document.getElementById(prefix + 'ClubId');
                    const createNameField = document.getElementById('createClubName');

                    if (clubField) clubField.value = c.name;
                    if (createNameField) createNameField.value = c.name;
                    if (locField) locField.value = c.city;
                    if (clubIdField) clubIdField.value = c.siret;
                    if (prefix === 'create') {
                        const logoField = document.getElementById('createClubLogo');
                        if (logoField) logoField.value = c.logo;
                    }

                    // REMPLISSAGE VISIBLE (CRITIQUE POUR UX)
                    const cityVisible = document.getElementById('regCityVisible');
                    if (cityVisible && prefix === 'reg') cityVisible.value = c.city;

                    const stadiumField = document.getElementById(prefix === 'create' ? 'createStadiumAddress' : 'regStadiumAddress');
                    if (stadiumField) stadiumField.value = c.address;

                    // GPS COORDS POPULATION
                    if (c.latitude) {
                        const latField = document.getElementById(prefix === 'create' ? 'createLocationLat' : 'regLat');
                        if (latField) latField.value = c.latitude;
                    }
                    if (c.longitude) {
                        const lngField = document.getElementById(prefix === 'create' ? 'createLocationLng' : 'regLng');
                        if (lngField) lngField.value = c.longitude;
                    }

                } else {
                    const isCreateMode = (prefix === 'create');
                    if (data.error && !isCreateMode) {
                        showError(data.error);
                    }
                    if (info) info.classList.add('hidden');
                }
            } catch (err) {
                console.error("SIRET Lookup Error:", err);
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }


        function setupAutocomplete(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;

            // Cr√©er le conteneur de liste si pas d√©j√† l√†
            let list = input.parentNode.querySelector('.autocomplete-list');
            if (!list) {
                list = document.createElement('div');
                list.className = 'autocomplete-list absolute z-50 bg-white border border-gray-200 rounded-xl shadow-lg mt-1 w-full max-h-60 overflow-y-auto hidden';
                input.parentNode.style.position = 'relative';
                input.parentNode.appendChild(list);
            }

            let debounceTimer;

            input.addEventListener('input', function () {
                const query = this.value;

                // Clear hidden fields on manual input
                const suffix = ['Lat', 'Lng', 'CityCode', 'PostCode'];
                suffix.forEach(s => {
                    const el = document.getElementById(inputId + s);
                    if (el) el.value = '';
                });

                if (query.length < 3) {
                    list.classList.add('hidden');
                    return;
                }

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    try {
                        const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&autocomplete=1`);
                        const data = await response.json();

                        list.innerHTML = '';
                        if (data.features && data.features.length > 0) {
                            list.classList.remove('hidden');
                            data.features.forEach(feature => {
                                const city = feature.properties.label; // ou city + postcode
                                const cityOnly = feature.properties.city;
                                const postcode = feature.properties.postcode;
                                const context = feature.properties.context;
                                const coords = feature.geometry.coordinates;

                                const item = document.createElement('div');
                                item.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-50 last:border-0 text-sm font-semibold text-gray-700';
                                item.innerHTML = `<i class="fas fa-map-pin mr-2 text-red-400"></i>${city}`;

                                item.onmousedown = function (e) {
                                    e.preventDefault(); // Important pour ne pas trigger le blur avant le click
                                    input.value = city;

                                    const latField = document.getElementById(inputId + 'Lat');
                                    const lngField = document.getElementById(inputId + 'Lng');
                                    const cityCodeField = document.getElementById(inputId + 'CityCode');
                                    const postCodeField = document.getElementById(inputId + 'PostCode');

                                    if (latField) latField.value = coords[1];
                                    if (lngField) lngField.value = coords[0];
                                    if (cityCodeField) cityCodeField.value = feature.properties.citycode;
                                    if (postCodeField) postCodeField.value = postcode;

                                    if (inputId === 'createLocation' || inputId === 'regLocation') {
                                        // Auto-focus sur le champ club et trigger la recherche locale
                                        const clubInputId = inputId === 'createLocation' ? 'createClubName' : 'regClub';
                                        const clubInput = document.getElementById(clubInputId);
                                        if (clubInput) {
                                            clubInput.placeholder = "Recherche clubs √† " + cityOnly + "...";
                                            // Optional: trigger club search immediately
                                            clubInput.focus();
                                        }
                                    }

                                    if (inputId === 'searchLocation') {
                                        renderMatchList();
                                        renderMyMatches();
                                    }

                                    list.classList.add('hidden');
                                };
                                list.appendChild(item);
                            });
                        } else {
                            list.classList.add('hidden');
                        }
                    } catch (e) { console.error('Erreur API Adresse', e); }
                }, 300);
            });

            input.addEventListener('blur', () => { // Close on blur
                setTimeout(() => list.classList.add('hidden'), 200);
            });

            document.addEventListener('click', (e) => { // Close on outside click
                if (e.target !== input && !list.contains(e.target)) {
                    list.classList.add('hidden');
                }
            });
        }

        // === CALCUL DE DISTANCE (FORMULE HAVERSINE) ===
        function calculateDistance(lat1, lng1, lat2, lng2) {
            if (!lat1 || !lng1 || !lat2 || !lng2) return null;

            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return Math.round(d * 10) / 10; // Distance en km avec 1 d√©cimale
        }




        // === GESTION DES FAVORIS ET ACTIONS ===

        function toggleFavoritesFilter() {
            showFavoritesOnly = !showFavoritesOnly;
            const btn = document.getElementById('btnFavoritesFilter');

            if (showFavoritesOnly) {
                btn.classList.remove('bg-white', 'text-gray-400', 'border-gray-200');
                btn.classList.add('bg-red-50', 'text-red-500', 'border-red-200');
                btn.innerHTML = `<i class="fas fa-heart"></i> Afficher tout`;
            } else {
                btn.classList.add('bg-white', 'text-gray-400', 'border-gray-200');
                btn.classList.remove('bg-red-50', 'text-red-500', 'border-red-200');
                btn.innerHTML = `<i class="fas fa-heart"></i> Mes Favoris`;
            }
            renderMatchList();
        }

        function toggleFavorite(id) {
            if (!currentUser) {
                showSuccess("üîí Connecte-toi pour ajouter des favoris !");
                openLoginModal();
                return;
            }
            const index = userFavorites.indexOf(id);
            if (index === -1) {
                userFavorites.push(id);
                showSuccess('Ajout√© aux favoris ! ‚ù§Ô∏è');
            } else {
                userFavorites.splice(index, 1);
            }
            localStorage.setItem('scFavorites', JSON.stringify(userFavorites));
            renderMatchList();
        }

        function handleContactClick(email) {
            if (!currentUser) {
                showSuccess("üîí Connecte-toi pour contacter ce club !");
                openLoginModal();
                return;
            }
            window.location.href = `mailto:${email}`;
        }

        function handleItineraryClick(url) {
            if (!currentUser) {
                showSuccess("üîí Connecte-toi pour voir l'itin√©raire !");
                openLoginModal();
                return;
            }
            window.open(url, '_blank');
        }

        function copyPhoneNumber(phone, btn) {
            if (!currentUser) {
                showSuccess("üîí Connecte-toi pour copier le num√©ro !");
                openLoginModal();
                return;
            }
            // Nettoyer le num√©ro pour la copie (enlever +33 pour le format standard 06... ou garder +33 selon pref, on va garder tel quel)
            navigator.clipboard.writeText(phone).then(() => {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-check"></i> Copi√© !`;
                btn.classList.remove('bg-gray-100', 'text-gray-600');
                btn.classList.add('bg-green-100', 'text-green-600');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                    btn.classList.remove('bg-green-100', 'text-green-600');
                }, 2000);
            }).catch(err => {
                console.error('Erreur copie', err);
                showError('Impossible de copier le num√©ro');
            });
        }
        function toggleAvailability(id) {
            const matchIndex = savedMatches.findIndex(m => m.id === id);
            if (matchIndex === -1) return;

            // Toggle
            const currentState = savedMatches[matchIndex].isAvailable !== false; // Default true
            savedMatches[matchIndex].isAvailable = !currentState;

            localStorage.setItem('scMatches', JSON.stringify(savedMatches));
            renderMatchList();
            renderMyMatches(); // Refresh Dashboard immediately!

            const newState = savedMatches[matchIndex].isAvailable;
            if (newState) {
                showSuccess('Match marqu√© disponible ‚úÖ');
            } else {
                showSuccess('Match marqu√© indisponible ‚ùå');
            }
        }

        function cleanExpiredMatches() {
            const today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD

            const initialCount = savedMatches.length;
            savedMatches = savedMatches.filter(m => {
                // Garder si la date est >= aujourd'hui
                return m.matchDate >= today;
            });

            if (savedMatches.length !== initialCount) {
                console.log(`üßπ Nettoyage: ${initialCount - savedMatches.length} matchs expir√©s supprim√©s.`);
                localStorage.setItem('scMatches', JSON.stringify(savedMatches)); // FIX: Use scMatches key
            }
        }

        // Nettoyage au chargement (moved to DOMContentLoaded)
        // cleanExpiredMatches();
        // renderMyMatches();
        // setupSiretLookup();
        // setupAutocomplete('searchLocation'); 
    </script>
    <!-- NOTIFICATIONS (Z-INDEX 3000 to be above everything) -->
    <div id="alertContainer" class="fixed top-4 right-4 z-[3000] w-96 space-y-2 pointer-events-none"></div>

    <!-- ============================================== -->
    <!-- REGISTER MODAL (Tailwind) -->
    <!-- Fix: overflow-y-auto + Flex centering instead of Absolute -->
    <div id="registerModal" class="fixed inset-0 z-[2000] hidden overflow-y-auto">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeRegisterModal()"></div>

        <!-- Container for centering (permits scroll) -->
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden animate-fade-in relative w-full max-w-md my-8">
                <!-- Header -->
                <div class="bg-primary p-6 text-center relative">
                    <button onclick="closeRegisterModal()"
                        class="absolute top-4 right-4 text-white/70 hover:text-white transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <div
                        class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-md">
                        <i class="fas fa-user-plus text-2xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-black text-white uppercase tracking-tight">Rejoins l'√âlite</h3>
                    <p class="text-white/80 text-sm mt-1">Cr√©e ton profil coach en 30 secondes</p>
                </div>

                <!-- Body -->
                <div class="p-8">
                    <!-- AVERTISSEMENT S√âCURIT√â -->
                    <div class="bg-amber-50 border-l-4 border-amber-400 p-3 mb-4 rounded-r-xl flex gap-3 shadow-sm">
                        <i class="fas fa-shield-alt text-amber-500 mt-0.5"></i>
                        <div class="text-[10px] text-amber-800 leading-tight">
                            <span class="font-black uppercase tracking-widest block mb-0.5">Donn√©es S√©curis√©es</span>
                            <strong>D√âFINITIF (Preuve requise) :</strong> Club, Ville, Adresse, Licence.<br>
                            <strong>MODIFIABLE :</strong> Email, T√©l√©phone, Cat√©gorie & Niveau.
                        </div>
                    </div>

                    <form onsubmit="handleRegister(event)" class="space-y-4">
                        <!-- 1. IDENTIT√â (Pr√©nom / Nom) -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-black text-black uppercase tracking-widest">Pr√©nom</label>
                                <input type="text" id="regFirstName" required oninput="formatInputName(this)"
                                    class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-primary focus:ring-0 transition font-semibold text-sm"
                                    placeholder="Martin">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-black uppercase tracking-widest">Nom</label>
                                <input type="text" id="regLastName" required oninput="formatInputName(this)"
                                    class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-primary focus:ring-0 transition font-semibold text-sm"
                                    placeholder="Dupont">
                            </div>
                        </div>

                        <!-- 2. CLUB ET ADRESSE -->
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-black uppercase tracking-widest">SIRET
                                Club</label>
                            <div class="flex gap-2">
                                <input type="text" id="regSiret" required
                                    class="flex-grow px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-primary focus:ring-0 transition font-semibold text-sm"
                                    placeholder="N¬∞ SIRET ou SIREN (ex: 776395...)" maxlength="30">
                                <button type="button"
                                    onclick="performSiretLookup(document.getElementById('regSiret').value.replace(/\D/g, ''), 'reg')"
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold px-4 rounded-xl text-xs transition border-2 border-gray-100 whitespace-nowrap">
                                    V√©rifier
                                </button>
                                <div id="regSiretLoader"
                                    class="absolute right-[110px] top-1/2 -translate-y-1/2 z-10 hidden">
                                    <i class="fas fa-spinner fa-spin text-primary"></i>
                                </div>
                            </div>
                            <p class="text-[9px] text-gray-400 italic mt-0.5">
                                <i class="fas fa-info-circle mr-1"></i>Astuce : Tapez <strong>"SIRET + Nom pr√©cis du
                                    club"</strong> sur Internet.
                            </p>
                        </div>

                        <!-- Info Club (Auto-filled) - MOVED HERE -->
                        <div id="regSiretInfo"
                            class="hidden p-3 bg-gray-50 rounded-xl border border-gray-100 flex items-center gap-3">
                            <img id="regSiretLogo" src=""
                                class="w-10 h-10 object-contain bg-white rounded shadow-sm p-1">
                            <div class="flex-grow">
                                <div id="regSiretName" class="font-bold text-gray-800 text-xs"></div>
                                <div id="regSiretLocation" class="text-[9px] text-gray-500"></div>
                            </div>
                        </div>

                        <!-- Ville (Visible & Auto-filled) -->
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-black uppercase tracking-widest">Ville</label>
                            <input type="text" id="regCityVisible"
                                class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-primary focus:ring-0 transition font-semibold text-sm bg-gray-50 text-gray-500"
                                placeholder="Ville du club..." readonly tabindex="-1">
                        </div>


                        <!-- Hidden Fields for Club Info -->
                        <input type="hidden" id="regClubHidden">
                        <input type="hidden" id="regLocation">
                        <input type="hidden" id="regClubId">
                        <input type="hidden" id="regLat">
                        <input type="hidden" id="regLng">

                        <!-- Adresse Stade (Auto-filled) -->
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-black uppercase tracking-widest">Adresse du
                                Stade</label>
                            <input type="text" id="regStadiumAddress"
                                class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-accent focus:ring-0 transition font-semibold text-sm bg-gray-50 text-gray-500"
                                placeholder="Stade L√©o Lagrange..." readonly tabindex="-1">
                        </div>

                        <!-- 3. CONTACT -->
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-black uppercase tracking-widest">Email</label>
                            <input type="email" id="regEmail" required onblur="validateEmailField(this)"
                                class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-accent focus:ring-0 transition font-semibold text-sm"
                                placeholder="coach@equipe.fr">
                            <p id="regEmailError" class="hidden text-[9px] text-red-500 font-bold mt-1 pl-1">
                                <i class="fas fa-exclamation-circle mr-1"></i>Format email invalide
                            </p>
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-black uppercase tracking-widest">T√©l√©phone</label>
                            <input type="tel" id="regPhone" required maxlength="14" oninput="formatPhoneNumber(this)"
                                class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-accent focus:ring-0 transition font-semibold text-sm"
                                placeholder="06 00 00 00 00">
                            <!-- Helper / Error -->
                            <p id="regPhoneError" class="hidden text-[9px] text-red-500 font-bold mt-1 pl-1">
                                <i class="fas fa-exclamation-circle mr-1"></i>Num√©ro invalide (10 chiffres recommand√©s)
                            </p>
                        </div>

                        <!-- 4. S√âCURIT√â -->
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-black uppercase tracking-widest">Mot de
                                Passe</label>
                            <div class="relative">
                                <input type="password" id="regPass" required oninput="checkPasswordStrength(this.value)"
                                    class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-primary focus:ring-0 transition font-semibold text-sm"
                                    placeholder="8 caract√®res min...">
                                <button type="button"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary transition"
                                    onclick="togglePasswordVisibility('regPass', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <!-- Strength Bar (Keep existing logic) -->
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden mt-1 opacity-0 transition-opacity duration-300 shadow-inner"
                                id="passwordStrengthBarContainer">
                                <div id="passwordStrengthBar" class="h-full w-0 transition-all duration-500"></div>
                            </div>
                            <p id="passwordStrengthText"
                                class="text-[8px] font-black uppercase tracking-tighter mt-0.5"></p>
                        </div>

                        <!-- 5. PROFIL FOOTBALL -->
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-black uppercase tracking-widest">N¬∞
                                Licence</label>
                            <input type="text" id="regLicenseId" required maxlength="10" inputmode="numeric"
                                oninput="this.value = this.value.replace(/\D/g, '').slice(0, 10)"
                                class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-accent focus:ring-0 transition font-semibold text-sm font-mono tracking-widest text-center"
                                placeholder="0000000000">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-black text-black uppercase tracking-widest">Cat√©gorie</label>
                                <div class="relative">
                                    <select id="regCategory" required
                                        class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-accent focus:ring-0 transition font-semibold text-sm appearance-none bg-white">
                                        <option value="" disabled selected>Choisir...</option>
                                        <option value="U6">U6</option>
                                        <option value="U7">U7</option>
                                        <option value="U8">U8</option>
                                        <option value="U9">U9</option>
                                        <option value="U10">U10</option>
                                        <option value="U11">U11</option>
                                        <option value="U12">U12</option>
                                        <option value="U13">U13</option>
                                        <option value="U14">U14</option>
                                        <option value="U15">U15</option>
                                        <option value="U16">U16</option>
                                        <option value="U17">U17</option>
                                        <option value="U18">U18</option>
                                        <option value="U19">U19</option>
                                        <option value="U20">U20</option>
                                        <option value="Seniors">Seniors</option>
                                        <option value="V√©t√©rans">V√©t√©rans</option>
                                    </select>
                                    <i
                                        class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label
                                    class="text-[10px] font-black text-black uppercase tracking-widest">Niveau</label>
                                <div class="relative">
                                    <select id="regLevel" required
                                        class="w-full px-3 py-2.5 border-2 border-gray-100 rounded-xl focus:border-accent focus:ring-0 transition font-semibold text-sm appearance-none bg-white">
                                        <option value="" disabled selected>Choisir...</option>
                                        <optgroup label="Ligue">
                                            <option value="Ligue 1">Ligue 1</option>
                                            <option value="Ligue 2">Ligue 2</option>
                                            <option value="National">National</option>
                                            <option value="National 2">National 2</option>
                                            <option value="National 3">National 3</option>
                                        </optgroup>
                                        <optgroup label="R√©gional">
                                            <option value="R1">R√©gional 1 (R1)</option>
                                            <option value="R2">R√©gional 2 (R2)</option>
                                            <option value="R3">R√©gional 3 (R3)</option>
                                        </optgroup>
                                        <optgroup label="D√©partemental">
                                            <option value="D1">D√©partemental 1 (D1)</option>
                                            <option value="D2">D√©partemental 2 (D2)</option>
                                            <option value="D3">D√©partemental 3 (D3)</option>
                                            <option value="D4">D√©partemental 4 (D4)</option>
                                            <option value="D5">D√©partemental 5 (D5)</option>
                                        </optgroup>
                                        <option value="Loisir">Loisir / Entreprise</option>
                                    </select>
                                    <i
                                        class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Terms -->
                        <div class="form-check pt-1">
                            <input class="form-check-input" type="checkbox" id="regTerms" required checked>
                            <label class="form-check-label text-[9px] text-gray-400 font-bold" for="regTerms">
                                J'ACCEPTE LES CGU
                            </label>
                        </div>

                        <!-- Submit -->
                        <button type="submit"
                            class="w-full bg-accent text-white py-3 rounded-2xl font-black text-sm hover:shadow-lg transition-all mt-2">
                            CR√âER MON COMPTE
                        </button>
                    </form>

                    <p class="text-center mt-6 text-sm text-gray-500">D√©j√† un compte ? <a href="#"
                            onclick="openLoginModal()" class="text-primary font-bold hover:underline">Connexion</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-2xl rounded-3xl overflow-hidden">
                <div class="modal-header border-0 bg-white p-6 pb-2">
                    <h5 class="modal-title font-black text-gray-800 uppercase tracking-tight flex items-center gap-2">
                        <i class="fas fa-sign-in-alt text-primary"></i> Connexion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-8 pt-2">
                    <p class="text-gray-500 text-sm mb-6">Heureux de vous revoir sur SmartCoach Pro.</p>

                    <form onsubmit="handleLogin(event)" class="space-y-4">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-black uppercase tracking-widest">Email</label>
                            <input type="email" id="loginEmail" required
                                class="w-full px-4 py-3 border-2 border-gray-100 rounded-xl focus:border-primary focus:ring-0 transition font-semibold"
                                placeholder="coach@equipe.fr">
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] font-black text-black uppercase tracking-widest">Mot de
                                    Passe</label>
                                <a href="#" class="text-xs text-primary font-bold hover:underline">Oubli√© ?</a>
                            </div>
                            <input type="password" id="loginPass" required
                                class="w-full px-4 py-3 border-2 border-gray-100 rounded-xl focus:border-primary focus:ring-0 transition font-semibold"
                                placeholder="*******">
                        </div>

                        <button type="submit"
                            class="w-full bg-primary text-white py-4 rounded-xl font-black text-lg hover:shadow-xl transition-all shadow-lg shadow-blue-500/20">
                            SE CONNECTER
                        </button>
                    </form>

                    <p class="text-center mt-6 text-sm text-gray-500">Pas encore de compte ? <a href="#"
                            onclick="openRegisterModal()" class="text-primary font-bold hover:underline">S'inscrire</a>
                    </p>
                    <div class="mt-8 text-center opacity-30 hover:opacity-100 transition">
                        <button onclick="resetLocalDatabase()"
                            class="text-[10px] uppercase font-bold text-gray-400 hover:text-red-500 hover:underline">
                            R√©initialiser l'application (Dev Tool)
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>



    <!-- PROFILE MODAL -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-2xl rounded-3xl overflow-hidden">
                <div class="modal-header border-0 bg-white p-6 pb-2">
                    <h5 class="modal-title font-black text-gray-800 uppercase tracking-tight flex items-center gap-2">
                        <i class="fas fa-id-card text-primary"></i> Fiche Coach
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-6 pt-2 space-y-4">
                    <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl">
                        <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-2xl font-bold text-primary"
                            id="profileInitials">
                            --
                        </div>
                        <div>
                            <h3 class="font-black text-lg text-gray-800" id="profileName">--</h3>
                            <p class="text-sm text-gray-400 font-semibold" id="profileEmail">--</p>
                            <span
                                class="inline-flex items-center gap-1 bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-widest mt-1">
                                <i class="fas fa-check-circle"></i> V√©rifi√©
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Club</p>
                            <p class="font-bold text-gray-800 text-sm truncate" id="profileClub">--</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Ville</p>
                            <p class="font-bold text-gray-800 text-sm truncate" id="profileCity">--</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">N¬∞ Licence
                            </p>
                            <p class="font-mono font-bold text-primary text-sm tracking-wider" id="profileLicence">--
                            </p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">T√©l√©phone
                            </p>
                            <p class="font-bold text-gray-800 text-sm" id="profilePhone">--
                            </p>
                        </div>
                        <!-- New Fields -->
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Cat√©gorie
                            </p>
                            <p class="font-bold text-gray-800 text-sm" id="profileCategory">--</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Niveau
                            </p>
                            <p class="font-bold text-gray-800 text-sm" id="profileLevel">--</p>
                        </div>
                        <!-- Full Stadium Address Field -->
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 col-span-2">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Stade
                                (D√©finitif)</p>
                            <p class="font-bold text-gray-800 text-xs leading-relaxed" id="profileAddress">--</p>
                        </div>
                    </div>

                    <!-- Support Technique (Mis en avant) -->
                    <div
                        class="bg-blue-50 p-6 rounded-[20px] border-2 border-blue-100 shadow-sm relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-20 h-20 bg-blue-100/50 rounded-full blur-xl"></div>
                        <p class="text-xs text-blue-900 leading-normal relative z-10">
                            <span
                                class="font-black uppercase tracking-[0.15em] block mb-3 text-blue-600 flex items-center gap-2 text-sm">
                                <i class="fas fa-headset text-lg"></i> SUPPORT TECHNIQUE
                            </span>
                            <span class="font-semibold block mb-2 text-[13px]">Pour toute modification de vos
                                <strong>donn√©es d√©finitives</strong> (Club, Licence, Ville, Adresse), veuillez contacter
                                notre √©quipe d√©di√©e :</span>

                            <a href="mailto:support@smartcoach.fr"
                                class="inline-block px-4 py-2 bg-white text-blue-600 font-black rounded-lg shadow-sm border border-blue-100 hover:shadow-md transition text-sm mb-3">
                                <i class="fas fa-envelope mr-2"></i>support@smartcoach.fr
                            </a>

                            <span
                                class="block px-3 py-2 bg-blue-100/50 rounded-lg text-[11px] font-bold text-blue-700 border border-blue-200/50">
                                <i class="fas fa-info-circle mr-1"></i> ATTENTION : Un justificatif officiel (preuve de
                                changement) sera syst√©matiquement exig√© pour valider votre demande.
                            </span>
                        </p>
                    </div>

                    <button onclick="handleLogout()"
                        class="w-full py-3 bg-red-50 text-red-500 rounded-xl font-bold hover:bg-red-100 transition flex items-center justify-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> D√©connexion
                    </button>

                    <!-- ZONE DE DANGER / DEV TOOL -->
                    <div class="pt-4 border-t border-gray-100 mt-4">
                        <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest text-center mb-2">Zone
                            de Danger</p>
                        <button onclick="resetLocalDatabase()"
                            class="w-full py-2 border-2 border-dashed border-red-200 text-red-400 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-50 hover:border-red-500 hover:text-red-600 transition flex items-center justify-center gap-2">
                            <i class="fas fa-trash-alt"></i> R√©initialiser l'application
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CALENDAR MODAL -->
    <div class="modal fade" id="calendarModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-2xl rounded-3xl overflow-hidden">
                <div class="modal-header border-0 bg-white p-6 pb-2">
                    <h5 class="modal-title font-black text-gray-800 uppercase tracking-tight flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-blue-500"></i> Calendrier des matchs
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-6 pt-2">
                    <!-- Navigation mois -->
                    <div class="flex items-center justify-between mb-6 bg-gray-50 p-3 rounded-2xl">
                        <button onclick="changeCalendarMonth(-1)"
                            class="w-10 h-10 flex items-center justify-center rounded-xl bg-white shadow-sm hover:bg-gray-100 transition">
                            <i class="fas fa-chevron-left text-gray-400"></i>
                        </button>
                        <h4 id="calendarMonthTitle" class="text-lg font-black text-gray-700 uppercase tracking-widest">
                            Janvier 2026</h4>
                        <button onclick="changeCalendarMonth(1)"
                            class="w-10 h-10 flex items-center justify-center rounded-xl bg-white shadow-sm hover:bg-gray-100 transition">
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                    </div>

                    <!-- Grille Calendrier -->
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        <!-- Jours de la semaine -->
                        <div class="text-center text-[10px] font-black text-gray-400 uppercase tracking-wider py-2">Lun
                        </div>
                        <div class="text-center text-[10px] font-black text-gray-400 uppercase tracking-wider py-2">Mar
                        </div>
                        <div class="text-center text-[10px] font-black text-gray-400 uppercase tracking-wider py-2">Mer
                        </div>
                        <div class="text-center text-[10px] font-black text-gray-400 uppercase tracking-wider py-2">Jeu
                        </div>
                        <div class="text-center text-[10px] font-black text-gray-400 uppercase tracking-wider py-2">Ven
                        </div>
                        <div class="text-center text-[10px] font-black text-gray-400 uppercase tracking-wider py-2">Sam
                        </div>
                        <div class="text-center text-[10px] font-black text-gray-400 uppercase tracking-wider py-2">Dim
                        </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                        <!-- Les jours seront inject√©s ici -->
                    </div>

                    <!-- Zone d√©tails du jour -->
                    <div id="dayDetailsArea" class="mt-8 hidden animate-fade-in">
                        <h6 id="selectedDayTitle"
                            class="text-sm font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i class="fas fa-clock text-blue-500"></i> Matchs du 30 Janvier
                        </h6>
                        <div id="dayMatchesList" class="space-y-3 max-h-[300px] overflow-y-auto pr-2 scrollbar-thin">
                            <!-- Les matchs du jour seront inject√©s ici -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAILS MODAL (G√©n√©rique pour l'historique) -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-2xl rounded-3xl overflow-hidden">
                <div class="modal-header border-0 bg-gray-50 p-6">
                    <h5 class="modal-title font-black text-gray-800 uppercase tracking-tight" id="detailsModalTitle">
                        D√©tails</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-6" id="detailsModalBody">
                    <!-- Contenu inject√© dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS CONSOLIDATED ABOVE -->
</body>

</html>